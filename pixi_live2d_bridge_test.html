<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PIXI + Live2D Bridge Test</title>
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
        #canvas { width: 800px; height: 600px; border: 3px solid #0066cc; background-color: white; }
        .controls { margin-top: 20px; }
        .controls button { 
            margin: 0 8px 8px 0; 
            padding: 8px 16px; 
            font-size: 14px; 
            cursor: pointer; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef); 
        }
        .controls button:hover { background: linear-gradient(to bottom, #e9ecef, #dee2e6); }
        .debug-btn-bar button { 
            margin: 0 4px 4px 0; 
            padding: 6px 12px; 
            font-size: 12px; 
            cursor: pointer; 
            border: 1px solid #ccc; 
            border-radius: 3px; 
            background: #f8f9fa; 
        }
        .debug-btn-bar button:hover { background: #e9ecef; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>PIXI + Live2D Bridge Test (like sekai.best)</h1>
    <div id="canvas"></div>
    <div class="controls">
        <button onclick="testModelLoading()">üé≠ Test PIXI.live2d Model</button>
        <button onclick="testModuleLoading()">üîç Library Diagnostic</button>
        <button onclick="clearLog()">üßπ Clear Log</button>
        <button onclick="copyLogToClipboard()">üìã Copy Log</button>
    </div>
    <div class="log" id="log"></div>

    <!-- Add import map for PIXI modules -->
    <script type="importmap">
    {
        "imports": {
            "@pixi/core": "data:text/javascript,export * from '/node_modules/pixi.js/dist/pixi.min.js';",
            "@pixi/display": "data:text/javascript,export * from '/node_modules/pixi.js/dist/pixi.min.js';",
            "@pixi/mesh": "data:text/javascript,export * from '/node_modules/pixi.js/dist/pixi.min.js';",
            "@pixi/graphics": "data:text/javascript,export * from '/node_modules/pixi.js/dist/pixi.min.js';",
            "@pixi/sprite": "data:text/javascript,export * from '/node_modules/pixi.js/dist/pixi.min.js';",
            "@pixi/ticker": "data:text/javascript,export * from '/node_modules/pixi.js/dist/pixi.min.js';",
            "@pixi/utils": "data:text/javascript,export * from '/node_modules/pixi.js/dist/pixi.min.js';",
            "@pixi/assets": "data:text/javascript,export * from '/node_modules/pixi.js/dist/pixi.min.js';",
            "events": "data:text/javascript,export default window.EventEmitter;"
        }
    }
    </script>

    <!-- EventEmitter polyfill - Must be global before any libraries -->
    <script>
        (function() {
            'use strict';
            
            class EventEmitter {
                constructor() { this.events = {}; }
                on(event, listener) {
                    if (!this.events[event]) this.events[event] = [];
                    this.events[event].push(listener);
                    return this;
                }
                emit(event, ...args) {
                    if (this.events[event]) {
                        this.events[event].forEach(listener => listener(...args));
                    }
                    return this;
                }
                off(event, listener) {
                    if (this.events[event]) {
                        this.events[event] = this.events[event].filter(l => l !== listener);
                    }
                    return this;
                }
                removeListener(event, listener) {
                    return this.off(event, listener);
                }
                removeAllListeners(event) {
                    if (event) {
                        delete this.events[event];
                    } else {
                        this.events = {};
                    }
                    return this;
                }
                once(event, listener) {
                    const onceListener = (...args) => {
                        this.off(event, onceListener);
                        listener(...args);
                    };
                    this.on(event, onceListener);
                    return this;
                }
                listeners(event) {
                    return this.events[event] || [];
                }
                listenerCount(event) {
                    return this.listeners(event).length;
                }
            }
            
            // Make EventEmitter available globally
            window.EventEmitter = EventEmitter;
            
            // Create a more complete module system simulation
            if (typeof global === 'undefined') {
                window.global = window;
            }
            
            // Set up process object for Node.js compatibility
            if (typeof process === 'undefined') {
                window.process = {
                    env: {},
                    platform: 'browser',
                    versions: { node: '14.0.0' },
                    nextTick: (fn) => setTimeout(fn, 0)
                };
            }
            
            // Set up require function simulation
            if (typeof require === 'undefined') {
                window.require = function(module) {
                    console.log('Mock require called for:', module);
                    
                    // Handle events module
                    if (module === 'events') {
                        console.log('Returning events module with EventEmitter property');
                        return {
                            EventEmitter: EventEmitter
                        };
                    }
                    
                    // Handle PIXI modules - the library expects specific module exports
                    if (module === '@pixi/core') {
                        console.log('Returning PIXI core modules');
                        return typeof PIXI !== 'undefined' ? {
                            Application: PIXI.Application,
                            Container: PIXI.Container,
                            DisplayObject: PIXI.DisplayObject,
                            Renderer: PIXI.Renderer,
                            Texture: PIXI.Texture,
                            BaseTexture: PIXI.BaseTexture,
                            Sprite: PIXI.Sprite,
                            Graphics: PIXI.Graphics,
                            utils: PIXI.utils,
                            settings: PIXI.settings,
                            Rectangle: PIXI.Rectangle,
                            Point: PIXI.Point,
                            Matrix: PIXI.Matrix,
                            Transform: PIXI.Transform,
                            EventEmitter: PIXI.EventEmitter || EventEmitter,
                            // Add all PIXI properties as fallback
                            ...PIXI
                        } : {};
                    }
                    
                    if (module === '@pixi/display') {
                        console.log('Returning PIXI display modules');
                        return typeof PIXI !== 'undefined' ? {
                            Container: PIXI.Container,
                            DisplayObject: PIXI.DisplayObject,
                            Sprite: PIXI.Sprite,
                            Graphics: PIXI.Graphics,
                            // Add all PIXI properties as fallback
                            ...PIXI
                        } : {};
                    }
                    
                    // Handle other PIXI modules
                    if (module.startsWith('@pixi/')) {
                        console.log('Returning PIXI for', module);
                        return typeof PIXI !== 'undefined' ? PIXI : {};
                    }
                    
                    console.log('Returning empty object for unknown module:', module);
                    return {};
                };
            }
            
            // Enhanced module system
            if (typeof module === 'undefined') {
                window.module = { 
                    exports: {},
                    require: window.require,
                    id: 'browser-module',
                    filename: 'browser-module.js',
                    loaded: false,
                    parent: null,
                    children: []
                };
            }
            
            if (typeof exports === 'undefined') {
                window.exports = window.module.exports;
            }
            
            // Set up EventEmitter as module export
            window.module.exports = EventEmitter;
            window.exports.EventEmitter = EventEmitter;
            
            // Make it available in different ways the library might look for it
            global.EventEmitter = EventEmitter;
            
            // For Node.js 'events' module compatibility
            if (typeof events === 'undefined') {
                window.events = { EventEmitter: EventEmitter };
            }
            
            // Debug log to verify it's available
            console.log('Enhanced EventEmitter polyfill installed:');
            console.log('- window.EventEmitter:', typeof window.EventEmitter);
            console.log('- global.EventEmitter:', typeof global.EventEmitter);
            console.log('- module.exports:', typeof module.exports);
            console.log('- exports.EventEmitter:', typeof exports.EventEmitter);
            console.log('- require("events"):', typeof require('events'));
        })();
    </script>

    <!-- Libraries in correct order -->
    <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
    <script src="/node_modules/pixi.js/dist/pixi.min.js"></script>
    
    <!-- Debug script to check PIXI state before loading live2d -->
    <script>
        console.log('=== PRE-LIVE2D LOAD STATE ===');
        console.log('PIXI loaded:', typeof PIXI !== 'undefined');
        console.log('PIXI.live2d before load:', typeof PIXI !== 'undefined' && PIXI.live2d);
        console.log('EventEmitter available:', typeof EventEmitter !== 'undefined');
        console.log('Live2DCubismCore available:', typeof Live2DCubismCore !== 'undefined');
        
        // CRITICAL: Ensure EventEmitter is available before library loads
        if (typeof EventEmitter === 'undefined') {
            console.error('FATAL: EventEmitter is not available! Library will fail to load.');
            console.error('This should not happen - check EventEmitter polyfill');
        } else {
            console.log('‚úì EventEmitter is available and ready');
        }
        
        // The library expects individual PIXI modules - let's make them available
        if (typeof PIXI !== 'undefined') {
            console.log('Setting up PIXI module compatibility...');
            
            // Create a VERY simple require function that returns exactly what's needed
            window.require = function(module) {
                console.log('Mock require called for:', module);
                
                // Handle events module
                if (module === 'events') {
                    console.log('Returning events module with EventEmitter property');
                    return {
                        EventEmitter: EventEmitter
                    };
                }
                
                // Handle PIXI modules - the library expects specific module exports
                if (module === '@pixi/core') {
                    console.log('Returning PIXI core modules');
                    return typeof PIXI !== 'undefined' ? {
                        Application: PIXI.Application,
                        Container: PIXI.Container,
                        DisplayObject: PIXI.DisplayObject,
                        Renderer: PIXI.Renderer,
                        Texture: PIXI.Texture,
                        BaseTexture: PIXI.BaseTexture,
                        Sprite: PIXI.Sprite,
                        Graphics: PIXI.Graphics,
                        utils: PIXI.utils,
                        settings: PIXI.settings,
                        Rectangle: PIXI.Rectangle,
                        Point: PIXI.Point,
                        Matrix: PIXI.Matrix,
                        Transform: PIXI.Transform,
                        EventEmitter: PIXI.EventEmitter || EventEmitter,
                        // Add all PIXI properties as fallback
                        ...PIXI
                    } : {};
                }
                
                if (module === '@pixi/display') {
                    console.log('Returning PIXI display modules');
                    return typeof PIXI !== 'undefined' ? {
                        Container: PIXI.Container,
                        DisplayObject: PIXI.DisplayObject,
                        Sprite: PIXI.Sprite,
                        Graphics: PIXI.Graphics,
                        // Add all PIXI properties as fallback
                        ...PIXI
                    } : {};
                }
                
                // Handle other PIXI modules
                if (module.startsWith('@pixi/')) {
                    console.log('Returning PIXI for', module);
                    return typeof PIXI !== 'undefined' ? PIXI : {};
                }
                
                console.log('Unknown module requested:', module);
                return {};
            };
            
            console.log('PIXI module compatibility setup complete');
        }
        
        // Capture any errors during library loading
        window.addEventListener('error', function(e) {
            console.error('Global error during library loading:', e.error);
            console.error('Error source:', e.filename, 'Line:', e.lineno);
        });
        
        // Override console.error to capture library errors
        const originalConsoleError = console.error;
        console.error = function(...args) {
            if (args.some(arg => typeof arg === 'string' && (arg.includes('live2d') || arg.includes('Live2D')))) {
                console.log('Live2D related error captured:', args);
            }
            originalConsoleError.apply(console, args);
        };
    </script>
    
    <!-- Try loading as ES module with dynamic import -->
    <script type="module">
        console.log('Attempting to load pixi-live2d-display with ES module import...');
        
        try {
            // Dynamic import approach
            const live2dModule = await import('/node_modules/pixi-live2d-display-lipsyncpatch/dist/index.es.js');
            console.log('ES module import successful:', live2dModule);
            console.log('Live2D module keys:', Object.keys(live2dModule));
            console.log('PIXI.live2d after ES import:', typeof PIXI !== 'undefined' && typeof PIXI.live2d !== 'undefined');
            
            // The module might not attach itself to PIXI automatically
            if (typeof PIXI !== 'undefined' && !PIXI.live2d) {
                console.log('PIXI.live2d not attached - checking module exports...');
                
                // Check what the module exports
                if (live2dModule.Live2DModel) {
                    console.log('Found Live2DModel in module exports - manually attaching...');
                    PIXI.live2d = { Live2DModel: live2dModule.Live2DModel };
                    console.log('Manual attachment complete');
                } else if (live2dModule.default && live2dModule.default.Live2DModel) {
                    console.log('Found Live2DModel in default export - manually attaching...');
                    PIXI.live2d = { Live2DModel: live2dModule.default.Live2DModel };
                    console.log('Manual attachment complete');
                } else {
                    console.log('Available exports:', Object.keys(live2dModule));
                    // Try to find any constructor-like function
                    const exportKeys = Object.keys(live2dModule);
                    for (const key of exportKeys) {
                        const value = live2dModule[key];
                        if (typeof value === 'function' && value.from) {
                            console.log(`Found constructor-like function in ${key} - using as Live2DModel`);
                            PIXI.live2d = { Live2DModel: value };
                            break;
                        }
                    }
                }
                
                // Set up global reference for testing
                window.live2dModule = live2dModule;
            }
            
        } catch (e) {
            console.error('ES module import failed:', e.message);
            console.error('Stack trace:', e.stack);
            
            // If it's a module resolution error, don't treat it as fatal
            if (e.message.includes('Failed to resolve module specifier')) {
                console.log('Module resolution error - this is expected with the current setup');
                console.log('The regular script tag approach should work instead');
            }
        }
    </script>
    
    <!-- Fallback to regular script loading -->
    <script>
        // Add comprehensive debugging before library load
        console.log('=== COMPREHENSIVE PRE-LOAD DEBUG ===');
        console.log('window.require defined:', typeof window.require);
        console.log('window.EventEmitter defined:', typeof window.EventEmitter);
        console.log('window.PIXI defined:', typeof window.PIXI);
        console.log('window.Live2DCubismCore defined:', typeof window.Live2DCubismCore);
        
        // Test our require function
        if (typeof window.require === 'function') {
            console.log('Testing require function...');
            try {
                const eventsTest = window.require('events');
                console.log('require("events") test result:', eventsTest);
                console.log('require("events") type:', typeof eventsTest);
            } catch (e) {
                console.error('require("events") test failed:', e);
            }
        }
        
        // Override require to add more debugging
        const originalRequire = window.require;
        window.require = function(module) {
            console.log('üîç REQUIRE INTERCEPTED:', module);
            
            // Handle events module specially
            if (module === 'events') {
                console.log('üîç Returning simple events module');
                // Return exactly what Node.js events module provides
                return {
                    EventEmitter: EventEmitter
                };
            }
            
            // Handle PIXI modules
            if (module.startsWith('@pixi/')) {
                console.log('üîç Returning PIXI for', module);
                return PIXI;
            }
            
            console.log('üîç Fallback: Unknown module requested:', module);
            return {};
        };
        
        // Monitor PIXI.live2d changes
        let pixiLive2dWatcher = setInterval(() => {
            if (typeof PIXI !== 'undefined' && PIXI.live2d) {
                console.log('üéâ PIXI.live2d detected!', PIXI.live2d);
                console.log('üéâ PIXI.live2d keys:', Object.keys(PIXI.live2d));
                clearInterval(pixiLive2dWatcher);
            }
        }, 100);
        
        // Clear watcher after 10 seconds
        setTimeout(() => {
            clearInterval(pixiLive2dWatcher);
            console.log('‚è±Ô∏è PIXI.live2d watcher timeout');
        }, 10000);
    </script>
    
    <script 
        src="/node_modules/pixi-live2d-display-lipsyncpatch/dist/index.js"
        onload="console.log('üì¶ pixi-live2d-display-lipsyncpatch loaded successfully (regular script)'); console.log('üì¶ PIXI.live2d after load:', typeof PIXI !== 'undefined' && typeof PIXI.live2d !== 'undefined');"
        onerror="console.error('‚ùå Failed to load pixi-live2d-display-lipsyncpatch (regular script)'); window.pixiLive2DLoadError = true;"
    ></script>
    
    <!-- Debug script to check what was loaded -->
    <script>
        // Add a small delay to ensure all libraries are fully initialized
        setTimeout(() => {
            console.log('=== LIBRARY LOADING DEBUG ===');
            console.log('PIXI loaded:', typeof PIXI !== 'undefined');
            console.log('PIXI.live2d loaded:', typeof PIXI !== 'undefined' && typeof PIXI.live2d !== 'undefined');
            console.log('Live2DCubismCore loaded:', typeof Live2DCubismCore !== 'undefined');
            console.log('pixiLive2DLoadError:', window.pixiLive2DLoadError || false);
            
            // Detailed PIXI inspection
            if (typeof PIXI !== 'undefined') {
                console.log('PIXI version:', PIXI.VERSION);
                console.log('PIXI properties count:', Object.keys(PIXI).length);
                console.log('PIXI has EventEmitter:', typeof PIXI.EventEmitter !== 'undefined');
                
                // Check if PIXI.live2d exists in any form
                console.log('PIXI.live2d direct access:', PIXI.live2d);
                console.log('PIXI.live2d type:', typeof PIXI.live2d);
                
                // Check for any live2d-related properties
                const pixiKeys = Object.keys(PIXI);
                const live2dKeys = pixiKeys.filter(key => key.toLowerCase().includes('live2d'));
                console.log('PIXI keys containing "live2d":', live2dKeys);
                
                // Check prototype chain for live2d
                try {
                    const proto = Object.getPrototypeOf(PIXI);
                    console.log('PIXI prototype:', proto);
                    if (proto && proto.live2d) {
                        console.log('Found live2d in prototype:', proto.live2d);
                    }
                } catch (e) {
                    console.log('Error checking prototype:', e.message);
                }
                
                if (PIXI.live2d) {
                    console.log('PIXI.live2d keys:', Object.keys(PIXI.live2d));
                    console.log('PIXI.live2d.Live2DModel:', typeof PIXI.live2d.Live2DModel);
                    
                    // Check if it's a constructor
                    if (typeof PIXI.live2d.Live2DModel === 'function') {
                        console.log('PIXI.live2d.Live2DModel.from:', typeof PIXI.live2d.Live2DModel.from);
                        console.log('PIXI.live2d.Live2DModel properties:', Object.getOwnPropertyNames(PIXI.live2d.Live2DModel));
                    }
                } else {
                    console.log('PIXI.live2d is undefined');
                    
                    // Check if it's a getter that throws an error
                    try {
                        const descriptor = Object.getOwnPropertyDescriptor(PIXI, 'live2d');
                        console.log('PIXI.live2d descriptor:', descriptor);
                    } catch (e) {
                        console.log('Error getting descriptor:', e.message);
                    }
                }
            }
            
            // Check if the library attached itself elsewhere
            const windowKeys = Object.keys(window);
            const live2dKeys = windowKeys.filter(key => key.toLowerCase().includes('live2d'));
            console.log('Window keys containing "live2d":', live2dKeys);
            
            // Check for any constructor functions that might be Live2DModel
            const constructorKeys = windowKeys.filter(key => {
                try {
                    const value = window[key];
                    return typeof value === 'function' && value.from && key.includes('Live2D');
                } catch (e) {
                    return false;
                }
            });
            console.log('Potential Live2DModel constructors:', constructorKeys);
            
            // Check EventEmitter state
            console.log('EventEmitter state:');
            console.log('- window.EventEmitter:', typeof window.EventEmitter);
            console.log('- global.EventEmitter:', typeof global.EventEmitter);
            console.log('- module.exports type:', typeof module.exports);
            console.log('- exports.EventEmitter:', typeof exports.EventEmitter);
            
            // Try to call require to see what happens
            try {
                const events = require('events');
                console.log('require("events") result:', events);
                console.log('require("events") type:', typeof events);
                console.log('require("events").EventEmitter:', typeof events.EventEmitter);
                console.log('require("events").EventEmitter === EventEmitter:', events.EventEmitter === EventEmitter);
                if (typeof events.EventEmitter === 'function') {
                    console.log('Can create EventEmitter from require("events").EventEmitter:', typeof new events.EventEmitter());
                }
            } catch (e) {
                console.log('require("events") error:', e.message);
            }
            
        }, 500); // Increased delay to allow more initialization time
    </script>

    <script>
        let app, model;

        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            const timestamp = new Date().toISOString().split('T')[1].substring(0, 8);
            logElement.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function testCubism4Library() {
            log('=== TESTING CUBISM 4 LIBRARY ===');
            
            // Test what's available after loading cubism4.min.js
            log('Window properties after library loading:');
            const windowProps = Object.getOwnPropertyNames(window);
            const live2dRelated = windowProps.filter(prop => 
                prop.toLowerCase().includes('live2d') || 
                prop.toLowerCase().includes('cubism')
            );
            log('Live2D related window properties: ' + live2dRelated.join(', '));
            
            // Check PIXI extensions
            if (PIXI.live2d) {
                log('PIXI.live2d after cubism4 load:');
                const keys = Object.keys(PIXI.live2d);
                log('Keys: ' + keys.join(', '));
                
                // Try each key to see if it's a constructor
                keys.forEach(key => {
                    const value = PIXI.live2d[key];
                    if (typeof value === 'function') {
                        log(`${key} is a function with properties: ${Object.getOwnPropertyNames(value).join(', ')}`);
                        
                        // Test if it has static methods like .from()
                        if (value.from) {
                            log(`${key}.from() is available!`, 'success');
                        }
                    }
                });
            }
            
            // Test direct Live2D model loading
            log('Testing direct Live2D model access...');
            
            // Check for Live2DModel in different locations
            const locations = [
                { name: 'Live2DModel (global)', obj: typeof Live2DModel !== 'undefined' ? Live2DModel : null },
                { name: 'window.Live2DModel', obj: window.Live2DModel },
                { name: 'PIXI.live2d.Live2DModel', obj: PIXI.live2d && PIXI.live2d.Live2DModel },
                { name: 'PIXI.Live2DModel', obj: PIXI.Live2DModel }
            ];
            
            locations.forEach(location => {
                if (location.obj) {
                    log(`Found ${location.name}!`, 'success');
                    log(`  Type: ${typeof location.obj}`);
                    if (typeof location.obj === 'function') {
                        log(`  Has .from() method: ${typeof location.obj.from === 'function'}`);
                        log(`  Constructor properties: ${Object.getOwnPropertyNames(location.obj).join(', ')}`);
                    }
                } else {
                    log(`${location.name}: not found`);
                }
            });
        }

        async function testModelLoading() {
            log('=== TESTING MODEL LOADING ===');
            
            if (!app) {
                await initApp();
            }
            
            const modelUrl = 'http://localhost:13443/static/assets/miku_2/21miku_normal_3.0_f_t02.model3.json';
            
            // Try each possible Live2DModel location
            const modelConstructors = [
                { name: 'PIXI.live2d.Live2DModel', constructor: PIXI.live2d && PIXI.live2d.Live2DModel },
                { name: 'window.Live2DModel', constructor: window.Live2DModel },
                { name: 'PIXI.Live2DModel', constructor: PIXI.Live2DModel },
                { name: 'Live2DModel (global)', constructor: typeof Live2DModel !== 'undefined' ? Live2DModel : null }
            ];
            
            for (const { name, constructor } of modelConstructors) {
                if (constructor && typeof constructor.from === 'function') {
                    log(`Trying to load model with ${name}...`, 'warning');
                    
                    try {
                        const model = await constructor.from(modelUrl);
                        log(`Successfully loaded model with ${name}!`, 'success');
                        
                        // Configure and add to stage
                        if (model.anchor && model.anchor.set) {
                            model.anchor.set(0.5, 0.5);
                        }
                        model.position.set(app.screen.width / 2, app.screen.height / 2);
                        model.scale.set(0.4);
                        
                        // Clear existing model
                        if (window.currentModel) {
                            app.stage.removeChild(window.currentModel);
                        }
                        
                        app.stage.addChild(model);
                        window.currentModel = model;
                        
                        log('Model added to stage successfully!', 'success');
                        return;
                        
                    } catch (error) {
                        log(`Failed to load with ${name}: ${error.message}`, 'error');
                    }
                } else {
                    log(`${name} not available or missing .from() method`);
                }
            }
            
            log('All model loading attempts failed - PIXI.live2d library not properly loaded', 'error');
            
            // Check browser console for additional errors
            log('Check browser console for additional error details', 'error');
            
            // Log current library state
            log('Current library state:', 'error');
            log('- PIXI version: ' + (typeof PIXI !== 'undefined' ? PIXI.VERSION : 'not loaded'), 'error');
            log('- EventEmitter polyfill: ' + (typeof EventEmitter !== 'undefined' ? 'loaded' : 'not loaded'), 'error');
            log('- Live2DCubismCore: ' + (typeof Live2DCubismCore !== 'undefined' ? 'loaded' : 'not loaded'), 'error');
            log('- PIXI.live2d: ' + (typeof PIXI !== 'undefined' && PIXI.live2d ? 'partially loaded' : 'not loaded'), 'error');
        }

        async function testModuleLoading() {
            log('=== TESTING MODULE LOADING ===');
            
            // Test EventEmitter first
            if (typeof EventEmitter !== 'undefined') {
                log('‚úì EventEmitter available globally', 'success');
                try {
                    const testEmitter = new EventEmitter();
                    testEmitter.on('test', () => log('‚úì EventEmitter functionality working', 'success'));
                    testEmitter.emit('test');
                } catch (e) {
                    log('‚úó EventEmitter test failed: ' + e.message, 'error');
                }
            } else {
                log('‚úó EventEmitter not available', 'error');
            }
            
            // This test is for PIXI.live2d troubleshooting only
            log('=== PIXI.live2d TROUBLESHOOTING MODE ===', 'warning');
            log('This test file is designed to troubleshoot PIXI.live2d implementation only.', 'warning');
            log('For fallback implementations, use the Live2DCubismFallback module separately.', 'warning');
            
            // Detailed library state inspection
            log('=== LIBRARY STATE INSPECTION ===');
            
            // Check if libraries loaded
            log('PIXI loaded: ' + (typeof PIXI !== 'undefined'));
            log('PIXI version: ' + (typeof PIXI !== 'undefined' ? PIXI.VERSION : 'N/A'));
            log('Live2DCubismCore loaded: ' + (typeof Live2DCubismCore !== 'undefined'));
            log('EventEmitter polyfill loaded: ' + (typeof EventEmitter !== 'undefined'));
            
            // Check PIXI.live2d in detail
            if (typeof PIXI !== 'undefined') {
                log('PIXI.live2d available: ' + (typeof PIXI.live2d !== 'undefined'));
                
                if (PIXI.live2d) {
                    const keys = Object.keys(PIXI.live2d);
                    log('PIXI.live2d keys: ' + keys.join(', '));
                    
                    // Check each key
                    keys.forEach(key => {
                        const value = PIXI.live2d[key];
                        log(`PIXI.live2d.${key}: ${typeof value}`);
                        
                        if (typeof value === 'function') {
                            log(`  - Has .from() method: ${typeof value.from === 'function'}`);
                            log(`  - Constructor name: ${value.name}`);
                        }
                    });
                } else {
                    log('PIXI.live2d is undefined - library failed to initialize', 'error');
                    
                    // Check for library loading errors
                    if (window.pixiLive2DLoadError) {
                        log('Library loading error detected - check network tab', 'error');
                    }
                    
                    // Check for common attachment points
                    log('Checking alternative attachment points:', 'warning');
                    const alternativeChecks = [
                        'window.Live2DModel',
                        'window.PIXI.Live2DModel',
                        'global.Live2DModel',
                        'typeof Live2DModel'
                    ];
                    
                    alternativeChecks.forEach(check => {
                        try {
                            const result = eval(check);
                            log(`${check}: ${typeof result !== 'undefined' ? typeof result : 'undefined'}`);
                        } catch (e) {
                            log(`${check}: error evaluating`);
                        }
                    });
                }
            } else {
                log('PIXI not loaded - check PIXI.js loading', 'error');
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function copyLogToClipboard() {
            const logElement = document.getElementById('log');
            const logText = logElement.innerText;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(logText).then(function() {
                    log('Log copied to clipboard!', 'success');
                }).catch(function(err) {
                    log('Failed to copy log: ' + err, 'error');
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = logText;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    log('Log copied to clipboard!', 'success');
                } catch (err) {
                    log('Failed to copy log: ' + err, 'error');
                }
                document.body.removeChild(textArea);
            }
        }

        function startFlaskServer() {
            log('Starting Flask server...');
            log('Please run: cd src && python app.py');
            log('Or use terminal to start the server manually');
        }

        // === REMOVED NON-ESSENTIAL FUNCTIONS ===
        // The following functions were removed for streamlined testing:
        // - testModelScaling() - replaced with direct scale testing in console
        // - testSimpleTexture() - basic texture testing, use browser dev tools instead
        // - testSimpleMesh() - mesh testing, use browser dev tools instead  
        // - debugModelBounds() - bounds debugging, use browser dev tools instead
        // - testPIXITexture() - PIXI texture API testing, use browser dev tools instead
        // - showModelInfo() - model info display, use browser dev tools instead
        // - checkNetworkAndLibrary() - network checking, use browser dev tools instead
        //
        // Focus is now on core PIXI.live2d functionality testing only.

        async function initApp() {
            log('Initializing PIXI application...');
            
            const canvas = document.getElementById('canvas');
            const options = {
                width: 800,
                height: 600,
                backgroundColor: 0xffffff,
                resolution: 1
            };

            try {
                if (PIXI.VERSION.startsWith('8.')) {
                    app = new PIXI.Application();
                    await app.init(options);
                    canvas.appendChild(app.canvas);
                } else {
                    app = new PIXI.Application(options);
                    canvas.appendChild(app.view);
                }
                
                log('PIXI application initialized successfully', 'success');
                return true;
            } catch (error) {
                log('Failed to initialize PIXI: ' + error.message, 'error');
                return false;
            }
        }

        async function loadModelPIXI() {
            log('=== LOADING MIKU_2 FULL BODY MODEL ===');
            
            if (!app) {
                const success = await initApp();
                if (!success) return;
            }

            log('Loading Live2D model with PIXI bridge...');
            
            const modelUrl = 'http://localhost:13443/static/assets/miku_2/21miku_normal_3.0_f_t02.model3.json';
            log('Model URL: ' + modelUrl);
            
            try {
                // Clear existing model
                if (model) {
                    app.stage.removeChild(model);
                    model = null;
                    log('Cleared existing model');
                }

                // Check if PIXI.live2d is available
                if (!PIXI.live2d || !PIXI.live2d.Live2DModel) {
                    log('ERROR: PIXI.live2d.Live2DModel not available', 'error');
                    log('This indicates the pixi-live2d-display-lipsyncpatch library failed to load correctly', 'error');
                    
                    // Show current state
                    log('Current state:', 'error');
                    log('- PIXI loaded: ' + (typeof PIXI !== 'undefined'), 'error');
                    log('- PIXI.live2d: ' + (typeof PIXI !== 'undefined' && PIXI.live2d ? 'partially loaded' : 'not loaded'), 'error');
                    log('- EventEmitter: ' + (typeof EventEmitter !== 'undefined'), 'error');
                    log('- Library load error: ' + (window.pixiLive2DLoadError || 'none detected'), 'error');
                    
                    return;
                }

                // Standard PIXI.live2d approach
                log('Using PIXI.live2d.Live2DModel approach', 'success');
                
                // Configure Live2D
                if (PIXI.live2d.config) {
                    const baseUrl = modelUrl.substring(0, modelUrl.lastIndexOf('/') + 1);
                    PIXI.live2d.config.resolveURL = (url) => {
                        const resolved = url.startsWith('http') ? url : baseUrl + url;
                        log(`Resolving URL: ${url} -> ${resolved}`);
                        return resolved;
                    };
                    log('Configured resolveURL');
                }

                // Load model
                log('Loading model with PIXI.live2d.Live2DModel.from()...', 'warning');
                log('This may take a moment for the full body model...');
                
                model = await PIXI.live2d.Live2DModel.from(modelUrl);
                log('Model loaded successfully!', 'success');
                log('Model dimensions: ' + model.width + 'x' + model.height);

                // Configure model (sekai.best style)
                model.anchor.set(0.5, 0.5);
                model.position.set(app.screen.width / 2, app.screen.height / 2);
                model.scale.set(0.4);

                // Add to stage
                app.stage.addChild(model);
                log('Model added to stage successfully!', 'success');
                log('Model position: (' + model.position.x + ', ' + model.position.y + ')');
                log('Model scale: ' + model.scale.x);

            } catch (error) {
                log('Error loading model: ' + error.message, 'error');
                log('Stack trace: ' + error.stack, 'error');
                
                // Network error analysis
                if (error.message.includes('fetch') || error.message.includes('Failed to fetch')) {
                    log('‚Üí Network error: Check if Flask server is running on port 13443', 'error');
                    log('‚Üí Try: cd src && python app.py', 'error');
                } else if (error.message.includes('JSON')) {
                    log('‚Üí Model file parsing error: Check model.json format', 'error');
                } else if (error.message.includes('texture')) {
                    log('‚Üí Texture loading error: Check texture file paths', 'error');
                }
            }
        }

        async function loadModelWithProperLibrary(modelUrl) {
            log('=== PIXI.live2d LIBRARY DIAGNOSTIC ===');
            
            // This function is now purely diagnostic
            log('Performing detailed PIXI.live2d library diagnostic...', 'warning');
            
            // Check if the library is available
            if (!PIXI.live2d || !PIXI.live2d.Live2DModel) {
                log('ERROR: PIXI.live2d.Live2DModel not available', 'error');
                log('Available PIXI.live2d keys: ' + (PIXI.live2d ? Object.keys(PIXI.live2d).join(', ') : 'PIXI.live2d is undefined'), 'error');
                
                // Check EventEmitter state
                log('EventEmitter diagnostic:', 'error');
                log('- window.EventEmitter: ' + (typeof window.EventEmitter !== 'undefined'), 'error');
                log('- global.EventEmitter: ' + (typeof global.EventEmitter !== 'undefined'), 'error');
                log('- require("events"): ' + (typeof require === 'function' && require('events') ? 'available' : 'not available'), 'error');
                
                // Check for library loading errors
                if (window.pixiLive2DLoadError) {
                    log('Library loading error was detected during script load', 'error');
                    log('Check network tab for HTTP errors or file not found', 'error');
                }
                
                // Check PIXI version compatibility
                if (typeof PIXI !== 'undefined') {
                    log('PIXI version: ' + PIXI.VERSION, 'error');
                    log('Expected compatibility: PIXI v8.x with pixi-live2d-display-lipsyncpatch v0.5.0-ls-8', 'error');
                } else {
                    log('PIXI not loaded - this is a prerequisite for pixi-live2d-display', 'error');
                }
                
                return null;
            }
            
            // If we get here, PIXI.live2d is available
            log('‚úì PIXI.live2d.Live2DModel is available!', 'success');
            
            // Clear existing model
            clearStage();
            
            // Test basic library functionality
            log('Testing PIXI.live2d library functionality...', 'warning');
            
            try {
                // Configure the Live2D library
                if (PIXI.live2d.config) {
                    log('‚úì PIXI.live2d.config available', 'success');
                    
                    // Set up URL resolver
                    const baseUrl = modelUrl.substring(0, modelUrl.lastIndexOf('/') + 1);
                    PIXI.live2d.config.resolveURL = (url) => {
                        if (url.startsWith('http')) return url;
                        const resolved = baseUrl + url;
                        log(`URL resolved: ${url} -> ${resolved}`);
                        return resolved;
                    };
                    
                    // Enable verbose logging
                    if (PIXI.live2d.config.LOG_LEVEL_VERBOSE) {
                        PIXI.live2d.config.logLevel = PIXI.live2d.config.LOG_LEVEL_VERBOSE;
                        log('‚úì Verbose logging enabled', 'success');
                    }
                } else {
                    log('‚ö† PIXI.live2d.config not available', 'warning');
                }
                
                // Attempt to load the model
                log('Attempting to load model with PIXI.live2d.Live2DModel.from()...', 'warning');
                
                const model = await PIXI.live2d.Live2DModel.from(modelUrl);
                
                log('‚úì Model loaded successfully!', 'success');
                log(`Model type: ${model.constructor.name}`);
                log(`Model size: ${model.width}x${model.height}`);
                
                // Configure and add to stage
                model.anchor.set(0.5, 0.5);
                model.position.set(app.screen.width / 2, app.screen.height / 2);
                model.scale.set(0.4);
                
                app.stage.addChild(model);
                window.currentModel = model;
                
                log('‚úì Model added to stage successfully!', 'success');
                return model;
                
            } catch (error) {
                log('ERROR: Failed to load model', 'error');
                log(`Error message: ${error.message}`, 'error');
                log(`Error stack: ${error.stack}`, 'error');
                
                // Provide specific error analysis
                if (error.message.includes('fetch')) {
                    log('‚Üí This is likely a network error. Check model URL and server availability.', 'error');
                } else if (error.message.includes('JSON')) {
                    log('‚Üí This is likely a model file parsing error. Check model.json format.', 'error');
                } else if (error.message.includes('texture')) {
                    log('‚Üí This is likely a texture loading error. Check texture file paths.', 'error');
                } else {
                    log('‚Üí Unknown error type. Check browser console for additional details.', 'error');
                }
                
                return null;
            }
        }

        function clearStage() {
            if (app && app.stage) {
                // Clear all children from the stage
                while (app.stage.children[0]) {
                    app.stage.removeChild(app.stage.children[0]);
                }
                log('Stage cleared');
            }
        }

        async function loadModelCubismWithPIXI(modelUrl, showTestSprite = false, showDebugOverlay = true) {
            // This test file is for PIXI.live2d troubleshooting only
            log('=== PIXI.live2d TROUBLESHOOTING ONLY ===', 'warning');
            log('This file is designed to troubleshoot PIXI.live2d implementation.', 'warning');
            log('For fallback implementations, use the separate Live2DCubismFallback module.', 'warning');
            
            // Redirect to the proper library test
            log('Redirecting to loadModelWithProperLibrary for PIXI.live2d testing...', 'warning');
            return await loadModelWithProperLibrary(modelUrl);
        }

        function addDebugUI() {
            const existingBtnBar = document.querySelector('.debug-btn-bar');
            if (existingBtnBar) {
                existingBtnBar.remove();
            }
            
            const btnBar = document.createElement('div');
            btnBar.className = 'debug-btn-bar';
            btnBar.style.cssText = 'margin: 8px 0; padding: 10px; background: #f5f5f5; border: 1px solid #ccc; border-radius: 4px;';
            btnBar.innerHTML = `
                <div style="margin-bottom: 8px;">
                    <strong>Quick Actions:</strong>
                    <button id="btn-load-pixi" style="margin-left: 8px;">üé≠ Load Model</button>
                    <button id="btn-clear-stage" style="margin-left: 8px;">üßπ Clear Stage</button>
                    <button id="btn-reload" style="margin-left: 8px;">üîÑ Reload</button>
                </div>
            `;
            
            const controls = document.querySelector('.controls');
            controls.parentNode.insertBefore(btnBar, controls);
            
            // Wire up button events
            document.getElementById('btn-load-pixi').onclick = () => {
                log('üé≠ Load Model button clicked', 'info');
                loadModelPIXI();
            };
            document.getElementById('btn-clear-stage').onclick = clearStage;
            document.getElementById('btn-reload').onclick = () => {
                log('üîÑ Reload button clicked', 'info');
                if (model && app) {
                    app.stage.removeChild(model);
                    model = null;
                }
                loadModelPIXI();
            };
            
            log('Streamlined debug UI added');
        }

        // Initialize when page loads
        window.addEventListener('load', async () => {
            log('Page loaded, initializing...');
            await initApp();
            addDebugUI();
        });
    </script>
</body>
</html>
