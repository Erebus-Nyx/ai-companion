<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Audio + Lipsync Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f0f0;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .test-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .status {
            background: #e8f4f8;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #2196F3;
        }
        .error {
            background: #ffeaea;
            border-left-color: #f44336;
            color: #d32f2f;
        }
        .success {
            background: #e8f5e8;
            border-left-color: #4caf50;
            color: #2e7d32;
        }
        .console-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .audio-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        .audio-locked {
            background: #ffebee;
            color: #c62828;
        }
        .audio-unlocked {
            background: #e8f5e8;
            color: #2e7d32;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üéµ Enhanced Audio + Lipsync Test</h1>
        
        <div class="status" id="audioStatus">
            <strong>Audio Status:</strong> 
            <span class="audio-status audio-locked" id="audioStatusIndicator">üîí Locked - Click to Enable</span>
        </div>
        
        <div class="status">
            <strong>Instructions:</strong> Click "Enable Audio" first, then test TTS features. 
            Mouth movements should now be faster (every 0.15s) and more varied.
        </div>
        
        <div style="margin: 20px 0;">
            <button class="test-button" id="enableAudioBtn" onclick="enableAudio()">
                üîì Enable Audio Context
            </button>
            
            <button class="test-button" onclick="testBasicLipsync()" disabled id="lipsyncBtn">
                üëÑ Test Enhanced Lipsync (No Audio)
            </button>
            
            <button class="test-button" onclick="testTTSWithAudio()" disabled id="ttsBtn">
                üó£Ô∏è Test TTS + Audio + Lipsync
            </button>
            
            <button class="test-button" onclick="testAutonomousGreeting()" disabled id="greetingBtn">
                ü§ñ Test Autonomous Greeting
            </button>
        </div>
        
        <div class="console-output" id="consoleOutput">
            Waiting for audio context to be enabled...
        </div>
        
        <div class="status">
            <strong>Expected Improvements:</strong><br>
            ‚Ä¢ Mouth movements every 150ms (6.7 FPS) instead of slower timing<br>
            ‚Ä¢ More varied mouth shapes (A, I, U, E, O, default) with weighted probabilities<br>
            ‚Ä¢ Proper audio playback with browser autoplay handling<br>
            ‚Ä¢ Synchronized audio and lipsync start
        </div>
    </div>

    <!-- Load required modules -->
    <script src="js/audio_modules/audio_context_manager.js"></script>
    <script src="js/live2d_modules/live2d_multi_model_manager.js"></script>
    <script src="js/live2d_modules/live2d_motion_manager.js"></script>
    <script src="js/audio_modules/audio_tts.js"></script>

    <script>
        let consoleOutput = document.getElementById('consoleOutput');
        let audioEnabled = false;
        
        // Override console.log to show in our interface
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            consoleOutput.innerHTML += message + '\n';
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        };
        
        // Override console.error
        const originalError = console.error;
        console.error = function(...args) {
            originalError.apply(console, args);
            const message = '‚ùå ERROR: ' + args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            consoleOutput.innerHTML += message + '\n';
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        };
        
        function updateAudioStatus() {
            const indicator = document.getElementById('audioStatusIndicator');
            const buttons = ['lipsyncBtn', 'ttsBtn', 'greetingBtn'];
            
            if (window.audioContextManager && window.audioContextManager.isAudioUnlocked()) {
                indicator.textContent = 'üîì Unlocked - Ready to Play';
                indicator.className = 'audio-status audio-unlocked';
                buttons.forEach(id => document.getElementById(id).disabled = false);
                audioEnabled = true;
                console.log('‚úÖ Audio context is now unlocked and ready');
            } else {
                indicator.textContent = 'üîí Locked - Click to Enable';
                indicator.className = 'audio-status audio-locked';
                buttons.forEach(id => document.getElementById(id).disabled = true);
            }
        }
        
        async function enableAudio() {
            try {
                console.log('üîì Attempting to enable audio context...');
                
                // Play a silent audio to unlock
                const audio = new Audio();
                audio.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAAEAA==';
                await audio.play().catch(() => {});
                
                // Resume audio context if suspended
                if (window.audioContextManager) {
                    await window.audioContextManager.enableAudioPlayback();
                }
                
                updateAudioStatus();
                
                // Enable the enable button for re-testing
                document.getElementById('enableAudioBtn').textContent = 'üîÑ Re-enable Audio';
                
                console.log('‚úÖ Audio context enabled successfully');
                
            } catch (error) {
                console.error('Failed to enable audio:', error);
            }
        }
        
        async function testBasicLipsync() {
            console.log('üëÑ Testing enhanced lipsync pattern...');
            
            const avatarId = 'iori'; // Use default test avatar
            const duration = 4000; // 4 seconds
            
            console.log(`Creating enhanced lipsync for ${avatarId} (${duration}ms)`);
            
            if (window.createBasicLipsyncPattern) {
                window.createBasicLipsyncPattern(avatarId, duration);
                console.log('‚úÖ Enhanced lipsync pattern started');
            } else {
                console.error('‚ùå createBasicLipsyncPattern function not available');
            }
        }
        
        async function testTTSWithAudio() {
            console.log('üó£Ô∏è Testing TTS with audio and enhanced lipsync...');
            
            try {
                const testText = "Hello! This is a test of the enhanced lipsync system with faster mouth movements.";
                const emotion = "happy";
                const avatarId = "iori";
                
                if (window.triggerEmotionalTTS) {
                    await window.triggerEmotionalTTS(testText, emotion, avatarId);
                    console.log('‚úÖ TTS test completed successfully');
                } else {
                    console.error('‚ùå triggerEmotionalTTS function not available');
                }
                
            } catch (error) {
                console.error('TTS test failed:', error);
            }
        }
        
        async function testAutonomousGreeting() {
            console.log('ü§ñ Testing autonomous greeting with enhanced features...');
            
            try {
                const response = await fetch('/api/avatar/autonomous-greeting', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        avatar_id: 'iori',
                        emotion: 'happy'
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Autonomous greeting triggered:', result);
                } else {
                    console.error('‚ùå Autonomous greeting request failed:', response.status);
                }
                
            } catch (error) {
                console.error('Autonomous greeting test failed:', error);
            }
        }
        
        // Initialize on page load
        window.addEventListener('load', () => {
            console.log('üéµ Enhanced Audio + Lipsync Test Interface Loaded');
            console.log('Click "Enable Audio Context" first to unlock audio playback');
            updateAudioStatus();
            
            // Check audio status periodically
            setInterval(updateAudioStatus, 1000);
        });
    </script>
</body>
</html>
