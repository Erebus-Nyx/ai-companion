<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live2D AI Companion - Dual Architecture Testing Interface</title>
    <link rel="stylesheet" href="/static/css/live2d_test.css">
    <!-- Live2D AI Companion - Production-ready avatar system with dual runtime support -->
</head>
</head>
<body>
    <div class="app-container">
        <!-- Navigation Icons (Top Right) -->
        <nav class="nav-icons" id="navIcons">
            <button class="nav-icon" onclick="openChat()" title="Chat" data-tooltip="Chat">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                </svg>
            </button>
            <button class="nav-icon" onclick="openDrawing()" title="Drawing Tools" data-tooltip="Drawing">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                    <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                    <path d="M2 2l7.586 7.586"/>
                    <circle cx="11" cy="11" r="2"/>
                </svg>
            </button>            
            <div class="nav-divider"></div>
            <button class="nav-icon" onclick="openCharacterProfiles()" title="Character Profiles" data-tooltip="Characters">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
            </button>
            <button class="nav-icon" onclick="openUserManagement()" title="User Management" data-tooltip="Users">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="8.5" cy="7" r="4"/>
                    <path d="M20 8v6M23 11h-6"/>
                </svg>
            </button>
            <button class="nav-icon" onclick="openSettings()" title="Settings" data-tooltip="Settings">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"/>
                </svg>
            </button>
            <div class="nav-divider"></div>
            <button class="nav-icon" onclick="toggleFullscreen()" title="Fullscreen" data-tooltip="Fullscreen">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                </svg>
            </button>
            <button class="nav-icon" onclick="toggleHelp()" title="Help" data-tooltip="Help">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                    <point cx="12" cy="17"/>
                </svg>
            </button>
            <button class="nav-icon" onclick="logoutUser()" title="Logout" data-tooltip="Logout">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16,17 21,12 16,7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
            </button>            
            <button class="nav-icon nav-collapse" onclick="toggleNavigation()" title="Collapse Navigation" data-tooltip="Collapse">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="18,15 12,9 6,15"/>
                </svg>
            </button>
        </nav>
        
        <!-- User Selection Popup -->
        <div class="user-selection-overlay" id="userSelectionPopup">
            <div class="user-selection-popup">
                <div class="user-selection-header">
                    <h2>Select User Profile</h2>
                    <p>Choose your user profile to continue</p>
                </div>
                
                <div class="user-selection-message" id="userSelectionMessage" style="display: none;"></div>
                
                <div class="user-selection-content">
                    <div class="user-selection-list" id="userSelectionList">
                        <!-- Users will be populated here dynamically -->
                    </div>
                    
                    <!-- New User Form (initially hidden) -->
                    <form class="new-user-form" id="newUserForm" style="display: none;">
                        <div class="form-group">
                            <label for="username">Username*</label>
                            <input type="text" id="username" name="username" required minlength="3" placeholder="Enter username">
                        </div>
                        <div class="form-group">
                            <label for="display_name">Display Name</label>
                            <input type="text" id="display_name" name="display_name" placeholder="Enter display name (optional)">
                        </div>
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" name="email" placeholder="Enter email (optional)">
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Create User</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Chat Window -->
        <div class="chat-window" id="chatWindow">
            <div class="chat-header">
                <div class="chat-title-area">
                    <span class="chat-title">Chat</span>
                    <div class="active-characters" id="activeCharacters">
                        <button class="add-character-btn" onclick="showAddModelDialog()" title="Add Character">+</button>
                        <div class="character-icons-container" id="characterIconsContainer">
                            <!-- Active character icons will be populated here -->
                        </div>
                    </div>
                </div>
                <div class="window-controls">
                    <button class="close-btn" onclick="closeChat()">√ó</button>
                </div>
            </div>
            <div class="chat-content">
                <div class="chat-messages" id="chatMessages">
                    <!-- Chat messages will be populated here -->
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." onkeypress="handleChatKeyPress(event)">
                    <button class="send-btn" onclick="sendMessage()">Send</button>
                    <button class="voice-btn" id="voiceButton" onclick="toggleVoiceRecording()" title="Voice Recording">üé§</button>
                </div>
            </div>
        </div>
        
        <!-- Settings Panel (Left Side Overlay) -->
        <div class="settings-panel" id="settingsPanel">
            <div class="settings-header">
                <span class="settings-title">Live2D Settings</span>
                <div class="window-controls">
                    <button class="close-btn" onclick="closeSettings()">√ó</button>
                </div>
            </div>
            <div class="settings-content">
                <div class="settings-group">
                    <h4>Model Management</h4>
                    <div class="model-management-actions">
                        <div class="setting-item">
                            <label>Add Model to Canvas:</label>
                            <div class="model-add-controls">
                                <input type="file" id="canvasModelFileInput" accept=".zip" multiple style="display: none;">
                                <button class="btn btn-primary" onclick="document.getElementById('canvasModelFileInput').click()">
                                    üìÅ Upload ZIP Model
                                </button>
                                <select id="existingModelSelect" class="form-select">
                                    <option value="">Select existing model...</option>
                                </select>
                                <button class="btn btn-secondary" onclick="addExistingModelToCanvas()">
                                    ‚ûï Add to Canvas
                                </button>
                            </div>
                        </div>
                        <div class="setting-item">
                            <label>Remove Model:</label>
                            <div class="model-delete-controls">
                                <select id="canvasModelSelect" class="form-select">
                                    <option value="">No models on canvas...</option>
                                </select>
                                <button class="btn btn-warning" onclick="removeModelFromCanvas()" disabled id="removeModelBtn">
                                    üóëÔ∏è Remove
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Display Controls</h4>
                    <div class="setting-item">
                        <label for="zoomSlider">Scale: <span id="zoomValue">1.0</span></label>
                        <input type="range" id="zoomSlider" min="0.1" max="3.0" step="0.025" value="1.0" oninput="updateZoom(this.value); document.getElementById('zoomValue').textContent = this.value;">
                    </div>
                    <div class="setting-controls">
                        <button class="btn btn-secondary" onclick="resetZoom()">Reset</button>
                        <button class="btn btn-secondary" onclick="fitModel()">Fit</button>
                        <button class="btn btn-secondary" onclick="centerModel()">Center</button>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Motions</h4>
                    <div class="setting-item">
                        <label for="motionGroupSelect">Motion Group:</label>
                        <select id="motionGroupSelect" onchange="onMotionGroupChange()">
                            <option value="">No motions available</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label for="motionSelect">Motion:</label>
                        <select id="motionSelect" onchange="onMotionTypeChange()">
                            <option value="">Select motion group first</option>
                        </select>
                    </div>
                    <div class="setting-controls">
                        <button class="btn btn-primary" onclick="playSelectedMotion()">Play Motion</button>
                        <button class="btn btn-secondary" onclick="playRandomMotion()">Random</button>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Expressions</h4>
                    <div class="setting-item">
                        <label for="expressionSelect">Expression:</label>
                        <select id="expressionSelect" onchange="onExpressionChange()">
                            <option value="">No expressions available</option>
                        </select>
                    </div>
                    <div class="setting-controls">
                        <button class="btn btn-primary" onclick="playExpression()">Apply Expression</button>
                        <button class="btn btn-secondary" onclick="resetExpression()">Reset</button>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Actions</h4>
                    <div class="setting-controls">
                        <button class="btn btn-primary" onclick="testModel()">Test Model</button>
                        <button class="btn btn-warning" onclick="resetModel()">Reset</button>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Avatar State Management</h4>
                    <div class="setting-controls">
                        <button class="btn btn-info" onclick="window.saveLive2DState()" title="Save current avatar positions and states">Save State</button>
                        <button class="btn btn-secondary" onclick="window.loadLive2DState()" title="Load saved avatar states">Load State</button>
                        <button class="btn btn-primary" onclick="window.exportLive2DState()" title="Export state to file">Export</button>
                        <button class="btn btn-warning" onclick="window.clearLive2DState()" title="Clear all saved state">Clear</button>
                    </div>
                    <div class="setting-item" style="margin-top: 10px;">
                        <label for="stateImportFile">Import State File:</label>
                        <input type="file" id="stateImportFile" accept=".json" onchange="handleStateImport(this)" style="font-size: 12px;">
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Background Settings</h4>
                    <div class="setting-item">
                        <label for="backgroundImageFile">Background Image:</label>
                        <input type="file" id="backgroundImageFile" accept="image/*" onchange="handleBackgroundImageUpload(this)" style="font-size: 12px; margin-bottom: 8px;">
                    </div>
                    <div class="setting-controls">
                        <button class="btn btn-secondary" onclick="clearBackgroundImage()" title="Remove current background image">Clear Background</button>
                        <button class="btn btn-info" onclick="showBackgroundPreview()" title="Preview current background">Preview</button>
                    </div>
                    <div class="setting-item" style="margin-top: 10px;">
                        <label for="backgroundOpacity">Background Opacity: <span id="backgroundOpacityValue">100</span>%</label>
                        <input type="range" id="backgroundOpacity" min="0" max="100" value="100" oninput="updateBackgroundOpacity(this.value);" style="width: 100%;">
                    </div>
                    <div class="setting-item">
                        <label for="backgroundScale">Background Scale: <span id="backgroundScaleValue">100</span>%</label>
                        <input type="range" id="backgroundScale" min="50" max="200" value="100" oninput="updateBackgroundScale(this.value);" style="width: 100%;">
                    </div>
                    <div class="setting-item">
                        <label for="backgroundPosition">Background Position:</label>
                        <select id="backgroundPosition" onchange="updateBackgroundPosition(this.value)">
                            <option value="center">Center</option>
                            <option value="top">Top</option>
                            <option value="bottom">Bottom</option>
                            <option value="left">Left</option>
                            <option value="right">Right</option>
                            <option value="cover">Cover (Fill)</option>
                            <option value="contain">Contain (Fit)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Debug & Logging -->
                <div class="settings-group">
                    <h4>Debug & Logging</h4>
                    <div class="setting-controls">
                        <button class="btn btn-info" onclick="window.open('/logs', '_blank')" title="Open log viewer in new tab">
                            üìã View Logs
                        </button>
                        <button class="btn btn-secondary" onclick="downloadConsoleLogs()" title="Download frontend console logs">
                            üì• Console Logs
                        </button>
                    </div>
                    <div class="setting-item" style="margin-top: 10px;">
                        <button class="btn btn-info" onclick="debugActiveAvatars()" title="Debug active avatars">
                            üîç Debug Avatars
                        </button>
                        <button class="btn btn-secondary" onclick="forceAutonomousConversation()" title="Force autonomous conversation">
                            ü§ñ Test Autonomous
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Canvas Area -->
        <div class="canvas-container">
            <div class="canvas-frame">
                <div id="pixiContainer"></div>
                <!-- Drawing Overlay Canvas -->
                <canvas id="drawingOverlay" class="drawing-overlay-canvas" style="display: none;"></canvas>
            </div>
            <div class="loading-overlay" id="loadingOverlay" style="display: none;">
                <div class="loading-spinner"></div>
            </div>
        </div>
    </div>

    <!-- Model Selection Dialog -->
    <div class="model-selection-dialog" id="modelSelectionDialog" style="display: none;">
        <div class="dialog-overlay" onclick="closeAddModelDialog()"></div>
        <div class="dialog-content">
            <div class="dialog-header">
                <h3>Add Live2D Model</h3>
                <button class="dialog-close" onclick="closeAddModelDialog()">√ó</button>
            </div>
            <div class="dialog-body">
                <div class="model-grid" id="modelGrid">
                    <div style="text-align: center; padding: 20px; color: #aaa;">
                        Loading available models...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Selection Dialog -->
    <div class="user-selection-dialog" id="userSelectionDialog">
        <div class="dialog-content">
            <div class="dialog-header" style="cursor: move;">
                <h3>User Management</h3>
                <button class="dialog-close" onclick="closeUserDialog()">√ó</button>
            </div>
            <div class="dialog-body">
                <div class="user-selection-list" id="userSelectionList">
                    <div style="text-align: center; padding: 20px; color: #aaa;">
                        Loading users...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Profile Panel -->
    <div class="user-profile-panel" id="userProfilePanel">
        <div class="user-profile-header">
            <span class="user-profile-title">User Profile</span>
            <div class="window-controls">
                <button class="close-btn" onclick="closeUserProfile()">√ó</button>
            </div>
        </div>
        <div class="user-profile-content">
            <!-- Basic User Information Section -->
            <div class="user-section">
                <h4>User Information</h4>
                <div class="form-group">
                    <label for="userDisplayName">Display Name:</label>
                    <input type="text" id="userDisplayName" placeholder="Your display name" readonly>
                </div>
                <div class="form-group">
                    <label for="userUsername">Username:</label>
                    <input type="text" id="userUsername" placeholder="Your username" readonly>
                </div>
            </div>

            <!-- Personal Information Section -->
            <div class="user-section">
                <h4>Personal Information</h4>
                <div class="form-group">
                    <label for="userGender">Gender:</label>
                    <select id="userGender">
                        <option value="not_specified">Not Specified</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="non_binary">Non-Binary</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userAgeRange">Age Range:</label>
                    <select id="userAgeRange">
                        <option value="teen">Teen (13-17)</option>
                        <option value="young_adult">Young Adult (18-25)</option>
                        <option value="adult">Adult (26-35)</option>
                        <option value="middle_aged">Middle Aged (36-50)</option>
                        <option value="mature">Mature (51+)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userBio">Bio:</label>
                    <textarea id="userBio" placeholder="Tell us about yourself..." rows="3"></textarea>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="user-actions">
                <button class="btn btn-primary" onclick="saveUserProfile()">Save Profile</button>
                <button class="btn btn-secondary" onclick="closeUserProfile()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Character Profiles Panel -->
    <div class="character-profiles-panel" id="characterProfilesPanel">
        <div class="character-profiles-header">
            <span class="character-profiles-title">Character Profiles</span>
            <div class="window-controls">
                <button class="close-btn" onclick="closeCharacterProfiles()">√ó</button>
            </div>
        </div>
        <div class="character-profiles-content">
            <!-- Character Selection Section -->
            <div class="character-section">
                <h4>Character Selection</h4>
                <div class="form-group">
                    <label for="characterSelect">Select Character:</label>
                    <select id="characterSelect" onchange="onCharacterChange()">
                        <option value="">Loading characters...</option>
                    </select>
                </div>
                <div class="character-controls">
                    <button class="btn btn-primary" onclick="createNewCharacter()">New Character</button>
                    <button class="btn btn-secondary" onclick="duplicateCharacter()">Duplicate</button>
                    <button class="btn btn-warning" onclick="deleteCharacter()">Delete</button>
                </div>
            </div>

            <!-- Character Information Section -->
            <div class="character-section">
                <h4>Character Information</h4>
                <div class="form-group">
                    <label for="characterName">Name:</label>
                    <input type="text" id="characterName" placeholder="Character name">
                </div>
                <div class="form-group">
                    <label for="characterDescription">Description:</label>
                    <textarea id="characterDescription" placeholder="Character description..." rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="characterAge">Age:</label>
                    <input type="text" id="characterAge" placeholder="Character age">
                </div>
                <div class="form-group">
                    <label for="characterPersonality">Personality:</label>
                    <textarea id="characterPersonality" placeholder="Character personality traits..." rows="4"></textarea>
                </div>
            </div>

            <!-- Character Appearance Section -->
            <div class="character-section">
                <h4>Appearance</h4>
                <div class="form-group">
                    <label for="characterAppearance">Physical Description:</label>
                    <textarea id="characterAppearance" placeholder="Physical appearance..." rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="characterOutfit">Outfit:</label>
                    <textarea id="characterOutfit" placeholder="Clothing and style..." rows="2"></textarea>
                </div>
            </div>

            <!-- Character Background Section -->
            <div class="character-section">
                <h4>Background & History</h4>
                <div class="form-group">
                    <label for="characterBackground">Background:</label>
                    <textarea id="characterBackground" placeholder="Character history and background..." rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="characterGoals">Goals & Motivations:</label>
                    <textarea id="characterGoals" placeholder="What drives this character..." rows="3"></textarea>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="character-actions">
                <button class="btn btn-primary" onclick="saveCharacterProfile()">Save Character</button>
                <button class="btn btn-secondary" onclick="exportCharacter()">Export</button>
                <button class="btn btn-secondary" onclick="importCharacter()">Import</button>
            </div>
        </div>
    </div>

    <!-- User Management Panel -->
    <div class="user-management-panel" id="userManagementPanel">
        <div class="user-management-header">
            <span class="user-management-title">User Management</span>
            <div class="window-controls">
                <button class="close-btn" onclick="closeUserManagement()">√ó</button>
            </div>
        </div>
        <div class="user-management-content">
            <!-- User Selection Section -->
            <div class="user-section">
                <h4>User Selection</h4>
                <div class="form-group">
                    <label for="userSelect">Select User:</label>
                    <select id="userSelect" onchange="onUserChange()">
                        <option value="">Select a user...</option>
                    </select>
                </div>
                <div class="user-controls">
                    <button class="btn btn-primary" onclick="createNewUser()">New User</button>
                    <button class="btn btn-secondary" onclick="duplicateUser()">Duplicate</button>
                    <button class="btn btn-warning" onclick="deleteUser()">Delete</button>
                </div>
            </div>

            <!-- Basic Information Section -->
            <div class="user-section">
                <h4>Basic Information</h4>
                <div class="form-group">
                    <label for="userName">Username: *</label>
                    <input type="text" id="userName" placeholder="Username (required)" required>
                </div>
                <div class="form-group">
                    <label for="userDisplayName">Display Name:</label>
                    <input type="text" id="userDisplayName" placeholder="Display name">
                </div>
                <div class="form-group">
                    <label for="userEmail">Email:</label>
                    <input type="email" id="userEmail" placeholder="user@example.com">
                </div>
                <div class="form-group">
                    <label for="userPassword">Password:</label>
                    <input type="password" id="userPassword" placeholder="Enter password">
                </div>
            </div>

            <!-- User Role & Permissions Section -->
            <div class="user-section">
                <h4>Role & Permissions</h4>
                <div class="form-group">
                    <label for="userRole">Role:</label>
                    <select id="userRole">
                        <option value="user">User</option>
                        <option value="moderator">Moderator</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Permissions:</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" id="permissionChat"> Chat Access</label>
                        <label><input type="checkbox" id="permissionDrawing"> Drawing Tools</label>
                        <label><input type="checkbox" id="permissionCharacters"> Character Management</label>
                        <label><input type="checkbox" id="permissionUserMgmt"> User Management</label>
                        <label><input type="checkbox" id="permissionSettings"> System Settings</label>
                    </div>
                </div>
            </div>

            <!-- Demographics Section -->
            <div class="user-section">
                <h4>Demographics</h4>
                <div class="form-group">
                    <label for="userAge">Age Range:</label>
                    <select id="userAge">
                        <option value="under-12">Under 12</option>
                        <option value="12-17">12-17 years</option>
                        <option value="18-24">18-24 years</option>
                        <option value="25-34">25-34 years</option>
                        <option value="35-44">35-44 years</option>
                        <option value="45-54">45-54 years</option>
                        <option value="55-64">55-64 years</option>
                        <option value="65-plus">65+ years</option>
                        <option value="prefer-not-to-say">Prefer not to say</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userGender">Gender:</label>
                    <select id="userGender">
                        <option value="not-specified">Not specified</option>
                        <option value="female">Female</option>
                        <option value="male">Male</option>
                        <option value="non-binary">Non-binary</option>
                        <option value="other">Other</option>
                        <option value="prefer-not-to-say">Prefer not to say</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userLocation">Location:</label>
                    <input type="text" id="userLocation" placeholder="City, Country">
                </div>
            </div>

            <!-- Personal Characteristics Section -->
            <div class="user-section">
                <h4>Personal Characteristics</h4>
                <div class="form-group">
                    <label for="userPersonality">Personality Traits:</label>
                    <textarea id="userPersonality" placeholder="Describe personality traits, communication style, etc..." rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="userInterests">Interests & Hobbies:</label>
                    <textarea id="userInterests" placeholder="What are you interested in? Gaming, art, music, sports, etc..." rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="userLikes">Likes:</label>
                    <textarea id="userLikes" placeholder="Things you enjoy, favorite activities, foods, etc..." rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label for="userDislikes">Dislikes:</label>
                    <textarea id="userDislikes" placeholder="Things you don't enjoy or want to avoid..." rows="2"></textarea>
                </div>
            </div>

            <!-- Communication Preferences Section -->
            <div class="user-section">
                <h4>Communication Preferences</h4>
                <div class="form-group">
                    <label for="userCommunicationStyle">Communication Style:</label>
                    <select id="userCommunicationStyle">
                        <option value="casual">Casual & Friendly</option>
                        <option value="formal">Formal & Professional</option>
                        <option value="playful">Playful & Humorous</option>
                        <option value="direct">Direct & Concise</option>
                        <option value="supportive">Supportive & Encouraging</option>
                        <option value="intellectual">Intellectual & Analytical</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userLanguagePreference">Language Preference:</label>
                    <select id="userLanguagePreference">
                        <option value="en">English</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                        <option value="ja">Japanese</option>
                        <option value="ko">Korean</option>
                        <option value="zh">Chinese</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>

            <!-- Content Preferences Section -->
            <div class="user-section">
                <h4>Content Preferences</h4>
                <div class="form-group">
                    <label>Content Filtering:</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" id="contentNSFW"> Allow NSFW Content</label>
                        <label><input type="checkbox" id="contentMature"> Allow Mature Themes</label>
                        <label><input type="checkbox" id="contentViolence"> Allow Violence</label>
                        <label><input type="checkbox" id="contentProfanity"> Allow Strong Language</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="userContentPreferences">Content Preferences:</label>
                    <textarea id="userContentPreferences" placeholder="What type of content do you prefer? Topics to focus on or avoid..." rows="3"></textarea>
                </div>
            </div>

            <!-- Notes Section -->
            <div class="user-section">
                <h4>Additional Notes</h4>
                <div class="form-group">
                    <label for="userNotes">Admin Notes:</label>
                    <textarea id="userNotes" placeholder="Internal notes about this user..." rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="userBio">Public Bio:</label>
                    <textarea id="userBio" placeholder="Public bio that may be shared with other users..." rows="3"></textarea>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="user-actions">
                <button class="btn btn-primary" onclick="saveUserProfile()">Save User</button>
                <button class="btn btn-secondary" onclick="exportUser()">Export</button>
                <button class="btn btn-secondary" onclick="importUser()">Import</button>
                <button class="btn btn-info" onclick="sendPasswordReset()">Send Password Reset</button>
            </div>

            <!-- Status Message -->
            <div id="userManagementStatus" class="status-message" style="display: none;"></div>
        </div>
    </div>

    <!-- Drawing Panel -->
    <div class="drawing-panel resizable-panel" id="drawingPanel">
        <div class="drawing-header">
            <span class="drawing-title">Drawing Tools</span>
            <div class="window-controls">
                <button class="control-btn" onclick="toggleDrawingResize()" title="Toggle Resize">‚§°</button>
                <button class="close-btn" onclick="closeDrawing()">√ó</button>
            </div>
        </div>
        <div class="drawing-content">
            <!-- Drawing Mode Control -->
            <div class="drawing-section">
                <h4>Drawing Mode</h4>
                <div class="mode-controls">
                    <button class="btn btn-primary" id="toggleDrawingMode" onclick="toggleDrawingMode()" title="Toggle between drawing and Live2D interaction">
                        üé® Enable Drawing Mode
                    </button>
                    <div class="mode-info">
                        <small>Drawing mode disabled - Live2D interaction active</small>
                    </div>
                </div>
            </div>
            
            <!-- Tool Selection Section -->
            <div class="drawing-section">
                <h4>Basic Drawing Tools</h4>
                <div class="tool-grid horizontal">
                    <button class="tool-btn active" onclick="selectTool('pen')" data-tool="pen" title="Pen">‚úèÔ∏è</button>
                    <button class="tool-btn" onclick="selectTool('brush')" data-tool="brush" title="Brush">üñåÔ∏è</button>
                    <button class="tool-btn" onclick="selectTool('pencil')" data-tool="pencil" title="Pencil">‚úé</button>
                    <button class="tool-btn" onclick="selectTool('marker')" data-tool="marker" title="Marker">üñäÔ∏è</button>
                    <button class="tool-btn" onclick="selectTool('eraser')" data-tool="eraser" title="Eraser">üßΩ</button>
                </div>
                
                <h4>Textured Brushes</h4>
                <div class="tool-grid horizontal">
                    <button class="tool-btn" onclick="selectTool('oil')" data-tool="oil" title="Oil Paint">üé®</button>
                    <button class="tool-btn" onclick="selectTool('watercolor')" data-tool="watercolor" title="Watercolor">üíß</button>
                    <button class="tool-btn" onclick="selectTool('chalk')" data-tool="chalk" title="Chalk">‚ö™</button>
                    <button class="tool-btn" onclick="selectTool('charcoal')" data-tool="charcoal" title="Charcoal">‚ö´</button>
                    <button class="tool-btn" onclick="selectTool('spray')" data-tool="spray" title="Spray Paint">üí®</button>
                </div>
                
                <h4>Pattern Brushes</h4>
                <div class="tool-grid horizontal">
                    <button class="tool-btn" onclick="selectTool('stipple')" data-tool="stipple" title="Stipple">‚Ä¢‚Ä¢‚Ä¢</button>
                    <button class="tool-btn" onclick="selectTool('crosshatch')" data-tool="crosshatch" title="Crosshatch">‚öè</button>
                    <button class="tool-btn" onclick="selectTool('fur')" data-tool="fur" title="Fur Texture">ü¶î</button>
                    <button class="tool-btn" onclick="selectTool('grass')" data-tool="grass" title="Grass Texture">ÔøΩ</button>
                </div>
                
                <h4>Calligraphy & Special</h4>
                <div class="tool-grid horizontal">
                    <button class="tool-btn" onclick="selectTool('calligraphy')" data-tool="calligraphy" title="Calligraphy">üñãÔ∏è</button>
                    <button class="tool-btn" onclick="selectTool('clone')" data-tool="clone" title="Clone/Stamp">üìã</button>
                    <button class="tool-btn" onclick="selectTool('smudge')" data-tool="smudge" title="Smudge">üëÜ</button>
                    <button class="tool-btn" onclick="selectTool('blur')" data-tool="blur" title="Blur Effect">üå´Ô∏è</button>
                </div>
            </div>

            <!-- Shape Tools -->
            <div class="drawing-section">
                <h4>Shape Tools</h4>
                <div class="tool-grid horizontal">
                    <button class="tool-btn" onclick="selectTool('line')" data-tool="line" title="Line">üìè</button>
                    <button class="tool-btn" onclick="selectTool('rectangle')" data-tool="rectangle" title="Rectangle">‚¨ú</button>
                    <button class="tool-btn" onclick="selectTool('circle')" data-tool="circle" title="Circle">‚≠ï</button>
                    <button class="tool-btn" onclick="selectTool('ellipse')" data-tool="ellipse" title="Ellipse">‚≠ï</button>
                    <button class="tool-btn" onclick="selectTool('polygon')" data-tool="polygon" title="Polygon">‚¨ü</button>
                    <button class="tool-btn" onclick="selectTool('arrow')" data-tool="arrow" title="Arrow">‚û°Ô∏è</button>
                </div>
            </div>

            <!-- Selection & Transform Tools -->
            <div class="drawing-section">
                <h4>Selection & Transform</h4>
                <div class="tool-grid horizontal">
                    <button class="tool-btn" onclick="selectTool('select')" data-tool="select" title="Rectangle Select">üî≤</button>
                    <button class="tool-btn" onclick="selectTool('ellipse-select')" data-tool="ellipse-select" title="Ellipse Select">‚≠ï</button>
                    <button class="tool-btn" onclick="selectTool('lasso')" data-tool="lasso" title="Lasso Select">ü™¢</button>
                    <button class="tool-btn" onclick="selectTool('magic-wand')" data-tool="magic-wand" title="Magic Wand">ü™Ñ</button>
                    <button class="tool-btn" onclick="selectTool('move')" data-tool="move" title="Move/Transform">‚ÜîÔ∏è</button>
                    <button class="tool-btn" onclick="selectTool('crop')" data-tool="crop" title="Crop Tool">‚úÇÔ∏è</button>
                </div>
                <div class="tool-grid horizontal">
                    <button class="tool-btn" onclick="selectTool('rotate')" data-tool="rotate" title="Rotate">üîÑ</button>
                    <button class="tool-btn" onclick="selectTool('scale')" data-tool="scale" title="Scale">üìê</button>
                    <button class="tool-btn" onclick="selectTool('skew')" data-tool="skew" title="Skew">üìê</button>
                    <button class="tool-btn" onclick="selectTool('perspective')" data-tool="perspective" title="Perspective">üé≠</button>
                    <button class="tool-btn" onclick="selectTool('liquify')" data-tool="liquify" title="Liquify">üåÄ</button>
                    <button class="tool-btn" onclick="selectTool('eyedropper')" data-tool="eyedropper" title="Eyedropper">üíß</button>
                </div>
            </div>

            <!-- Smart Drawing Features -->
            <div class="drawing-section">
                <h4>Smart Drawing</h4>
                <div class="smart-controls">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="stabilizeLines" onchange="toggleStabilization(this.checked)"> 
                            Line Stabilization
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="shapeRecognition" onchange="toggleShapeRecognition(this.checked)"> 
                            Shape Recognition
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="symmetryMode" onchange="toggleSymmetry(this.checked)"> 
                            Symmetry Mode
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="pressureSensitivity" onchange="togglePressure(this.checked)"> 
                            Pressure Sensitivity
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="vectorMode" onchange="toggleVectorMode(this.checked)"> 
                            Vector Mode
                        </label>
                    </div>
                </div>
            </div>

            <!-- AI-Powered Tools -->
            <div class="drawing-section">
                <h4>AI-Powered Tools</h4>
                <div class="ai-controls">
                    <button class="btn btn-primary" onclick="requestAvatarFeedback()" title="Ask avatar for drawing feedback and critique">ü§ñ Get Avatar Feedback</button>
                    <button class="btn btn-secondary" onclick="autoCompleteDrawing()" title="AI suggests completion">‚ú® Auto-Complete</button>
                    <button class="btn btn-secondary" onclick="applyStyleTransfer()" title="Apply artistic styles">üé® Style Transfer</button>
                    <button class="btn btn-secondary" onclick="removeBackground()" title="AI-powered background removal">üóëÔ∏è Remove Background</button>
                    <button class="btn btn-secondary" onclick="smartSelection()" title="AI-assisted object selection">üéØ Smart Select</button>
                    <button class="btn btn-secondary" onclick="generatePoseReference()" title="Generate pose guides">üö∂ Pose Reference</button>
                </div>
                
                <div class="smart-controls">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="autonomous-feedback-toggle" checked>
                            Autonomous Commentary
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="feedback-frequency">Feedback Frequency:</label>
                        <select id="feedback-frequency" class="form-control">
                            <option value="low">Low (25s intervals)</option>
                            <option value="medium" selected>Medium (15s intervals)</option>
                            <option value="high">High (8s intervals)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Color and Size Section -->
            <div class="drawing-section">
                <h4>Color & Size</h4>
                <div class="form-group">
                    <label for="colorPicker">Current Color:</label>
                    <div class="color-picker-row">
                        <input type="color" id="colorPicker" value="#000000" onchange="setDrawingColor(this.value)">
                        <button class="btn btn-mini" onclick="showColorPalette()" title="Show/Hide Color Palette">üé® Palette</button>
                    </div>
                </div>
                <div class="color-history" id="colorHistory">
                    <div class="color-history-label">Recent Colors (click to expand palette):</div>
                    <!-- Recent colors will appear here -->
                </div>
                
                <div class="form-group">
                    <label for="brushSize">Brush Size: <span id="brushSizeValue">5</span>px</label>
                    <input type="range" id="brushSize" min="1" max="100" value="5" oninput="setBrushSize(this.value)" class="slider">
                </div>
                
                <div class="form-group">
                    <label for="opacitySlider">Opacity: <span id="opacityValue">100</span>%</label>
                    <input type="range" id="opacitySlider" min="0" max="100" value="100" oninput="setOpacity(this.value)" class="slider">
                </div>
                
                <div class="form-group">
                    <label for="flowSlider">Flow: <span id="flowValue">100</span>%</label>
                    <input type="range" id="flowSlider" min="1" max="100" value="100" oninput="setFlow(this.value)" class="slider">
                </div>
                
                <div class="form-group">
                    <label for="hardnessSlider">Hardness: <span id="hardnessValue">100</span>%</label>
                    <input type="range" id="hardnessSlider" min="0" max="100" value="100" oninput="setHardness(this.value)" class="slider">
                </div>
                
                <div class="form-group">
                    <label for="spacingSlider">Spacing: <span id="spacingValue">25</span>%</label>
                    <input type="range" id="spacingSlider" min="1" max="300" value="25" oninput="setSpacing(this.value)" class="slider">
                </div>
            </div>

            <!-- Layers Section -->
            <div class="drawing-section">
                <h4>Layers</h4>
                <div class="layers-list" id="layersList">
                    <div class="layer-item active">
                        <span class="layer-name">Background</span>
                        <div class="layer-controls">
                            <button class="layer-btn" onclick="toggleLayerVisibility(0)" title="Toggle Visibility">üëÅÔ∏è</button>
                            <button class="layer-btn" onclick="setLayerBlendMode(0)" title="Blend Mode">üîÄ</button>
                            <button class="layer-btn" onclick="deleteLayer(0)" title="Delete Layer">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
                <div class="layer-controls">
                    <button class="btn btn-secondary" onclick="addNewLayer()">Add Layer</button>
                    <button class="btn btn-secondary" onclick="mergeDown()">Merge Down</button>
                    <button class="btn btn-secondary" onclick="duplicateLayer()">Duplicate</button>
                </div>
            </div>

            <!-- Live2D Integration -->
            <div class="drawing-section">
                <h4>Live2D Integration</h4>
                <div class="live2d-controls">
                    <button class="btn btn-primary" onclick="enableModelTracing()" title="Trace over Live2D model">üìù Model Trace</button>
                    <button class="btn btn-secondary" onclick="captureModelPose()" title="Capture current pose as reference">üì∏ Capture Pose</button>
                    <button class="btn btn-secondary" onclick="toggleModelOutline()" title="Show model outline for reference">üî≤ Show Outline</button>
                    <button class="btn btn-secondary" onclick="recordMotion()" title="Record model movements as guides">üé¨ Record Motion</button>
                </div>
                
                <h4>Live2D Specific Tools</h4>
                <div class="live2d-controls">
                    <button class="btn btn-accent" onclick="costumeDesigner()" title="Draw directly on model as texture overlay">üëó Costume Designer</button>
                    <button class="btn btn-accent" onclick="expressionSketching()" title="Quick emotion sketches over face">üòä Expression Sketch</button>
                    <button class="btn btn-accent" onclick="emotionOverlay()" title="Draw emotions that trigger expressions">üí≠ Emotion Overlay</button>
                    <button class="btn btn-accent" onclick="interactiveAnnotations()" title="Clickable drawings that trigger actions">üìå Interactive Notes</button>
                    <button class="btn btn-accent" onclick="costumePainter()" title="Paint directly onto model textures">üé® Costume Painter</button>
                    <button class="btn btn-accent" onclick="sceneCreator()" title="Draw backgrounds that interact with model">üåÑ Scene Creator</button>
                </div>
            </div>

            <!-- History & Undo -->
            <div class="drawing-section">
                <h4>History & Actions</h4>
                <div class="history-controls">
                    <button class="btn btn-secondary" onclick="undoAction()" title="Undo last action">‚Ü∂ Undo</button>
                    <button class="btn btn-secondary" onclick="redoAction()" title="Redo last undone action">‚Ü∑ Redo</button>
                    <button class="btn btn-secondary" onclick="showHistoryTimeline()" title="Show action timeline">üìã History Panel</button>
                    <button class="btn btn-secondary" onclick="createBranch()" title="Create alternate version">üåø Branch History</button>
                </div>
                <div class="snapshot-controls">
                    <button class="btn btn-primary" onclick="saveSnapshot()" title="Save current state">üì∑ Snapshot</button>
                    <button class="btn btn-secondary" onclick="loadSnapshot()" title="Load saved state">üìÇ Load Snapshot</button>
                    <button class="btn btn-secondary" onclick="compareSnapshots()" title="Compare different states">‚öñÔ∏è Compare</button>
                </div>
                
                <h4>Edit Actions</h4>
                <div class="edit-controls">
                    <button class="btn btn-secondary" onclick="copySelection()" title="Copy selected area">üìã Copy</button>
                    <button class="btn btn-secondary" onclick="pasteSelection()" title="Paste from clipboard">üìÑ Paste</button>
                    <button class="btn btn-secondary" onclick="cutSelection()" title="Cut selected area">‚úÇÔ∏è Cut</button>
                    <button class="btn btn-secondary" onclick="pasteExternal()" title="Paste from external apps">üìã Paste External</button>
                </div>
            </div>

            <!-- Advanced Features -->
            <div class="drawing-section">
                <h4>Story Mode & Visual Novels</h4>
                <div class="story-controls">
                    <button class="btn btn-primary" onclick="enterStoryMode()" title="Create interactive visual novels">üìñ Story Mode</button>
                    <button class="btn btn-secondary" onclick="addDialogueBubble()" title="Add speech bubbles">üí¨ Dialogue Bubble</button>
                    <button class="btn btn-secondary" onclick="addNarrationBox()" title="Add narration text">üìù Narration Box</button>
                    <button class="btn btn-secondary" onclick="createChoicePoint()" title="Add decision points">üîÄ Choice Point</button>
                </div>
            </div>

            <!-- Canvas Controls Section -->
            <div class="drawing-section">
                <h4>Canvas Actions</h4>
                <div class="canvas-info">
                    <p>Drawing canvas overlays the main Live2D area.</p>
                    <p><strong>Usage:</strong> Enable drawing mode above to draw over Live2D models.</p>
                </div>
                <div class="canvas-controls">
                    <button class="btn btn-warning" onclick="clearCanvas()" title="Clear all drawing">üóëÔ∏è Clear Canvas</button>
                    <button class="btn btn-primary" onclick="saveDrawing()" title="Save drawing to gallery">üíæ Save Drawing</button>
                    <button class="btn btn-secondary" onclick="exportPNG()" title="Export as PNG image">üì§ Export PNG</button>
                    <button class="btn btn-secondary" onclick="exportSVG()" title="Export as vector SVG">üì§ Export SVG</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI Feedback Display -->
    <div class="ai-feedback">
        <div class="feedback-header">
            <span>ü§ñ</span> Avatar Feedback
        </div>
        <div class="feedback-text">
            Your AI companion will provide drawing feedback here...
        </div>
    </div>
    
    <!-- History Timeline -->
    <div class="history-timeline">
        <h4 style="margin: 0 0 12px 0; color: #fff; font-size: 14px;">Drawing History</h4>
        <div class="timeline-item current">
            <div class="timeline-icon">üé®</div>
            <div class="timeline-text">Initial canvas</div>
            <div class="timeline-time">Now</div>
        </div>
    </div>

<!-- Load PIXI.js and Live2D libraries in correct order -->
<!-- Step 1: Load PIXI.js 6.5.10 from dist folder -->
<script src="/static/dist/pixi-6.5.10.min.js"></script>

<!-- Step 2: Load EventEmitter compatibility for PIXI v6 -->
<script src="/static/js/eventemitter_preloader_v6.js"></script>

<!-- Step 3: Load Live2D v2 Bundle for Cubism 2.x models -->
<script src="/static/dist/live2d_bundle.js"></script>

<!-- Step 4: Load Cubism 5 Core for modern models -->
<script src="/static/dist/CubismSdkForWeb-5-r.4/Core/live2dcubismcore.min.js"></script>

<!-- Step 6: Verify dual architecture setup -->
<script>
console.log('=== Dual Architecture Verification ===');
console.log('PIXI version:', typeof PIXI !== 'undefined' ? PIXI.VERSION : 'Not loaded');
console.log('EventEmitter available:', typeof EventEmitter !== 'undefined');
console.log('Live2D v2 Bundle loaded:', typeof window.Live2D !== 'undefined');
console.log('Cubism 5 Core loaded:', typeof window.Live2DCubismCore !== 'undefined');

// Debug Live2D v2 Bundle
if (typeof window.Live2D !== 'undefined') {
    console.log('‚úì Live2D v2 Bundle ready for Cubism 2.x models');
    console.log('- window.Live2D:', typeof window.Live2D);
    console.log('- window.Live2DModelWebGL:', typeof window.Live2DModelWebGL);
    console.log('- window.live2dv2:', typeof window.live2dv2);
}

// Debug Cubism 5 Core
if (typeof window.Live2DCubismCore !== 'undefined') {
    console.log('‚úì Cubism 5 Core ready for modern models');
    console.log('- Core version:', window.Live2DCubismCore.Version ? window.Live2DCubismCore.Version.csmGetVersion() : 'unknown');
}

console.log('=== End Verification ===');
</script>

<!-- Step 5: Load pixi-live2d-display (local for offline installation) -->
<script src="/static/dist/pixi-live2d-display-0.4.0.min.js"></script>

<!-- Step 5: Verify Live2D plugin initialization -->
<script>
// AI Companion API Configuration - Dynamic configuration loading
window.ai2d_chat_CONFIG = {
    // Default fallback configuration
    API_BASE_URL: (() => {
        const protocol = window.location.protocol;
        const hostname = window.location.hostname;
        const port = window.location.port;
        
        // Use current protocol and host
        if (port) {
            return `${protocol}//${hostname}:${port}`;
        }
        return `${protocol}//${hostname}`;
    })(),
    
    // Configuration loading status
    _configLoaded: false,
    _configPromise: null
};

// Function to load server configuration dynamically
async function loadServerConfig() {
    if (window.ai2d_chat_CONFIG._configLoaded) {
        return window.ai2d_chat_CONFIG;
    }
    
    if (window.ai2d_chat_CONFIG._configPromise) {
        return window.ai2d_chat_CONFIG._configPromise;
    }
    
    window.ai2d_chat_CONFIG._configPromise = (async () => {
        try {
            console.log('Loading server configuration from API...');
            
            // Try to fetch configuration from the server
            const configResponse = await fetch('/api/system/config');
            if (configResponse.ok) {
                const serverConfig = await configResponse.json();
                
                // Update the configuration
                window.ai2d_chat_CONFIG.API_BASE_URL = serverConfig.server.base_url;
                window.ai2d_chat_CONFIG.serverConfig = serverConfig;
                window.ai2d_chat_CONFIG._configLoaded = true;
                
                console.log('‚úÖ Server configuration loaded successfully:', serverConfig.server.base_url);
                return window.ai2d_chat_CONFIG;
            } else {
                throw new Error(`Config API returned ${configResponse.status}`);
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è Failed to load server config from API, using fallback:', error.message);
            
            // Fallback: use current location as base
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            const port = window.location.port;
            
            window.ai2d_chat_CONFIG.API_BASE_URL = port ? 
                `${protocol}//${hostname}:${port}` : 
                `${protocol}//${hostname}`;
            
            window.ai2d_chat_CONFIG._configLoaded = true;
            
            console.log('Using fallback configuration:', window.ai2d_chat_CONFIG.API_BASE_URL);
            return window.ai2d_chat_CONFIG;
        }
    })();
    
    return window.ai2d_chat_CONFIG._configPromise;
}

// Initialize configuration
console.log('AI Companion API Config (initial):', window.ai2d_chat_CONFIG.API_BASE_URL);
console.log('Protocol detected:', window.location.protocol);

// Helper function for making API calls with proper config loading
window.makeApiCall = async function(endpoint, options = {}) {
    // Ensure config is loaded
    await loadServerConfig();
    
    const url = `${window.ai2d_chat_CONFIG.API_BASE_URL}${endpoint}`;
    console.log(`Making API call to: ${url}`);
    
    return fetch(url, options);
};
</script>

<script>
// Initialize Live2D plugin following Live2D Viewer Web pattern
console.log('Initializing Live2D plugin (Live2D Viewer Web compatible)...');

// Wait for all scripts to load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        console.log('Checking library compatibility...');
        
        // Verify libraries are loaded
        if (typeof PIXI === 'undefined') {
            console.error('PIXI.js not loaded');
            return;
        }
        
        if (typeof EventEmitter === 'undefined') {
            console.error('EventEmitter not available');
            return;
        }
        
        console.log('‚úì PIXI version:', PIXI.VERSION);
        console.log('‚úì EventEmitter type:', typeof EventEmitter);
        
        // Check if PIXI.utils.EventEmitter exists (Live2D Viewer Web pattern)
        if (PIXI.utils && PIXI.utils.EventEmitter) {
            console.log('‚úì PIXI.utils.EventEmitter available (Live2D Viewer Web compatible)');
        }
        
        // Check if Live2D plugin is available
        if (typeof PIXI.live2d === 'undefined') {
            console.error('‚úó PIXI.live2d not loaded - pixi-live2d-display may not be compatible');
            console.log('Available PIXI properties:', Object.keys(PIXI));
            
            // Try to diagnose the issue
            if (window.pixiLive2DLoadError) {
                console.error('Library loading error detected - check network tab');
            }
        } else {
            console.log('‚úì PIXI.live2d loaded successfully');
            console.log('Available PIXI.live2d properties:', Object.keys(PIXI.live2d));
            
            // Check for Live2DModel
            if (PIXI.live2d.Live2DModel) {
                console.log('‚úì Live2DModel class available');
                window.Live2DModel = PIXI.live2d.Live2DModel;
                
                // Test if it has the expected methods
                if (typeof PIXI.live2d.Live2DModel.from === 'function') {
                    console.log('‚úì Live2DModel.from() method available');
                } else {
                    console.warn('Live2DModel.from() method not found');
                }
            } else {
                console.warn('Live2DModel not found in PIXI.live2d');
            }
            
            // Check for Live2DFactory
            if (PIXI.live2d.Live2DFactory) {
                console.log('‚úì Live2DFactory available');
                window.Live2DFactory = PIXI.live2d.Live2DFactory;
            } else {
                console.warn('Live2DFactory not found in PIXI.live2d');
            }
        }
        
        console.log('Live2D plugin initialization check complete');
        console.log('System ready for Live2D model loading');
        
        // NOW INITIALIZE THE LIVE2D SYSTEM
        if (typeof initializeLive2D === 'function') {
            console.log('Starting Live2D modular system initialization...');
            
            // Load server configuration before initializing Live2D
            loadServerConfig().then(() => {
                console.log('Server configuration loaded, initializing Live2D...');
                return initializeLive2D();
            }).then(() => {
                console.log('Live2D system initialization complete!');
            }).catch(error => {
                console.error('Live2D system initialization failed:', error);
            });
        } else {
            console.error('initializeLive2D function not found!');
        }
        
    }, 500); // Increased delay to ensure all libraries are loaded
});
</script>

<!-- Step 5: Load Live2D modular system -->
    
    <script src="/static/js/live2d_modules/live2d_config.js"></script>
    <script src="/static/js/live2d_modules/live2d_core.js"></script>  
    <script src="/static/js/live2d_modules/live2d_core_simple.js"></script>
    <script src="/static/js/live2d_modules/live2d_integration.js"></script>
    <script src="/static/js/live2d_modules/live2d_interaction.js"></script>
    <script src="/static/js/live2d_modules/live2d_logger.js"></script>
    <script src="/static/js/live2d_modules/live2d_model_loader.js"></script>
    <script src="/static/js/live2d_modules/live2d_model_manager.js"></script>
    <script src="/static/js/live2d_modules/live2d_model_import_manager.js"></script>
    <script src="/static/js/live2d_modules/live2d_motion_manager.js"></script>
    <script src="/static/js/live2d_modules/live2d_motions.js"></script>
    <script src="/static/js/live2d_modules/live2d_mouse_interaction.js"></script>    
    <script src="/static/js/live2d_modules/live2d_multi_model_manager.js"></script>    
    <script src="/static/js/live2d_modules/live2d_simple_fix.js"></script>    
    <script src="/static/js/live2d_modules/live2d_tester.js"></script>
    <script src="/static/js/live2d_modules/live2d_ui_controller.js"></script>

    <!-- UI components -->
    <script src="/static/js/ui_modules/ui_drawing_system.js"></script>
    <script src="/static/js/ui_modules/ui_icon_manager.js"></script>     
    <script src="/static/js/ui_modules/ui_people_panel.js"></script>
    <script src="/static/js/ui_modules/ui_panel_manager.js"></script>
    <script src="/static/js/ui_modules/ui_character_profiles.js"></script>
    <script src="/static/js/ui_modules/ui_user_management.js"></script>
    <script src="/static/js/ui_modules/ui_user_selection.js"></script>
    <script src="/static/js/ui_modules/ui_debug_console.js"></script>
    <script src="/static/js/ui_modules/ui_debug_logger.js"></script>

    <!-- Audio Processing -->
    <script src="/static/js/audio_modules/audio_voice_recording.js"></script>
    <script src="/static/js/audio_modules/audio_tts.js"></script> 

    <!-- Additional Functionality -->
    <script src="/static/js/console_logger.js"></script>
    <script src="/static/js/autonomous_avatars.js"></script>
    <script src="/static/js/chat_modules/chat_manager.js"></script>
    <script src="/static/js/chat_modules/chat_character_manager.js"></script>
    <script src="/static/js/live2d_modules/live2d_state_manager.js"></script>
    <script src="/static/js/db_manager.js"></script>
    <script src="/static/js/user_profile.js"></script>
    <script src="/static/js/config_api_helpers.js"></script>

    <!-- Compatibility Functions -->
    <script src="/static/js/compatibility_functions.js"></script>

    <!-- Debug Tools -->
    <!-- <script src="/static/js/debug_model_visibility.js"></script> -->
    <!-- <script src="/static/js/debug_stage_inspection.js"></script> -->

    <!-- Main Initialization System -->
    <script src="/static/js/main_initialization.js"></script>

    <!-- SocketIO for real-time communication -->
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>

<script>
// Global variables for the modular system
window.live2dIntegration = window.live2dIntegration || null;
uiController = null; // Already declared in live2d_model_loader.js
// live2dMultiModelManager is declared in live2d_model_loader.js
// currentModel is declared in live2d_model_loader.js
// pixiApp is declared in live2d_model_loader.js

// Function to update current model reference when active model changes
function updateCurrentModelReference() {
    if (live2dMultiModelManager) {
        const activeModelData = live2dMultiModelManager.getActiveModel();
        console.log('üîç Active model check:', {
            hasActiveModelData: !!activeModelData,
            activeModelDataKeys: activeModelData ? Object.keys(activeModelData) : null,
            hasModel: activeModelData ? !!activeModelData.model : false,
            modelType: activeModelData && activeModelData.model ? typeof activeModelData.model : null,
            modelName: activeModelData ? activeModelData.name : null
        });
        
        if (activeModelData && activeModelData.model) {
            currentModel = activeModelData.model;
            console.log('üîÑ Updated currentModel reference to:', activeModelData.name);
            
            // Update PIXI app reference from integration
            if (window.live2dIntegration && window.live2dIntegration.app) {
                pixiApp = window.live2dIntegration.app;
                console.log('üîÑ Updated pixiApp reference from integration');
            }
            
            // Set up mouse interaction for the new current model (only if not already set up)
            if (currentModel && pixiApp && !currentModel._interactionSetup) {
                setupLive2DMouseInteraction(currentModel);
                currentModel._interactionSetup = true; // Mark as set up to prevent duplicates
            }
            
            return true;
        } else {
            // Try alternative method - get all models and find the active one
            const allModels = live2dMultiModelManager.getAllModels();
            console.log('üîç Trying alternative method - all models:', allModels.length);
            
            for (let modelData of allModels) {
                if (modelData.model && modelData.model.visible) {
                    currentModel = modelData.model;
                    console.log('üîÑ Found visible model:', modelData.name);
                    
                    // Update PIXI app reference
                    if (window.live2dIntegration && window.live2dIntegration.app) {
                        pixiApp = window.live2dIntegration.app;
                    }
                    
                    // Set up mouse interaction (only if not already set up)
                    if (currentModel && pixiApp && !currentModel._interactionSetup) {
                        setupLive2DMouseInteraction(currentModel);
                        currentModel._interactionSetup = true;
                    }
                    
                    return true;
                }
            }
            
            currentModel = null;
            console.log('‚ùå No active model found');
            return false;
        }
    }
    currentModel = null;
    return false;
}

// Initialize the modular Live2D system
async function initializeLive2D() {
    try {
        console.log('Initializing Live2D modular system...');
        
        // Check if modular classes are available, if not use fallback
        if (typeof Live2DIntegration === 'undefined') {
            console.warn('Live2DIntegration class not found, using fallback initialization');
            await initializeFallbackLive2D();
            return;
        }
        
        // Create integration instance
        window.live2dIntegration = new Live2DIntegration();
        
        // Initialize integration (canvas container)
        const success = await window.live2dIntegration.initialize('pixiContainer');
        
        if (!success) {
            throw new Error('Failed to initialize Live2D integration');
        }
        
        // Create UI controller
        uiController = new Live2DUIController(window.live2dIntegration);
        
        // Initialize UI controller
        await uiController.initialize();
        
        // Store reference to multi-model manager for global access
        live2dMultiModelManager = window.live2dIntegration.modelManager;
        
        // Store PIXI app reference from integration.core.app (correct location)
        pixiApp = window.live2dIntegration.core.app;
        
        // CRITICAL: Make globals available to debug console and other scripts
        window.live2dMultiModelManager = live2dMultiModelManager;
        window.uiController = uiController;
        window.pixiApp = pixiApp;
        
        // Additional debug: verify PIXI app is correctly assigned
        console.log('üîç PIXI app assignment check:', {
            'live2dIntegration.app': !!window.live2dIntegration.app,
            'live2dIntegration.core.app': !!window.live2dIntegration.core.app,
            'assigned pixiApp': !!pixiApp,
            'window.pixiApp': !!window.pixiApp
        });
        
        // CRITICAL: Also expose the SDK for debug console
        window.LIVE2DCUBISMCORE = window.Live2DCubismCore;
        
        // CRITICAL: Apply interaction fix immediately after initialization
        console.log('üîß Applying PIXI interaction fix...');
        fixPixiInteractionSystem();
        
        // Set up connection between multi-model manager and UI controller
        live2dMultiModelManager.setUIController(uiController);
        
        // Initialize the People panel with actual loaded models (clear any hardcoded data)
        populatePeopleModels();
        
        console.log('Live2D system initialized successfully!');
        
    } catch (error) {
        console.error('Failed to initialize Live2D system:', error);
        console.log('Attempting fallback initialization...');
        await initializeFallbackLive2D();
    }
}

// Fallback initialization with Direct Mouse Interaction Implementation
async function initializeFallbackLive2D() {
    try {
        console.log('Initializing fallback Live2D system with mouse interaction...');
        
        // Create basic PIXI application
        pixiApp = new PIXI.Application({
            width: window.innerWidth,
            height: window.innerHeight,
            backgroundColor: 0x000000, // Black background instead of blue
            transparent: true,
            antialias: true,
            resolution: window.devicePixelRatio || 1,
            autoDensity: true
        });
        
        // Add canvas to container
        const container = document.getElementById('pixiContainer');
        container.appendChild(pixiApp.view);
        
        // Set up stage interaction (CRITICAL for mouse events)
        pixiApp.stage.interactive = true;
        pixiApp.stage.hitArea = pixiApp.screen;
        
        // Make globals available
        window.pixiApp = pixiApp;
        window.currentModel = null;
        
        console.log('‚úÖ Fallback Live2D system with mouse interaction initialized');
        
        // Set up model info display
        updateModelInfoDisplay('System ready - load a model to test mouse interaction');
        
        // Try to load a test model if available
        await tryLoadTestModel();
        
    } catch (error) {
        console.error('Failed to initialize fallback Live2D system:', error);
        updateModelInfoDisplay('‚ùå Failed to initialize Live2D system');
    }
}

// Try to load a test model for interaction testing
async function tryLoadTestModel() {
    try {
        // This would attempt to load a model from the server
        const response = await fetch('/api/live2d/models');
        if (response.ok) {
            const models = await response.json();
            if (models && models.length > 0) {
                console.log(`Found ${models.length} models available for testing`);
                updateModelInfoDisplay(`Found ${models.length} models - use People panel to load one`);
            }
        }
    } catch (error) {
        console.log('Could not fetch models for testing:', error.message);
        updateModelInfoDisplay('System ready - add models via People panel');
    }
}

// Live2D Viewer Web Mouse Interaction Implementation
function setupLive2DMouseInteraction(model) {
    if (!model || !pixiApp) {
        console.warn('Cannot setup mouse interaction: missing model or PIXI app');
        return;
    }
    
    console.log('üñ±Ô∏è Setting up Live2D Viewer Web mouse interaction for model:', model.internalModel?.settings?.name || 'Unknown');
    
    // Enable interaction on the model (Live2D Viewer Web pattern)
    model.interactive = true;
    model.buttonMode = true;
    
    // Set up dragging variables
    let isDragging = false;
    let dragStart = { x: 0, y: 0 };
    let modelStart = { x: 0, y: 0 };
    
    // Mouse down - start dragging (Live2D Viewer Web pattern)
    model.removeAllListeners('pointerdown'); // Prevent duplicate listeners
    model.on('pointerdown', (event) => {
        isDragging = true;
        const position = event.data.global;
        dragStart.x = position.x;
        dragStart.y = position.y;
        modelStart.x = model.x;
        modelStart.y = model.y;
        
        // Prevent event bubbling
        event.stopPropagation();
        console.log('üñ±Ô∏è Model drag started at:', position);
        
        // Update model info
        updateModelInfoDisplay(`Dragging model from (${Math.round(modelStart.x)}, ${Math.round(modelStart.y)})`);
    });
    
    // Mouse move - drag the model (use app stage for global movement)
    pixiApp.stage.removeAllListeners('pointermove'); // Prevent duplicate listeners
    pixiApp.stage.on('pointermove', (event) => {
        if (!isDragging) return;
        
        const position = event.data.global;
        const deltaX = position.x - dragStart.x;
        const deltaY = position.y - dragStart.y;
        
        model.x = modelStart.x + deltaX;
        model.y = modelStart.y + deltaY;
        
        // Update model info during drag
        updateModelInfoDisplay(`Position: (${Math.round(model.x)}, ${Math.round(model.y)}) Scale: ${model.scale.x.toFixed(2)}`);
    });
    
    // Mouse up - stop dragging
    pixiApp.stage.removeAllListeners('pointerup'); // Prevent duplicate listeners
    pixiApp.stage.on('pointerup', () => {
        if (isDragging) {
            isDragging = false;
            console.log('üñ±Ô∏è Model drag ended at:', { x: model.x, y: model.y });
            updateModelInfoDisplay(`‚úÖ Model positioned at (${Math.round(model.x)}, ${Math.round(model.y)})`);
        }
    });
    
    // Handle mouse leave canvas
    pixiApp.stage.removeAllListeners('pointerupoutside'); // Prevent duplicate listeners
    pixiApp.stage.on('pointerupoutside', () => {
        if (isDragging) {
            isDragging = false;
            console.log('üñ±Ô∏è Model drag ended (outside canvas)');
            updateModelInfoDisplay(`‚úÖ Model positioned at (${Math.round(model.x)}, ${Math.round(model.y)})`);
        }
    });
    
    // Set up mouse wheel scaling (Live2D Viewer Web pattern)
    setupModelScaling(model);
    
    // Set up hit area testing if available
    setupModelHitAreas(model);
    
    console.log('‚úÖ Mouse interaction setup complete for model');
}

// Live2D Viewer Web scaling pattern implementation
function setupModelScaling(model) {
    if (!pixiApp?.view) {
        console.warn('Cannot setup model scaling: no canvas available');
        return;
    }
    
    const canvas = pixiApp.view;
    
    // Remove any existing wheel listeners to prevent duplicates
    const existingHandler = canvas._live2dWheelHandler;
    if (existingHandler) {
        canvas.removeEventListener('wheel', existingHandler);
    }
    
    // Create wheel handler
    function handleModelWheel(event) {
        event.preventDefault();
        
        if (!model || !model.scale) return;
        
        // Use 0.025 increments for wheel scaling
        const scaleIncrement = 0.025;
        const direction = event.deltaY > 0 ? -2 : 2; // Negative for zoom out, positive for zoom in
        const currentScale = model.scale.x;
        const newScale = currentScale + (direction * scaleIncrement);
        
        // Limit scale between 0.1 and 5.0 (Live2D Viewer Web limits)
        if (newScale >= 0.1 && newScale <= 5.0) {
            // Apply to current model
            model.scale.set(newScale);
            
            // Apply to all models in multi-model manager for consistency
            if (window.live2dModelManager?.models) {
                window.live2dModelManager.models.forEach(modelInfo => {
                    if (modelInfo.model && modelInfo.model.scale) {
                        modelInfo.model.scale.set(newScale);
                    }
                });
            }
            
            console.log('üîç Model scaled to:', newScale.toFixed(3));
            
            // Update UI slider if available
            const slider = document.getElementById('zoomSlider');
            const display = document.getElementById('zoomValue');
            if (slider) slider.value = newScale;
            if (display) display.textContent = newScale.toFixed(3);
            
            // Update model info
            updateModelInfoDisplay(`Position: (${Math.round(model.x)}, ${Math.round(model.y)}) Scale: ${newScale.toFixed(3)}`);
        }
    }
    
    // Store handler reference for cleanup
    canvas._live2dWheelHandler = handleModelWheel;
    
    // Add wheel event listener
    canvas.addEventListener('wheel', handleModelWheel, { passive: false });
    
    console.log('üîç Mouse wheel scaling set up for model');
}

// Live2D Viewer Web hit area pattern implementation
function setupModelHitAreas(model) {
    if (!model?.internalModel) {
        console.log('Hit areas not available for this model');
        return;
    }
    
    model.removeAllListeners('pointerdown'); // Remove previous listeners
    model.on('pointerdown', (event) => {
        const point = event.data.global;
        
        // Convert global coordinates to model local coordinates
        const localPoint = model.toLocal(point);
        
        console.log('üéØ Hit test at:', localPoint);
        
        // Test hit areas if available (Live2D Viewer Web pattern)
        if (model.internalModel.hitTest) {
            try {
                const hitAreas = model.internalModel.hitTest(localPoint.x, localPoint.y);
                
                if (hitAreas && hitAreas.length > 0) {
                    console.log('üéØ Hit areas detected:', hitAreas);
                    updateModelInfoDisplay(`üéØ Hit: ${hitAreas.join(', ')}`);
                    
                    // Trigger motions based on hit areas
                    hitAreas.forEach(hitArea => {
                        console.log(`üé≠ Hit area: ${hitArea}`);
                        // Add motion triggers here if needed
                    });
                } else {
                    console.log('üéØ No hit areas at this location');
                }
            } catch (error) {
                console.warn('Hit test failed:', error);
            }
        } else {
            console.log('üéØ Hit testing not available for this model');
        }
    });
}

// Enhanced model loading function with mouse interaction
async function loadLive2DModel(modelPath) {
    try {
        console.log('üé≠ Loading Live2D model from:', modelPath);
        
        if (!pixiApp) {
            throw new Error('PIXI application not available');
        }
        
        updateModelInfoDisplay('Loading model...');
        
        // Clear existing model
        if (currentModel) {
            pixiApp.stage.removeChild(currentModel);
            currentModel.destroy();
            currentModel = null;
        }
        
        // Load new model using Live2D Viewer Web pattern
        currentModel = await Live2DModel.from(modelPath);
        
        if (!currentModel) {
            throw new Error('Failed to create Live2D model');
        }
        
        // Add to stage
        pixiApp.stage.addChild(currentModel);
        
        // Center the model
        currentModel.x = pixiApp.screen.width / 2;
        currentModel.y = pixiApp.screen.height / 2;
        
        // Set initial scale
        currentModel.scale.set(0.3);
        
        // CRITICAL: Enable mouse interactions using Live2D Viewer Web patterns
        setupLive2DMouseInteraction(currentModel);
        
        // Store globally
        window.currentModel = currentModel;
        
        console.log('‚úÖ Model loaded successfully with mouse interaction:', currentModel);
        
        // Update model info display
        const modelName = currentModel.internalModel?.settings?.name || 'Unknown Model';
        updateModelInfoDisplay(`‚úÖ ${modelName} loaded - drag to move, scroll to scale`);
        
        return currentModel;
        
    } catch (error) {
        console.error('‚ùå Error loading model:', error);
        updateModelInfoDisplay(`‚ùå Failed to load model: ${error.message}`);
        throw error;
    }
}
    // Single DOMContentLoaded event listener with backup pattern
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('üöÄ Starting AI Companion with BACKUP initialization pattern...');
        
        // Add delay to ensure all scripts are loaded
        setTimeout(async function() {
            try {
                // Set up layout management
                if (typeof setupLayoutManagement === 'function') {
                    setupLayoutManagement();
                }
                
                // Load server configuration if available
                if (typeof loadServerConfig === 'function') {
                    await loadServerConfig();
                    console.log('‚úì Server configuration loaded');
                }
                
                // CRITICAL: Initialize Live2D FIRST before other systems
                const live2dSuccess = await initializeLive2D();
                
                if (!live2dSuccess) {
                    console.error('‚ùå Live2D initialization failed - other systems may not work properly');
                } else {
                    console.log('‚úÖ Live2D system ready for other components');
                }
                
                // Initialize other systems AFTER Live2D is ready
                if (typeof initializeAICompanion === 'function') {
                    const initialized = await initializeAICompanion();
                    
                    if (initialized) {
                        console.log('‚úÖ AI Companion initialization complete!');
                        
                        // Report status
                        setTimeout(() => {
                            if (typeof reportInitializationStatus === 'function') {
                                reportInitializationStatus();
                            }
                        }, 2000);
                    }
                } else {
                    console.log('‚úÖ Backup initialization pattern complete!');
                }
                
            } catch (error) {
                console.error('‚ùå Critical initialization error:', error);
                if (typeof reportInitializationStatus === 'function') {
                    reportInitializationStatus();
                }
            }
        }, 500); // Delay to ensure script loading
    });
    
    // State import handler
    function handleStateImport(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            if (window.live2dStateManager) {
                window.live2dStateManager.importState(file).then(success => {
                    if (success) {
                        alert('Live2D state imported successfully!');
                    } else {
                        alert('Failed to import Live2D state. Please check the file format.');
                    }
                    input.value = ''; // Clear the input
                });
            } else {
                alert('Live2D State Manager not available.');
                input.value = '';
            }
        }
    }
    
    // Background Image Management System
    class BackgroundImageManager {
        constructor() {
            this.storageKey = 'ai2d_chat_background_image';
            this.settingsKey = 'ai2d_chat_background_settings';
            this.backgroundElement = null;
            this.currentSettings = {
                opacity: 100,
                scale: 100,
                position: 'center'
            };
            this.initialize();
        }
        
        initialize() {
            this.createBackgroundElement();
            this.loadSavedBackground();
            this.loadSavedSettings();
        }
        
        createBackgroundElement() {
            // Create background element if it doesn't exist
            if (!this.backgroundElement) {
                this.backgroundElement = document.createElement('div');
                this.backgroundElement.id = 'canvasBackground';
                this.backgroundElement.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-size: cover;
                    background-position: center;
                    background-repeat: no-repeat;
                    z-index: -1;
                    pointer-events: none;
                `;
                
                // Insert into canvas container
                const canvasFrame = document.querySelector('.canvas-frame');
                if (canvasFrame) {
                    canvasFrame.insertBefore(this.backgroundElement, canvasFrame.firstChild);
                }
            }
        }
        
        async setBackgroundImage(file) {
            if (!file || !file.type.startsWith('image/')) {
                console.error('Invalid file type. Please select an image.');
                return false;
            }
            
            try {
                // Convert file to base64 for storage
                const base64 = await this.fileToBase64(file);
                
                // Store in localStorage
                localStorage.setItem(this.storageKey, base64);
                
                // Apply background
                this.applyBackground(base64);
                
                console.log('Background image saved and applied successfully');
                return true;
            } catch (error) {
                console.error('Error setting background image:', error);
                return false;
            }
        }
        
        fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        applyBackground(base64Data) {
            if (this.backgroundElement && base64Data) {
                this.backgroundElement.style.backgroundImage = `url(${base64Data})`;
                this.updateBackgroundStyle();
            }
        }
        
        updateBackgroundStyle() {
            if (!this.backgroundElement) return;
            
            const { opacity, scale, position } = this.currentSettings;
            
            this.backgroundElement.style.opacity = opacity / 100;
            this.backgroundElement.style.transform = `scale(${scale / 100})`;
            
            // Handle different position options
            switch (position) {
                case 'cover':
                    this.backgroundElement.style.backgroundSize = 'cover';
                    this.backgroundElement.style.backgroundPosition = 'center';
                    break;
                case 'contain':
                    this.backgroundElement.style.backgroundSize = 'contain';
                    this.backgroundElement.style.backgroundPosition = 'center';
                    break;
                case 'center':
                    this.backgroundElement.style.backgroundSize = 'cover';
                    this.backgroundElement.style.backgroundPosition = 'center';
                    break;
                case 'top':
                    this.backgroundElement.style.backgroundSize = 'cover';
                    this.backgroundElement.style.backgroundPosition = 'top';
                    break;
                case 'bottom':
                    this.backgroundElement.style.backgroundSize = 'cover';
                    this.backgroundElement.style.backgroundPosition = 'bottom';
                    break;
                case 'left':
                    this.backgroundElement.style.backgroundSize = 'cover';
                    this.backgroundElement.style.backgroundPosition = 'left';
                    break;
                case 'right':
                    this.backgroundElement.style.backgroundSize = 'cover';
                    this.backgroundElement.style.backgroundPosition = 'right';
                    break;
            }
        }
        
        loadSavedBackground() {
            const savedBackground = localStorage.getItem(this.storageKey);
            if (savedBackground) {
                this.applyBackground(savedBackground);
            }
        }
        
        loadSavedSettings() {
            const savedSettings = localStorage.getItem(this.settingsKey);
            if (savedSettings) {
                try {
                    this.currentSettings = { ...this.currentSettings, ...JSON.parse(savedSettings) };
                    this.updateUIControls();
                    this.updateBackgroundStyle();
                } catch (error) {
                    console.error('Error loading background settings:', error);
                }
            }
        }
        
        saveSettings() {
            localStorage.setItem(this.settingsKey, JSON.stringify(this.currentSettings));
        }
        
        updateUIControls() {
            const opacitySlider = document.getElementById('backgroundOpacity');
            const scaleSlider = document.getElementById('backgroundScale');
            const positionSelect = document.getElementById('backgroundPosition');
            const opacityValue = document.getElementById('backgroundOpacityValue');
            const scaleValue = document.getElementById('backgroundScaleValue');
            
            if (opacitySlider) {
                opacitySlider.value = this.currentSettings.opacity;
                if (opacityValue) opacityValue.textContent = this.currentSettings.opacity;
            }
            if (scaleSlider) {
                scaleSlider.value = this.currentSettings.scale;
                if (scaleValue) scaleValue.textContent = this.currentSettings.scale;
            }
            if (positionSelect) {
                positionSelect.value = this.currentSettings.position;
            }
        }
        
        updateOpacity(value) {
            this.currentSettings.opacity = parseInt(value);
            this.updateBackgroundStyle();
            this.saveSettings();
            
            const opacityValue = document.getElementById('backgroundOpacityValue');
            if (opacityValue) opacityValue.textContent = value;
        }
        
        updateScale(value) {
            this.currentSettings.scale = parseInt(value);
            this.updateBackgroundStyle();
            this.saveSettings();
            
            const scaleValue = document.getElementById('backgroundScaleValue');
            if (scaleValue) scaleValue.textContent = value;
        }
        
        updatePosition(value) {
            this.currentSettings.position = value;
            this.updateBackgroundStyle();
            this.saveSettings();
        }
        
        clearBackground() {
            localStorage.removeItem(this.storageKey);
            if (this.backgroundElement) {
                this.backgroundElement.style.backgroundImage = 'none';
            }
            console.log('Background image cleared');
        }
        
        showPreview() {
            const savedBackground = localStorage.getItem(this.storageKey);
            if (savedBackground) {
                // Create a preview window
                const preview = window.open('', 'Background Preview', 'width=800,height=600');
                if (preview) {
                    preview.document.write(`
                        <html>
                            <head><title>Background Preview</title></head>
                            <body style="margin:0; background-image:url(${savedBackground}); background-size:cover; background-position:center;">
                                <div style="position:fixed; top:10px; right:10px; background:rgba(0,0,0,0.7); color:white; padding:10px; border-radius:5px;">
                                    Background Preview<br>
                                    <button onclick="window.close()" style="margin-top:5px;">Close</button>
                                </div>
                            </body>
                        </html>
                    `);
                }
            } else {
                alert('No background image is currently set.');
            }
        }
    }
    
    // Initialize background manager
    let backgroundManager;
    document.addEventListener('DOMContentLoaded', () => {
        // Wait a bit for the DOM to be fully ready
        setTimeout(() => {
            backgroundManager = new BackgroundImageManager();
        }, 1000);
    });
    
    // Global functions for HTML handlers
    function handleBackgroundImageUpload(input) {
        if (input.files && input.files[0] && backgroundManager) {
            backgroundManager.setBackgroundImage(input.files[0]).then(success => {
                if (success) {
                    console.log('Background image uploaded successfully');
                } else {
                    alert('Failed to upload background image. Please try again.');
                }
                input.value = ''; // Clear the input
            });
        }
    }
    
    function updateBackgroundOpacity(value) {
        if (backgroundManager) {
            backgroundManager.updateOpacity(value);
        }
    }
    
    function updateBackgroundScale(value) {
        if (backgroundManager) {
            backgroundManager.updateScale(value);
        }
    }
    
    function updateBackgroundPosition(value) {
        if (backgroundManager) {
            backgroundManager.updatePosition(value);
        }
    }
    
    function clearBackgroundImage() {
        if (backgroundManager) {
            backgroundManager.clearBackground();
            // Reset UI controls
            const opacitySlider = document.getElementById('backgroundOpacity');
            const scaleSlider = document.getElementById('backgroundScale');
            const positionSelect = document.getElementById('backgroundPosition');
            
            if (opacitySlider) opacitySlider.value = 100;
            if (scaleSlider) scaleSlider.value = 100;
            if (positionSelect) positionSelect.value = 'center';
            
            document.getElementById('backgroundOpacityValue').textContent = '100';
            document.getElementById('backgroundScaleValue').textContent = '100';
        }
    }
    
    function showBackgroundPreview() {
        if (backgroundManager) {
            backgroundManager.showPreview();
        }
    }
    
    // Live2D Model Zoom Controls
    function updateZoom(value) {
        const scale = parseFloat(value);
        
        // Apply to all models in the multi-model manager
        if (window.live2dModelManager?.models) {
            window.live2dModelManager.models.forEach(modelInfo => {
                if (modelInfo.model && modelInfo.model.scale) {
                    modelInfo.model.scale.set(scale);
                    console.log(`üîç Model "${modelInfo.name}" scaled to: ${scale}`);
                }
            });
        }
        
        // Update the display value
        const display = document.getElementById('zoomValue');
        if (display) {
            display.textContent = scale.toFixed(3);
        }
        
        console.log('üîç Zoom updated to:', scale);
    }
    
    function resetZoom() {
        const zoomSlider = document.getElementById('zoomSlider');
        const zoomValue = document.getElementById('zoomValue');
        
        if (zoomSlider) {
            zoomSlider.value = 1.0;
            updateZoom(1.0);
        }
        
        if (zoomValue) {
            zoomValue.textContent = '1.0';
        }
        
        console.log('üîç Zoom reset to 1.0');
    }
    
    function fitModel() {
        if (!pixiApp || !window.live2dModelManager?.models?.length) {
            console.warn('No models available to fit');
            return;
        }
        
        // Get the first model for fitting calculations
        const firstModel = window.live2dModelManager.models[0].model;
        if (!firstModel) return;
        
        // Calculate scale to fit model to canvas
        const canvasWidth = pixiApp.view.width;
        const canvasHeight = pixiApp.view.height;
        const modelBounds = firstModel.getBounds();
        
        if (modelBounds.width === 0 || modelBounds.height === 0) {
            console.warn('Model bounds are zero, cannot fit model');
            return;
        }
        
        const scaleX = (canvasWidth * 0.8) / modelBounds.width;
        const scaleY = (canvasHeight * 0.8) / modelBounds.height;
        const fitScale = Math.min(scaleX, scaleY);
        
        // Apply fit scale to all models
        window.live2dModelManager.models.forEach(modelInfo => {
            if (modelInfo.model && modelInfo.model.scale) {
                modelInfo.model.scale.set(fitScale);
            }
        });
        
        // Update UI
        const zoomSlider = document.getElementById('zoomSlider');
        const zoomValue = document.getElementById('zoomValue');
        
        if (zoomSlider) zoomSlider.value = fitScale;
        if (zoomValue) zoomValue.textContent = fitScale.toFixed(3);
        
        console.log('üîç Model fitted to canvas with scale:', fitScale.toFixed(3));
    }
    
    function centerModel() {
        if (!pixiApp || !window.live2dModelManager?.models?.length) {
            console.warn('No models available to center');
            return;
        }
        
        const canvasWidth = pixiApp.view.width;
        const canvasHeight = pixiApp.view.height;
        
        // Center all models
        window.live2dModelManager.models.forEach(modelInfo => {
            if (modelInfo.model) {
                modelInfo.model.x = canvasWidth / 2;
                modelInfo.model.y = canvasHeight / 2;
                console.log(`üìç Model "${modelInfo.name}" centered at (${modelInfo.model.x}, ${modelInfo.model.y})`);
            }
        });
        
        console.log('üìç All models centered');
    }
    
    // UI Panel Management Functions
    function openChat() {
        const chatWindow = document.getElementById('chatWindow');
        if (chatWindow) {
            chatWindow.style.display = 'block';
            chatWindow.classList.add('open');
            console.log('Chat window opened');
        }
    }
    
    function closeChat() {
        const chatWindow = document.getElementById('chatWindow');
        if (chatWindow) {
            chatWindow.classList.remove('open');
            setTimeout(() => {
                chatWindow.style.display = 'none';
            }, 300);
            console.log('Chat window closed');
        }
    }
    
    function openSettings() {
        const settingsPanel = document.getElementById('settingsPanel');
        if (settingsPanel) {
            settingsPanel.style.display = 'block';
            settingsPanel.classList.add('open');
            console.log('Settings panel opened');
        }
    }
    
    function closeSettings() {
        const settingsPanel = document.getElementById('settingsPanel');
        if (settingsPanel) {
            settingsPanel.classList.remove('open');
            setTimeout(() => {
                settingsPanel.style.display = 'none';
            }, 300);
            console.log('Settings panel closed');
        }
    }
    
    function openCharacterProfiles() {
        const characterPanel = document.getElementById('characterProfilesPanel');
        if (characterPanel) {
            characterPanel.style.display = 'block';
            characterPanel.classList.add('open');
            loadCharactersForProfiles();
            console.log('Character profiles panel opened');
        }
    }
    
    function closeCharacterProfiles() {
        const characterPanel = document.getElementById('characterProfilesPanel');
        if (characterPanel) {
            characterPanel.classList.remove('open');
            setTimeout(() => {
                characterPanel.style.display = 'none';
            }, 300);
            console.log('Character profiles panel closed');
        }
    }
    
    function openUserManagement() {
        const userPanel = document.getElementById('userManagementPanel');
        if (userPanel) {
            userPanel.style.display = 'block';
            userPanel.classList.add('open');
            loadUsersForManagement();
            console.log('User management panel opened');
        }
    }
    
    function closeUserManagement() {
        const userPanel = document.getElementById('userManagementPanel');
        if (userPanel) {
            userPanel.classList.remove('open');
            setTimeout(() => {
                userPanel.style.display = 'none';
            }, 300);
            console.log('User management panel closed');
        }
    }
    
    function openDrawing() {
        console.log('Drawing tools not yet implemented');
        // TODO: Implement drawing tools interface
    }
    
    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
        } else {
            document.exitFullscreen();
        }
    }
    
    // Character Management Functions
    function loadCharactersForProfiles() {
        fetch('/api/live2d/models')
            .then(response => response.json())
            .then(data => {
                const characterSelect = document.getElementById('characterSelect');
                if (characterSelect && data.success) {
                    characterSelect.innerHTML = '<option value="">Select a character...</option>';
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.model_name;
                        option.textContent = model.model_name;
                        characterSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Failed to load characters:', error);
            });
    }
    
    function onCharacterChange() {
        const characterSelect = document.getElementById('characterSelect');
        const modelName = characterSelect.value;
        
        if (modelName) {
            loadCharacterData(modelName);
        } else {
            clearCharacterForm();
        }
    }
    
    function loadCharacterData(modelName) {
        fetch(`/api/live2d/models/${modelName}/character`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.character) {
                    populateCharacterForm(data.character);
                } else {
                    console.warn('No character data found for model:', modelName);
                    clearCharacterForm();
                }
            })
            .catch(error => {
                console.error('Failed to load character data:', error);
                clearCharacterForm();
            });
    }
    
    function populateCharacterForm(character) {
        document.getElementById('characterName').value = character.name || '';
        document.getElementById('characterDescription').value = character.description || '';
        document.getElementById('characterAge').value = character.age || '';
        document.getElementById('characterPersonality').value = character.personality_notes || '';
        document.getElementById('characterAppearance').value = character.appearance_notes || '';
        document.getElementById('characterOutfit').value = character.appearance_notes || '';
        document.getElementById('characterBackground').value = character.background_story || '';
        document.getElementById('characterGoals').value = character.favorite_things || '';
    }
    
    function clearCharacterForm() {
        document.getElementById('characterName').value = '';
        document.getElementById('characterDescription').value = '';
        document.getElementById('characterAge').value = '';
        document.getElementById('characterPersonality').value = '';
        document.getElementById('characterAppearance').value = '';
        document.getElementById('characterOutfit').value = '';
        document.getElementById('characterBackground').value = '';
        document.getElementById('characterGoals').value = '';
    }
    
    function saveCharacterProfile() {
        const characterSelect = document.getElementById('characterSelect');
        const modelName = characterSelect.value;
        
        if (!modelName) {
            alert('Please select a character first');
            return;
        }
        
        const characterData = {
            name: document.getElementById('characterName').value,
            description: document.getElementById('characterDescription').value,
            personality_notes: document.getElementById('characterPersonality').value,
            appearance_notes: document.getElementById('characterAppearance').value,
            background_story: document.getElementById('characterBackground').value,
            favorite_things: document.getElementById('characterGoals').value
        };
        
        fetch(`/api/live2d/models/${modelName}/character`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(characterData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Character profile saved successfully!');
            } else {
                alert('Failed to save character profile: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error saving character profile:', error);
            alert('Failed to save character profile');
        });
    }
    
    function createNewCharacter() {
        const modelName = prompt('Enter model name for new character:');
        if (modelName) {
            const characterData = {
                name: modelName.charAt(0).toUpperCase() + modelName.slice(1),
                description: 'New character',
                personality_notes: 'Friendly and helpful',
                appearance_notes: 'Virtual companion',
                background_story: `A new AI companion named ${modelName}`,
                favorite_things: 'Helping users, learning new things'
            };
            
            fetch(`/api/live2d/models/${modelName}/character`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(characterData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Character created successfully!');
                    loadCharactersForProfiles();
                } else {
                    alert('Failed to create character: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error creating character:', error);
                alert('Failed to create character');
            });
        }
    }
    
    function duplicateCharacter() {
        const characterSelect = document.getElementById('characterSelect');
        const modelName = characterSelect.value;
        
        if (!modelName) {
            alert('Please select a character to duplicate');
            return;
        }
        
        const newName = prompt('Enter name for duplicated character:');
        if (newName) {
            // Get current character data and create new one
            fetch(`/api/live2d/models/${modelName}/character`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.character) {
                        const duplicatedData = {
                            ...data.character,
                            name: newName.charAt(0).toUpperCase() + newName.slice(1)
                        };
                        
                        return fetch(`/api/live2d/models/${newName}/character`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(duplicatedData)
                        });
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Character duplicated successfully!');
                        loadCharactersForProfiles();
                    } else {
                        alert('Failed to duplicate character: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error duplicating character:', error);
                    alert('Failed to duplicate character');
                });
        }
    }
    
    function deleteCharacter() {
        const characterSelect = document.getElementById('characterSelect');
        const modelName = characterSelect.value;
        
        if (!modelName) {
            alert('Please select a character to delete');
            return;
        }
        
        if (confirm(`Are you sure you want to delete the character "${modelName}"?`)) {
            fetch(`/api/live2d/models/${modelName}/character`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Character deleted successfully!');
                    loadCharactersForProfiles();
                    clearCharacterForm();
                } else {
                    alert('Failed to delete character: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error deleting character:', error);
                alert('Failed to delete character');
            });
        }
    }
    
    function exportCharacter() {
        const characterSelect = document.getElementById('characterSelect');
        const modelName = characterSelect.value;
        
        if (!modelName) {
            alert('Please select a character to export');
            return;
        }
        
        fetch(`/api/live2d/models/${modelName}/character`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.character) {
                    const dataStr = JSON.stringify(data.character, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${modelName}_character.json`;
                    link.click();
                    URL.revokeObjectURL(url);
                } else {
                    alert('Failed to export character: No character data found');
                }
            })
            .catch(error => {
                console.error('Error exporting character:', error);
                alert('Failed to export character');
            });
    }
    
    function importCharacter() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const characterData = JSON.parse(e.target.result);
                        const modelName = prompt('Enter model name for imported character:', characterData.name || 'imported_character');
                        
                        if (modelName) {
                            fetch(`/api/live2d/models/${modelName}/character`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(characterData)
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    alert('Character imported successfully!');
                                    loadCharactersForProfiles();
                                } else {
                                    alert('Failed to import character: ' + (data.error || 'Unknown error'));
                                }
                            })
                            .catch(error => {
                                console.error('Error importing character:', error);
                                alert('Failed to import character');
                            });
                        }
                    } catch (error) {
                        alert('Invalid JSON file');
                    }
                };
                reader.readAsText(file);
            }
        };
        input.click();
    }

    // Debug function to test chat functionality
    function testChatMessage() {
        console.log('Testing chat message functionality...');
        
        // Ensure chat window is open
        if (window.openChat) {
            window.openChat();
        }
        
        // Test adding a message using the chat manager
        if (typeof addMessage === 'function') {
            // addMessage('system', 'Chat system test message - if you can see this, the chat is working!', 'info');
            console.log('‚úÖ Test message function available (test message disabled)');
        } else {
            console.error('‚ùå addMessage function not available');
        }
    }
    
    // Auto-test chat functionality after page load
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            // testChatMessage(); // Disabled automatic test message
        }, 2000);
        
        // Test model dialog functions after a delay to ensure all scripts are loaded
        setTimeout(() => {
            console.log('Testing model dialog functions...');
            console.log('showAddModelDialog available:', typeof window.showAddModelDialog);
            console.log('closeAddModelDialog available:', typeof window.closeAddModelDialog);
            
            if (typeof window.showAddModelDialog !== 'function') {
                console.error('‚ùå showAddModelDialog function not available - adding fallback');
                window.showAddModelDialog = function() {
                    console.log('Fallback showAddModelDialog called');
                    var dialog = document.getElementById('modelSelectionDialog');
                    if (dialog) {
                        dialog.style.display = 'block';
                        dialog.classList.add('open');
                        console.log('Model selection dialog opened via fallback');
                    } else {
                        console.error('Model selection dialog element not found');
                    }
                };
            }
            
            if (typeof window.closeAddModelDialog !== 'function') {
                console.error('‚ùå closeAddModelDialog function not available - adding fallback');
                window.closeAddModelDialog = function() {
                    console.log('Fallback closeAddModelDialog called');
                    var dialog = document.getElementById('modelSelectionDialog');
                    if (dialog) {
                        dialog.classList.remove('open');
                        setTimeout(() => {
                            dialog.style.display = 'none';
                        }, 300);
                        console.log('Model selection dialog closed via fallback');
                    }
                };
            }
        }, 3000);
    });
    
    // Model Management Functions for Settings Panel - Using Live2D Module
    // All model management functions are now handled by live2d_model_import_manager.js
    
    // Override window.openSettings to initialize model lists
    const originalOpenSettings = window.openSettings;
    window.openSettings = function() {
        if (originalOpenSettings) {
            originalOpenSettings();
        } else {
            const panel = document.getElementById('settingsPanel');
            if (panel) {
                panel.classList.add('open');
            }
        }
        
        // Load model lists when settings panel opens
        if (window.loadExistingModelsForSettings) {
            window.loadExistingModelsForSettings();
        }
        if (window.loadCanvasModelsForSettings) {
            window.loadCanvasModelsForSettings();
        }
    };
    
    // Handle file upload for ZIP models
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('canvasModelFileInput');
        if (fileInput) {
            fileInput.addEventListener('change', function(e) {
                const files = e.target.files;
                if (files.length > 0) {
                    for (let file of files) {
                        if (file.name.endsWith('.zip')) {
                            // Use module function for ZIP upload
                            if (window.uploadModelZip) {
                                window.uploadModelZip(file);
                            }
                        } else {
                            if (window.live2dModelImportManager) {
                                window.live2dModelImportManager.showToast('Please select ZIP files only', 'warning');
                            }
                        }
                    }
                }
            });
        }
    });
    
    // Test function for debugging the model dialog
    window.testModelDialog = function() {
        console.log('=== Model Dialog Test ===');
        console.log('1. Dialog element exists:', !!document.getElementById('modelSelectionDialog'));
        console.log('2. Add button exists:', !!document.querySelector('.add-character-btn'));
        console.log('3. showAddModelDialog function:', typeof window.showAddModelDialog);
        console.log('4. closeAddModelDialog function:', typeof window.closeAddModelDialog);
        console.log('5. loadAvailableModelsForDialog function:', typeof window.loadAvailableModelsForDialog);
        
        if (typeof window.showAddModelDialog === 'function') {
            console.log('6. Attempting to open dialog...');
            window.showAddModelDialog();
            
            setTimeout(() => {
                const dialog = document.getElementById('modelSelectionDialog');
                const isVisible = dialog && (
                    dialog.style.display === 'block' || 
                    dialog.style.display === 'flex' ||
                    dialog.classList.contains('open')
                );
                console.log('7. Dialog visible after call:', isVisible);
                console.log('8. Dialog display style:', dialog ? dialog.style.display : 'N/A');
                console.log('9. Dialog has open class:', dialog ? dialog.classList.contains('open') : 'N/A');
                console.log('=== End Test ===');
            }, 100);
        } else {
            console.error('6. showAddModelDialog function not available!');
        }
    };
    </script>

</body>
</html>
