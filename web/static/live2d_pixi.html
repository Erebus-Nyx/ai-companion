<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live2D AI Companion - Dual Architecture Testing Interface</title>
    <link rel="stylesheet" href="/static/css/live2d_test.css">
</head>
<body>
    <div class="app-container">
        <!-- Navigation Icons (Top Right) -->
        <nav class="nav-icons" id="navIcons">
            <button class="nav-icon" onclick="openChat()" title="Chat" data-tooltip="Chat">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                </svg>
            </button>
            <button class="nav-icon" onclick="openPeople()" title="People" data-tooltip="People">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
            </button>
            <button class="nav-icon" onclick="openSettings()" title="Settings" data-tooltip="Settings">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"/>
                </svg>
            </button>
            <button class="nav-icon" onclick="openCharacterSheet()" title="Character Sheets" data-tooltip="Character Sheets">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
                    <path d="M8 12h8"/>
                    <path d="M8 16h6"/>
                </svg>
            </button>
            <button class="nav-icon" onclick="openDrawing()" title="Drawing" data-tooltip="Drawing">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                    <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                    <path d="M2 2l7.586 7.586"/>
                    <circle cx="11" cy="11" r="2"/>
                </svg>
            </button>
            <div class="nav-divider"></div>
            <button class="nav-icon" onclick="toggleDebugConsole()" title="Debug Console" data-tooltip="Debug">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 12l2 2 4-4"/>
                    <path d="M21 12c.552 0 1-.448 1-1V5c0-.552-.448-1-1-1H3c-.552 0-1 .448-1 1v6c0 .552.448 1 1 1"/>
                </svg>
            </button>
            <div class="nav-divider"></div>
            <button class="nav-icon" onclick="toggleFullscreen()" title="Fullscreen" data-tooltip="Fullscreen">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                </svg>
            </button>
            <button class="nav-icon" onclick="toggleHelp()" title="Help" data-tooltip="Help">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                    <point cx="12" cy="17"/>
                </svg>
            </button>
        </nav>
        
        <!-- Chat Window -->
        <div class="chat-window" id="chatWindow">
            <div class="chat-header">
                <span class="chat-title">Chat</span>
                <div class="chat-history-controls">
                    <button class="history-btn" onclick="refreshChatHistory()" title="Refresh History">üîÑ</button>
                    <button class="history-btn" onclick="clearChatHistory()" title="Clear History">üóëÔ∏è</button>
                    <button class="history-btn" onclick="exportChatHistory()" title="Export History">üì•</button>
                </div>
                <div class="window-controls">
                    <button class="control-btn" onclick="toggleChatSnap()" title="Toggle Snap">üìå</button>
                    <button class="close-btn" onclick="closeChat()">√ó</button>
                </div>
            </div>
            <div class="chat-content">
                <div class="chat-messages" id="chatMessages">
                    <!-- Chat messages will be populated here -->
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="user-input" placeholder="Type a message..." onkeypress="handleChatKeyPress(event)">
                    <button class="send-btn" onclick="sendMessage()">Send</button>
                    <button class="voice-btn" id="voiceButton" onclick="toggleVoiceRecording()" title="Voice Recording">üé§</button>
                </div>
            </div>
        </div>
        
        <!-- People Panel (Right Side) -->
        <div class="people-panel" id="peoplePanel">
            <div class="people-header">
                <span class="people-title">People</span>
                <div class="window-controls">
                    <button class="control-btn" onclick="togglePeopleSnap()" title="Toggle Snap">üìå</button>
                    <button class="close-btn" onclick="closePeople()">√ó</button>
                </div>
            </div>
            <div class="people-content">
                <div class="people-models-list" id="peopleModelsList">
                    <!-- Model icons will be populated here vertically -->
                </div>
                <div class="people-controls">
                    <button class="add-model-btn" onclick="showAddModelDialog()" title="Add new model">
                        <span class="add-icon">+</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Settings Panel (Left Side Overlay) -->
        <div class="settings-panel" id="settingsPanel">
            <div class="settings-header">
                <span class="settings-title">Live2D Settings</span>
                <div class="window-controls">
                    <button class="control-btn" onclick="toggleSettingsSnap()" title="Toggle Snap">üìå</button>
                    <button class="close-btn" onclick="closeSettings()">√ó</button>
                </div>
            </div>
            <div class="settings-content">
                <div class="settings-group">
                    <h4>Model Selection</h4>
                    <div class="setting-item">
                        <label for="modelSelect">Model:</label>
                        <select id="modelSelect" onchange="onModelChange()">
                            <option value="">Select a model...</option>
                        </select>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Display Controls</h4>
                    <div class="setting-item">
                        <label for="zoomSlider">Scale: <span id="zoomValue">1.0</span></label>
                        <input type="range" id="zoomSlider" min="0.1" max="3.0" step="0.1" value="1.0" oninput="updateZoom(this.value); document.getElementById('zoomValue').textContent = this.value;">
                    </div>
                    <div class="setting-controls">
                        <button class="btn btn-secondary" onclick="resetZoom()">Reset</button>
                        <button class="btn btn-secondary" onclick="fitModel()">Fit</button>
                        <button class="btn btn-secondary" onclick="centerModel()">Center</button>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Motions</h4>
                    <div class="setting-item">
                        <label for="motionGroupSelect">Motion Group:</label>
                        <select id="motionGroupSelect" onchange="onMotionGroupChange()">
                            <option value="">No motions available</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label for="motionSelect">Motion:</label>
                        <select id="motionSelect" onchange="onMotionTypeChange()">
                            <option value="">Select motion group first</option>
                        </select>
                    </div>
                    <div class="setting-controls">
                        <button class="btn btn-primary" onclick="playSelectedMotion()">Play Motion</button>
                        <button class="btn btn-secondary" onclick="playRandomMotion()">Random</button>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Expressions</h4>
                    <div class="setting-item">
                        <label for="expressionSelect">Expression:</label>
                        <select id="expressionSelect" onchange="onExpressionChange()">
                            <option value="">No expressions available</option>
                        </select>
                    </div>
                    <div class="setting-controls">
                        <button class="btn btn-primary" onclick="playExpression()">Apply Expression</button>
                        <button class="btn btn-secondary" onclick="resetExpression()">Reset</button>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Debug Options</h4>
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="showCanvasFrame" checked onchange="toggleCanvasFrame()">
                            Show Canvas Frame
                        </label>
                    </div>
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="showModelFrame" onchange="toggleModelFrame()">
                            Show Model Frame
                        </label>
                    </div>
                    <div class="setting-item">
                        <label>
                            <input type="checkbox" id="showHitAreas" onchange="toggleHitAreas()">
                            Show Hit Areas
                        </label>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Actions</h4>
                    <div class="setting-controls">
                        <button class="btn btn-primary" onclick="testModel()">Test Model</button>
                        <button class="btn btn-warning" onclick="resetModel()">Reset</button>
                    </div>
                    <div class="setting-controls">
                        <button class="btn btn-info" onclick="debugWindowPositions()">Debug Positions</button>
                        <button class="btn btn-warning" onclick="resetWindowLayout()">Reset Layout</button>
                    </div>
                    <div class="setting-controls">
                        <button class="btn btn-info" onclick="rescueOffScreenWindows()">Rescue Windows</button>
                    </div>
                    <div class="setting-item">
                        <label style="font-size: 12px; color: #aaa; font-style: italic;">
                            Emergency shortcuts:<br>
                            Ctrl+Shift+R = Reset to defaults<br>
                            Ctrl+Shift+B = Rescue off-screen windows
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Character Sheet Panel -->
        <div class="character-sheet-panel" id="characterSheetPanel">
            <div class="character-sheet-header">
                <span class="character-sheet-title">Character Sheets</span>
                <div class="window-controls">
                    <button class="control-btn" onclick="toggleCharacterSheetSnap()" title="Toggle Snap">üìå</button>
                    <button class="close-btn" onclick="closeCharacterSheet()">√ó</button>
                </div>
            </div>
            <div class="character-sheet-content">
                <!-- Character Selection -->
                <div class="character-selection-group">
                    <label for="characterSelect">Select Character:</label>
                    <select id="characterSelect" onchange="onCharacterChange()">
                        <option value="">Choose a character...</option>
                    </select>
                </div>
                
                <!-- User Profile Section -->
                <div class="user-profile-section">
                    <button class="btn btn-info" onclick="showUserDialog()" title="Switch user or edit user profile">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; margin-right: 5px;">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        User Profile
                    </button>
                </div>
                
                <!-- Character Sheet Form -->
                <div class="character-form" id="characterForm" style="display: none;">
                    <!-- Basic Information Section -->
                    <div class="character-section">
                        <h4>Basic Information</h4>
                        <div class="form-group">
                            <label for="displayName">Display Name:</label>
                            <input type="text" id="displayName" placeholder="Character name">
                        </div>
                        <div class="form-group">
                            <label for="ageAppearance">Age Appearance:</label>
                            <select id="ageAppearance">
                                <option value="child">Child</option>
                                <option value="teen">Teen</option>
                                <option value="young_adult">Young Adult</option>
                                <option value="adult">Adult</option>
                                <option value="mature">Mature</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="archetype">Archetype:</label>
                            <input type="text" id="archetype" placeholder="e.g., cheerful_companion">
                        </div>
                    </div>

                    <!-- Character Icon Section -->
                    <div class="character-section">
                        <h4>Character Icon</h4>
                        <div class="form-group">
                            <label for="characterIcon">Upload Character Icon:</label>
                            <div class="icon-upload-container">
                                <div class="icon-preview" id="iconPreview">
                                    <div class="icon-placeholder">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                            <circle cx="8.5" cy="8.5" r="1.5"/>
                                            <polyline points="21,15 16,10 5,21"/>
                                        </svg>
                                        <span>No icon uploaded</span>
                                    </div>
                                </div>
                                <div class="icon-upload-controls">
                                    <input type="file" id="characterIconFile" accept="image/*" onchange="handleIconUpload(event)" style="display: none;">
                                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('characterIconFile').click()">
                                        Choose Image
                                    </button>
                                    <button type="button" class="btn btn-warning" onclick="removeCharacterIcon()" id="removeIconBtn" style="display: none;">
                                        Remove Icon
                                    </button>
                                </div>
                                <div class="icon-info">
                                    <small>Recommended: Square image, 256x256 or larger. Will be automatically resized for people list.</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Personality Section -->
                    <div class="character-section">
                        <h4>Personality</h4>
                        <div class="form-group">
                            <label for="contentRating">Content Rating:</label>
                            <select id="contentRating">
                                <option value="SFW">Safe for Work (SFW)</option>
                                <option value="NSFW">Not Safe for Work (NSFW)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="traitCategories">Trait Categories:</label>
                            <div class="checkbox-group">
                                <label><input type="checkbox" name="traitCategories" value="light"> Light (optimistic)</label>
                                <label><input type="checkbox" name="traitCategories" value="dark"> Dark (mysterious)</label>
                                <label><input type="checkbox" name="traitCategories" value="neutral"> Neutral (balanced)</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="interactionStyle">Interaction Style:</label>
                            <select id="interactionStyle">
                                <option value="playful">Playful</option>
                                <option value="serious">Serious</option>
                                <option value="balanced">Balanced</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="formalityLevel">Formality Level:</label>
                            <select id="formalityLevel">
                                <option value="casual">Casual</option>
                                <option value="formal">Formal</option>
                                <option value="mixed">Mixed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="coreTraits">Core Traits (comma-separated):</label>
                            <textarea id="coreTraits" placeholder="friendly, curious, playful, thoughtful..." rows="3"></textarea>
                        </div>
                    </div>

                    <!-- Appearance Section -->
                    <div class="character-section">
                        <h4>Appearance</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="skinTone">Skin Tone:</label>
                                <select id="skinTone">
                                    <option value="light">Light</option>
                                    <option value="medium">Medium</option>
                                    <option value="dark">Dark</option>
                                    <option value="tan">Tan</option>
                                    <option value="pale">Pale</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="eyeColor">Eye Color:</label>
                                <input type="text" id="eyeColor" placeholder="blue, brown, green...">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="hairColor">Hair Color:</label>
                                <input type="text" id="hairColor" placeholder="blonde, brown, pink...">
                            </div>
                            <div class="form-group">
                                <label for="hairLength">Hair Length:</label>
                                <select id="hairLength">
                                    <option value="short">Short</option>
                                    <option value="medium">Medium</option>
                                    <option value="long">Long</option>
                                    <option value="very_long">Very Long</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="hairStyle">Hair Style (comma-separated):</label>
                            <input type="text" id="hairStyle" placeholder="bangs, straight, ponytail...">
                        </div>
                        <div class="form-group">
                            <label for="defaultOutfit">Default Outfit (comma-separated):</label>
                            <input type="text" id="defaultOutfit" placeholder="school_uniform, casual_dress...">
                        </div>
                    </div>

                    <!-- Behavioral Patterns Section -->
                    <div class="character-section">
                        <h4>Behavioral Patterns</h4>
                        <div class="form-group">
                            <label for="speechFormality">Speech Formality:</label>
                            <select id="speechFormality">
                                <option value="casual">Casual</option>
                                <option value="formal">Formal</option>
                                <option value="mixed">Mixed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="commonPhrases">Common Phrases (comma-separated):</label>
                            <textarea id="commonPhrases" placeholder="That's so cool!, I wonder..., Hehe~" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="verbalTics">Verbal Tics (comma-separated):</label>
                            <input type="text" id="verbalTics" placeholder="~, hehe, nya...">
                        </div>
                        <div class="form-group">
                            <label for="interests">Interests (comma-separated):</label>
                            <textarea id="interests" placeholder="learning_new_things, creative_activities..." rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="dislikes">Dislikes (comma-separated):</label>
                            <textarea id="dislikes" placeholder="conflict, being_ignored..." rows="2"></textarea>
                        </div>
                    </div>

                    <!-- Backstory Section -->
                    <div class="character-section">
                        <h4>Backstory</h4>
                        <div class="form-group">
                            <label for="origin">Origin:</label>
                            <textarea id="origin" placeholder="Character's background and origin story..." rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="motivation">Motivation:</label>
                            <textarea id="motivation" placeholder="What drives this character..." rows="2"></textarea>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="character-actions">
                        <button class="btn btn-primary" onclick="saveCharacterSheet()">Save Changes</button>
                        <button class="btn btn-secondary" onclick="resetCharacterForm()">Reset</button>
                        <button class="btn btn-warning" onclick="deleteCharacter()">Delete Character</button>
                        <button class="btn btn-info" onclick="exportCharacter()">Export</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Drawing Panel -->
        <div class="drawing-panel" id="drawingPanel">
            <div class="drawing-header">
                <span class="drawing-title">Drawing & Sketching</span>
                <div class="window-controls">
                    <button class="control-btn" onclick="toggleDrawingSnap()" title="Toggle Snap">üìå</button>
                    <button class="close-btn" onclick="closeDrawing()">√ó</button>
                </div>
            </div>
            <div class="drawing-content">
                <!-- Drawing Tools -->
                <div class="drawing-tools-group">
                    <h4>Drawing Tools</h4>
                    <div class="tool-buttons">
                        <button class="tool-btn active" onclick="selectTool('pen')" title="Pen">‚úèÔ∏è</button>
                        <button class="tool-btn" onclick="selectTool('brush')" title="Brush">üñåÔ∏è</button>
                        <button class="tool-btn" onclick="selectTool('eraser')" title="Eraser">üóëÔ∏è</button>
                        <button class="tool-btn" onclick="selectTool('line')" title="Line">üìè</button>
                        <button class="tool-btn" onclick="selectTool('circle')" title="Circle">‚≠ï</button>
                        <button class="tool-btn" onclick="selectTool('rectangle')" title="Rectangle">‚¨ú</button>
                    </div>
                </div>
                
                <!-- Color Picker -->
                <div class="drawing-settings-group">
                    <h4>Color & Size</h4>
                    <div class="form-group">
                        <label for="drawingColor">Color:</label>
                        <input type="color" id="drawingColor" value="#000000" onchange="updateDrawingColor()">
                    </div>
                    <div class="form-group">
                        <label for="brushSize">Brush Size:</label>
                        <input type="range" id="brushSize" min="1" max="50" value="5" oninput="updateBrushSize()">
                        <span id="brushSizeValue">5px</span>
                    </div>
                    <div class="form-group">
                        <label for="opacity">Opacity:</label>
                        <input type="range" id="opacity" min="0" max="100" value="100" oninput="updateOpacity()">
                        <span id="opacityValue">100%</span>
                    </div>
                </div>
                
                <!-- Canvas Controls -->
                <div class="drawing-canvas-group">
                    <h4>Canvas</h4>
                    <div class="canvas-buttons">
                        <button class="btn btn-primary" onclick="clearCanvas()">Clear Canvas</button>
                        <button class="btn btn-secondary" onclick="saveDrawing()">Save Drawing</button>
                        <button class="btn btn-info" onclick="loadDrawing()">Load Drawing</button>
                    </div>
                </div>
                
                <!-- Layer Controls -->
                <div class="drawing-layers-group">
                    <h4>Layers</h4>
                    <div class="layer-list" id="layerList">
                        <div class="layer-item active" data-layer="0">
                            <span>Background</span>
                            <button onclick="toggleLayerVisibility(0)">üëÅÔ∏è</button>
                        </div>
                    </div>
                    <div class="layer-buttons">
                        <button class="btn btn-sm" onclick="addNewLayer()">+ Add Layer</button>
                        <button class="btn btn-sm" onclick="deleteLayer()">Delete Layer</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Enhanced Debug Console -->
        <div class="debug-ui-panel" id="debugUIPanel" style="display: none;">
            <div class="debug-header">
                üîç Live2D AI Companion Debug Console
                <button class="debug-close-btn" onclick="toggleDebugConsole()" style="float: right; background: none; border: none; color: #ff4444; cursor: pointer; font-size: 16px;">‚úï</button>
            </div>
            
            <div class="debug-section">
                <h4>System Status</h4>
                <div class="debug-item" id="debug-sdk-status">SDK: <span class="debug-status-warn">Checking...</span></div>
                <div class="debug-item" id="debug-canvas-status">Canvas: <span class="debug-status-warn">Initializing...</span></div>
            </div>
            
            <div class="debug-section">
                <h4>Model Info</h4>
                <div class="debug-item" id="debug-model-name">Name: <span id="debug-current-model">None</span></div>
                <div class="debug-item" id="debug-motion-groups">Motion Groups: <span id="debug-motion-count">0</span></div>
                <div class="debug-item" id="debug-last-motion">Last Motion: <span id="debug-last-motion-name">None</span></div>
                <div class="debug-item" id="debug-available-models">Available Models: <span id="debug-models-list">Loading...</span></div>
            </div>
            
            <div class="debug-section">
                <h4>Database Info</h4>
                <div class="debug-item" id="debug-db-models">DB Models: <span id="debug-db-model-count">-</span></div>
                <div class="debug-item" id="debug-db-motions">DB Motions: <span id="debug-db-motion-count">-</span></div>
                <div class="debug-item" id="debug-db-status">DB Connection: <span id="debug-db-connection">Unknown</span></div>
            </div>
            
            <div class="debug-section">
                <h4>System Operations</h4>
                <div class="debug-controls" style="flex-wrap: wrap; gap: 0.25rem;">
                    <button class="debug-btn" onclick="debugRefreshAll()" title="Refresh all status information">üîÑ Refresh All</button>
                    <button class="debug-btn" onclick="debugTestSystem()" title="Run comprehensive system test">üß™ System Test</button>
                    <button class="debug-btn" onclick="debugDatabaseInfo()" title="Load database information">üíæ DB Info</button>
                    <button class="debug-btn" onclick="debugClearDatabase()" title="Clear database (WARNING: Destructive)" style="background: #ff4444;">üóë Clear DB</button>
                    <button class="debug-btn" onclick="debugReimportData()" title="Re-import all models and motions" style="background: #ff9800;">üì• Re-import</button>
                </div>
            </div>
            
            <div class="debug-section">
                <h4>Model Operations</h4>
                <div class="debug-controls" style="flex-wrap: wrap; gap: 0.25rem;">
                    <button class="debug-btn" onclick="debugTestMotion()" title="Test a random motion">üé≠ Test Motion</button>
                    <button class="debug-btn" onclick="debugLogMotions()" title="Log available motions to console">üìù Log Motions</button>
                    <button class="debug-btn" onclick="debugModelStructure()" title="Analyze model structure">üîç Structure</button>
                    <button class="debug-btn" onclick="debugLive2D()" title="Debug Live2D system">üîç Debug L2D</button>
                    <button class="debug-btn" onclick="debugTestPositioning()" title="Test model positioning fixes">üìç Test Position</button>
                    <button class="debug-btn" onclick="debugTestInteraction()" title="Test mouse drag and zoom">üñ±Ô∏è Test Interaction</button>
                    <button class="debug-btn" onclick="debugLoadDefaultModel()" title="Load default model" id="debug-load-default-model" style="display:none;background:#4caf50;">üì¶ Load Model</button>
                </div>
                
                <div class="debug-controls" style="margin-top: 0.5rem;">
                    <h5 style="margin: 0.5rem 0 0.3rem 0; color: #ffeb3b;">‚ö° Performance Tests:</h5>
                    <button class="debug-btn" onclick="testLoadingPerformance()" title="Test model loading speed">üèÉ‚Äç‚ôÇÔ∏è Load Speed</button>
                    <button class="debug-btn" onclick="benchmarkModelSwitching()" title="Benchmark model switching">üèéÔ∏è Switch Speed</button>
                    <button class="debug-btn" onclick="displayPerformanceStats()" title="Show performance statistics">üìä Stats</button>
                    <button class="debug-btn" onclick="clearPerformanceCache()" title="Clear performance cache">üßπ Clear Cache</button>
                </div>
            </div>
            
            <div class="debug-section">
                <h4>Real-time Log</h4>
                <div class="debug-log" id="debug-realtime-log">
                    üîç Debug console initialized. Use buttons above to run tests...
                </div>
                <div class="debug-controls" style="margin-top: 0.5rem;">
                    <button class="debug-btn" onclick="debugClearLog()" title="Clear debug log">üóë Clear Log</button>
                    <button class="debug-btn" onclick="debugToggleVerbose()" title="Toggle verbose logging">üí¨ Verbose</button>
                    <button class="debug-btn" onclick="debugExportLog()" title="Export log to console">üì§ Export Log</button>
                </div>
            </div>
            
            <div class="debug-section">
                <h4>üí° Drag & Zoom Help</h4>
                <div class="debug-item" style="font-size: 11px; color: #aaa; line-height: 1.4;">
                    <strong>üñ±Ô∏è Mouse Controls:</strong><br>
                    ‚Ä¢ Click and drag model to move position<br>
                    ‚Ä¢ Mouse wheel to zoom in/out<br>
                    ‚Ä¢ Use Center/Fit buttons to reset position<br><br>
                    
                    <strong>üîß Troubleshooting:</strong><br>
                    ‚Ä¢ Load a model first (People panel)<br>
                    ‚Ä¢ Run "üñ±Ô∏è Test Interaction" to verify setup<br>
                    ‚Ä¢ Check Real-time Log for mouse events<br>
                    ‚Ä¢ Ensure canvas is properly initialized
                </div>
            </div>
        </div>
        
        <!-- Canvas Area -->
        <div class="canvas-container">
            <div class="canvas-frame">
                <div id="pixiContainer"></div>
            </div>
            <div class="loading-overlay" id="loadingOverlay" style="display: none;">
                <div class="loading-spinner"></div>
            </div>
        </div>
    </div>

    <!-- Model Selection Dialog -->
    <div class="model-selection-dialog" id="modelSelectionDialog" style="display: none;">
        <div class="dialog-overlay" onclick="closeAddModelDialog()"></div>
        <div class="dialog-content">
            <div class="dialog-header">
                <h3>Add Live2D Model</h3>
                <button class="dialog-close" onclick="closeAddModelDialog()">√ó</button>
            </div>
            <div class="dialog-body">
                <div class="model-grid" id="modelGrid">
                    <div style="text-align: center; padding: 20px; color: #aaa;">
                        Loading available models...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Selection Dialog -->
    <div class="user-selection-dialog" id="userSelectionDialog" style="display: none;">
        <div class="dialog-overlay" onclick="closeUserDialog()"></div>
        <div class="dialog-content">
            <div class="dialog-header">
                <h3>User Management</h3>
                <button class="dialog-close" onclick="closeUserDialog()">√ó</button>
            </div>
            <div class="dialog-body">
                <div class="user-selection-list" id="userSelectionList">
                    <div style="text-align: center; padding: 20px; color: #aaa;">
                        Loading users...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Profile Panel -->
    <div class="user-profile-panel" id="userProfilePanel">
        <div class="user-profile-header">
            <span class="user-profile-title">User Profile</span>
            <div class="window-controls">
                <button class="control-btn" onclick="toggleUserProfileSnap()" title="Toggle Snap">üìå</button>
                <button class="close-btn" onclick="closeUserProfile()">√ó</button>
            </div>
        </div>
        <div class="user-profile-content">
            <!-- Basic User Information Section -->
            <div class="user-section">
                <h4>User Information</h4>
                <div class="form-group">
                    <label for="userDisplayName">Display Name:</label>
                    <input type="text" id="userDisplayName" placeholder="Your display name" readonly>
                </div>
                <div class="form-group">
                    <label for="userUsername">Username:</label>
                    <input type="text" id="userUsername" placeholder="Your username" readonly>
                </div>
            </div>

            <!-- Personal Information Section -->
            <div class="user-section">
                <h4>Personal Information</h4>
                <div class="form-group">
                    <label for="userGender">Gender:</label>
                    <select id="userGender">
                        <option value="not_specified">Not Specified</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="non_binary">Non-Binary</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userAgeRange">Age Range:</label>
                    <select id="userAgeRange">
                        <option value="teen">Teen (13-17)</option>
                        <option value="young_adult">Young Adult (18-25)</option>
                        <option value="adult">Adult (26-35)</option>
                        <option value="middle_aged">Middle Aged (36-50)</option>
                        <option value="mature">Mature (51+)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userBio">Bio:</label>
                    <textarea id="userBio" placeholder="Tell us about yourself..." rows="3"></textarea>
                </div>
            </div>

            <!-- Content Preferences Section -->
            <div class="user-section">
                <h4>Content Preferences</h4>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="userNsfwEnabled">
                        Enable NSFW Content
                    </label>
                    <small class="form-help">Allow not safe for work content and themes</small>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="userExplicitEnabled">
                        Enable Explicit Content
                    </label>
                    <small class="form-help">Allow explicit adult content (requires NSFW enabled)</small>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="user-actions">
                <button class="btn btn-primary" onclick="saveUserProfile()">Save Profile</button>
                <button class="btn btn-secondary" onclick="closeUserProfile()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Load PIXI.js and Live2D libraries in correct order -->
    <script src="/static/dist/pixi-6.5.10.min.js"></script>
    <script src="/static/js/eventemitter-preloader-v6.js"></script>
    <script src="/static/dist/live2d_bundle.js"></script>
    <script src="/static/dist/CubismSdkForWeb-5-r.4/Core/live2dcubismcore.min.js"></script>

    <!-- Dual architecture verification -->
    <script>
    console.log('=== Dual Architecture Verification ===');
    console.log('PIXI version:', typeof PIXI !== 'undefined' ? PIXI.VERSION : 'Not loaded');
    console.log('EventEmitter available:', typeof EventEmitter !== 'undefined');
    console.log('Live2D v2 Bundle loaded:', typeof window.Live2D !== 'undefined');
    console.log('Cubism 5 Core loaded:', typeof window.Live2DCubismCore !== 'undefined');

    if (typeof window.Live2D !== 'undefined') {
        console.log('‚úì Live2D v2 Bundle ready for Cubism 2.x models');
    }

    if (typeof window.Live2DCubismCore !== 'undefined') {
        console.log('‚úì Cubism 5 Core ready for modern models');
        console.log('- Core version:', window.Live2DCubismCore.Version ? window.Live2DCubismCore.Version.csmGetVersion() : 'unknown');
    }
    console.log('=== End Verification ===');
    </script>

    <script src="/static/dist/pixi-live2d-display-0.4.0.min.js"></script>

    <!-- Live2D plugin initialization -->
    <script>
    console.log('Initializing Live2D plugin (Live2D Viewer Web compatible)...');

    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            console.log('Checking library compatibility...');
            
            if (typeof PIXI === 'undefined') {
                console.error('PIXI.js not loaded');
                return;
            }
            
            if (typeof EventEmitter === 'undefined') {
                console.error('EventEmitter not available');
                return;
            }
            
            console.log('‚úì PIXI version:', PIXI.VERSION);
            console.log('‚úì EventEmitter type:', typeof EventEmitter);
            
            if (PIXI.utils && PIXI.utils.EventEmitter) {
                console.log('‚úì PIXI.utils.EventEmitter available (Live2D Viewer Web compatible)');
            }
            
            if (typeof PIXI.live2d === 'undefined') {
                console.error('‚úó PIXI.live2d not loaded - pixi-live2d-display may not be compatible');
                console.log('Available PIXI properties:', Object.keys(PIXI));
                
                if (window.pixiLive2DLoadError) {
                    console.error('Library loading error detected - check network tab');
                }
            } else {
                console.log('‚úì PIXI.live2d loaded successfully');
                console.log('Available PIXI.live2d properties:', Object.keys(PIXI.live2d));
                
                if (PIXI.live2d.Live2DModel) {
                    console.log('‚úì Live2DModel class available');
                    window.Live2DModel = PIXI.live2d.Live2DModel;
                    
                    if (typeof PIXI.live2d.Live2DModel.from === 'function') {
                        console.log('‚úì Live2DModel.from() method available');
                    } else {
                        console.warn('Live2DModel.from() method not found');
                    }
                } else {
                    console.warn('Live2DModel not found in PIXI.live2d');
                }
                
                if (PIXI.live2d.Live2DFactory) {
                    console.log('‚úì Live2DFactory available');
                    window.Live2DFactory = PIXI.live2d.Live2DFactory;
                } else {
                    console.warn('Live2DFactory not found in PIXI.live2d');
                }
            }
            
            console.log('Live2D plugin initialization check complete');
            console.log('System ready for Live2D model loading');
            
            if (typeof initializeLive2D === 'function') {
                console.log('Starting Live2D modular system initialization...');
                
                loadServerConfig().then(() => {
                    console.log('Server configuration loaded, initializing Live2D...');
                    return initializeLive2D();
                }).then(() => {
                    console.log('Live2D system initialization complete!');
                }).catch(error => {
                    console.error('Live2D system initialization failed:', error);
                });
            } else {
                console.error('initializeLive2D function not found!');
            }
        }, 500);
    });
    </script>

    <!-- Load Live2D modular system -->
    <script src="/static/js/live2d_config.js"></script>
    <script src="/static/js/live2d_core.js"></script>  
    <script src="/static/js/live2d_core_simple.js"></script>
    <script src="/static/js/live2d_integration.js"></script>
    <script src="/static/js/live2d_interaction.js"></script>
    <script src="/static/js/live2d_logger.js"></script>
    <script src="/static/js/live2d_model_loader.js"></script>
    <script src="/static/js/live2d_model_manager.js"></script>
    <script src="/static/js/live2d_motion_manager.js"></script>
    <script src="/static/js/live2d_motions.js"></script>
    <script src="/static/js/live2d_mouse_interaction.js"></script>    
    <script src="/static/js/live2d_multi_model_manager.js"></script>    
    <script src="/static/js/live2d_simple_fix.js"></script>    
    <script src="/static/js/live2d_tester.js"></script>
    <script src="/static/js/live2d_ui_controller.js"></script>

    <!-- UI components -->
    <script src="/static/js/ui_debug_logger.js"></script> 
    <script src="/static/js/ui_console_manager.js"></script>
    <script src="/static/js/ui_drawing_system.js"></script>
    <script src="/static/js/ui_icon_manager.js"></script>     
    <script src="/static/js/ui_panel_management.js"></script>
    <script src="/static/js/ui_people_panel.js"></script>
    <script src="/static/js/ui_panel_manager.js"></script>
    <script src="/static/js/ui_debug_console.js"></script>

    <!-- Audio Processing -->
    <script src="/static/js/audio_voice_recording.js"></script>
    <script src="/static/js/audio_tts.js"></script> 

    <!-- Additional Functionality -->
    <script src="/static/js/autonomous_avatars.js"></script>
    <script src="/static/js/chat_manager.js"></script>
    <script src="/static/js/db_manager.js"></script>
    <script src="/static/js/user_profile_manager.js"></script>
    <script src="/static/js/config_api_helpers.js"></script>
    <script src="/static/js/eventemitter_preloader_v6.js"></script>

    <!-- SocketIO for real-time communication -->
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>

    <!-- Model info display div -->
    <div id="model-info" style="position: absolute; top: 0px; left: 0px; background: rgba(0,0,0,0.8); color: white; padding: 12px; border-radius: 6px; font-size: 11px; z-index: 1000; max-width: 280px; font-family: monospace;">
        üîÑ Initializing Live2D system with interaction fix...
    </div>

    <!-- Application initialization -->
    <script>
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Update initial status
        updateModelInfoDisplay('üîÑ Loading Live2D system...\nInitializing libraries and components');
        
        // Load and apply saved window layout
        loadWindowLayout();
        
        // Initialize draggable functionality
        initializeDraggable();
        
        // Initialize navigation states
        updateNavIconStates();
        
        // Add emergency keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+Shift+R to reset window layout
            if (e.ctrlKey && e.shiftKey && e.key === 'R') {
                e.preventDefault();
                console.log('Emergency layout reset triggered');
                resetWindowLayout();
            }
            
            // Ctrl+Shift+B to rescue off-screen windows
            if (e.ctrlKey && e.shiftKey && e.key === 'B') {
                e.preventDefault();
                console.log('Emergency rescue mode triggered');
                rescueOffScreenWindows();
            }
            
            // Escape key to close model selection dialog
            if (e.key === 'Escape') {
                const dialog = document.getElementById('modelSelectionDialog');
                if (dialog && dialog.style.display === 'flex') {
                    closeAddModelDialog();
                }
            }
        });
        
        // Wait for all libraries to load properly
        setTimeout(async function() {
            console.log('Libraries loaded, checking availability...');
            
            // Check library availability
            if (typeof PIXI === 'undefined') {
                console.error('PIXI.js not loaded');
                updateModelInfoDisplay('‚ùå PIXI.js not loaded\nCheck that PIXI library loaded correctly');
                return;
            }
            
            if (typeof EventEmitter === 'undefined') {
                console.error('EventEmitter not available');
                updateModelInfoDisplay('‚ùå EventEmitter not available\nCheck browser compatibility');
                return;
            }
            
            // Check Live2D SDK availability
            if (typeof Live2DCubismCore === 'undefined') {
                console.error('Live2D Cubism Core SDK not loaded');
                updateModelInfoDisplay('‚ùå Live2D SDK not loaded\nCheck browser console for errors');
                return;
            }
            
            // Make SDK available globally for debug console
            window.LIVE2DCUBISMCORE = Live2DCubismCore;
            
            console.log('PIXI version:', PIXI.VERSION);
            console.log('EventEmitter available:', typeof EventEmitter !== 'undefined');
            console.log('Live2D SDK available:', typeof Live2DCubismCore !== 'undefined');
            
            // Initialize the Live2D system with timeout fallback
            console.log('Starting Live2D initialization...');
            
            try {
                await Promise.race([
                    initializeLive2D(),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Initialization timeout')), 10000)
                    )
                ]);
                console.log('Live2D initialization completed!');
                
                // Update status display after initialization
                updateModelInfoDisplay('‚úÖ Live2D system initialized\nLoad a model from People panel to test interaction');
                
                // Set up initial model reference if available
                setTimeout(() => {
                    updateCurrentModelReference();
                }, 1000);
            } catch (error) {
                console.error('Live2D initialization failed:', error);
                updateModelInfoDisplay(`‚ùå Live2D initialization failed\n${error.message}\nCheck browser console for details`);
            }
            
            // Verify globals are available
            console.log('Global check - window.live2dIntegration:', typeof window.live2dIntegration);
            console.log('Global check - window.live2dMultiModelManager:', typeof window.live2dMultiModelManager);
            console.log('Global check - window.LIVE2DCUBISMCORE:', typeof window.LIVE2DCUBISMCORE);
        }, 1000);
    });

    // Save layout on window resize and before page unload
    window.addEventListener('resize', function() {
        // Debounce resize events to avoid excessive saves
        clearTimeout(window.resizeTimeout);
        window.resizeTimeout = setTimeout(saveWindowLayout, 500);
    });

    window.addEventListener('beforeunload', function() {
        saveWindowLayout();
    });

    // Initialize enhanced features when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Initializing AI Companion enhanced features...');
        
        // Initialize SocketIO after a short delay
        setTimeout(() => {
            if (typeof io !== 'undefined') {
                const socket = io();
                
                socket.on('connect', function() {
                    console.log('üîå Connected to server via SocketIO');
                    addSystemMessage('Connected to AI live2d chat server', 'success');
                });
                
                socket.on('disconnect', function() {
                    console.log('üîå Disconnected from server');
                    addSystemMessage('Disconnected from server', 'warning');
                });
                
                socket.on('ai_response', function(data) {
                    console.log('üì® Received AI response via SocketIO:', data);
                    if (typeof addChatMessage === 'function') {
                        addChatMessage('ai', data.message);
                    }
                    
                    if (data.tts_data && typeof playEmotionalTTSAudio === 'function') {
                        playEmotionalTTSAudio(data.tts_data);
                    }
                    
                    if (data.emotion) {
                        triggerEmotionalResponse(data.emotion, data.intensity);
                    }
                });
                
                socket.on('motion_trigger', function(data) {
                    console.log('üé≠ Received motion trigger:', data);
                    if (data.motion_type && typeof window.triggerMotion === 'function') {
                        window.triggerMotion(data.motion_type);
                    }
                });
                
                console.log('üîå SocketIO initialized');
                window.socket = socket;
            } else {
                console.warn('‚ö†Ô∏è SocketIO not available');
            }
        }, 2000);
        
        console.log('‚úÖ AI Companion enhanced features initialized');
    });
    </script>

    <!-- Application initialization -->
    <script>
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        // Update initial status
        updateModelInfoDisplay('üîÑ Loading Live2D system...\nInitializing libraries and components');
function fixPixiInteractionSystem() {
    const pixiApp = window.live2dIntegration?.core?.app || window.pixiApp;
    if (!pixiApp) {
        console.error('‚ùå No PIXI app found for interaction fix');
        return;
    }
    
    console.log('üîß Applying PIXI interaction system fix...');
    
    // Step 1: Destroy any corrupted interaction manager
    const interaction = pixiApp.renderer.plugins?.interaction;
    if (interaction) {
        try {
            // Clear corrupted event data
            if (interaction.eventData) {
                Object.keys(interaction.eventData).forEach(key => {
                    delete interaction.eventData[key];
                });
            }
            
            // Remove DOM listeners and destroy
            if (interaction.removeEvents) interaction.removeEvents();
            if (interaction.destroy) interaction.destroy();
            delete pixiApp.renderer.plugins.interaction;
            
            console.log('‚úÖ Old interaction manager cleaned up');
        } catch (error) {
            console.log('‚ö†Ô∏è Error cleaning old interaction:', error.message);
        }
    }
    
    // Step 2: Create new interaction manager or manual fallback
    try {
        let newInteraction = null;
        
        if (PIXI.InteractionManager) {
            newInteraction = new PIXI.InteractionManager(pixiApp.renderer);
        } else if (PIXI.interaction?.InteractionManager) {
            newInteraction = new PIXI.interaction.InteractionManager(pixiApp.renderer);
        }
        
        if (newInteraction) {
            pixiApp.renderer.plugins.interaction = newInteraction;
            newInteraction.interactionDOMElement = pixiApp.view;
            console.log('‚úÖ New PIXI interaction manager created');
        }
    } catch (error) {
        console.log('‚ö†Ô∏è PIXI interaction manager creation failed:', error.message);
    }
    
    // Step 3: Set up manual DOM event bridge with complete drag system
    const canvas = pixiApp.view;
    
    // CRITICAL: Remove existing manual handlers
    if (canvas._fixedPointerHandler) {
        canvas.removeEventListener('mousedown', canvas._fixedPointerHandler);
        canvas.removeEventListener('pointerdown', canvas._fixedPointerHandler);
        document.removeEventListener('mousemove', canvas._fixedMoveHandler);
        document.removeEventListener('mouseup', canvas._fixedUpHandler);
        document.removeEventListener('pointerup', canvas._fixedUpHandler);
    }
    
    // CRITICAL: Disable all existing Live2D interaction systems that might interfere
    console.log('üîß DISABLING existing Live2D interaction systems...');
    
    // Disable PIXI stage interaction to prevent conflicts
    pixiApp.stage.interactive = false;
    pixiApp.stage.eventMode = 'passive';
    
    // Find any active models and disable their interaction systems
    const activeModel = window.live2dMultiModelManager?.getActiveModel();
    if (activeModel?.pixiModel) {
        console.log('üîß Disabling interaction on active model:', activeModel.name);
        activeModel.pixiModel.interactive = false;
        activeModel.pixiModel.eventMode = 'passive';
        activeModel.pixiModel.removeAllListeners();
    }
    
    // Create comprehensive event handlers for full drag system
    canvas._fixedPointerHandler = function(event) {
        // Convert to canvas coordinates
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        
        // Test model hit and start drag
        const model = window.live2dMultiModelManager?.getActiveModel();
        if (model?.pixiModel) {
            const pixiModel = model.pixiModel;
            const bounds = pixiModel.getBounds();
            
            console.log('üîç Hit test debug:', {
                canvasClick: { x: x, y: y },
                modelBounds: { 
                    x: bounds.x, 
                    y: bounds.y, 
                    width: bounds.width, 
                    height: bounds.height 
                },
                modelPosition: { x: pixiModel.x, y: pixiModel.y },
                modelName: model.name,
                withinBounds: x >= bounds.x && x <= bounds.x + bounds.width && 
                             y >= bounds.y && y <= bounds.y + bounds.height
            });
            
            // Check if click is within model bounds
            if (x >= bounds.x && x <= bounds.x + bounds.width && 
                y >= bounds.y && y <= bounds.y + bounds.height) {
                
                // Start drag operation using global state
                window.dragState.isDragging = true;
                window.dragState.dragStart = { x: event.clientX, y: event.clientY };
                window.dragState.modelStart = { x: pixiModel.x, y: pixiModel.y };
                window.dragState.activeModel = pixiModel;
                window.dragState.moveCount = 0; // Reset move counter for new drag
                
                // Visual feedback
                pixiModel.alpha = 0.8;
                
                console.log('üñ±Ô∏è Drag started:', {
                    startPos: window.dragState.dragStart,
                    modelStart: window.dragState.modelStart,
                    modelName: model.name,
                    activeModelSet: !!window.dragState.activeModel,
                    pixiModelType: typeof pixiModel
                });
                
                // Test immediate mousemove detection with MULTIPLE elements and capture phases
                console.log('üß™ TESTING mousemove on multiple elements and capture phases...');
                
                const testMoveHandler = function(e) {
                    if (window.dragState.isDragging) {
                        console.log('‚úÖ IMMEDIATE MOUSEMOVE TEST WORKS:', { 
                            x: e.clientX, 
                            y: e.clientY,
                            target: e.target.tagName,
                            phase: 'document'
                        });
                        // Don't remove immediately, let's see how many fire
                    }
                };
                
                const testBodyMoveHandler = function(e) {
                    if (window.dragState.isDragging) {
                        console.log('‚úÖ BODY MOUSEMOVE TEST WORKS:', { 
                            x: e.clientX, 
                            y: e.clientY,
                            target: e.target.tagName,
                            phase: 'body'
                        });
                    }
                };
                
                const testWindowMoveHandler = function(e) {
                    if (window.dragState.isDragging) {
                        console.log('‚úÖ WINDOW MOUSEMOVE TEST WORKS:', { 
                            x: e.clientX, 
                            y: e.clientY,
                            target: e.target.tagName,
                            phase: 'window'
                        });
                    }
                };
                
                // Add listeners with both capture and bubble phases
                document.addEventListener('mousemove', testMoveHandler, { passive: false, capture: true });
                document.addEventListener('mousemove', testMoveHandler, { passive: false, capture: false });
                document.body.addEventListener('mousemove', testBodyMoveHandler, { passive: false, capture: true });
                document.body.addEventListener('mousemove', testBodyMoveHandler, { passive: false, capture: false });
                window.addEventListener('mousemove', testWindowMoveHandler, { passive: false });
                
                console.log('üß™ Multiple mousemove test handlers added - will test ALL phases');
                
                // CRITICAL: Store pointerId for potential cleanup, but don't capture
                window.dragState.pointerId = event.pointerId;
                
                // CRITICAL DEBUG: Test if preventDefault is blocking events
                console.log('ÔøΩ CRITICAL DEBUG - Event details:', {
                    eventType: event.type,
                    pointerId: event.pointerId,
                    clientX: event.clientX,
                    clientY: event.clientY,
                    defaultPrevented: event.defaultPrevented,
                    cancelable: event.cancelable,
                    bubbles: event.bubbles,
                    target: event.target.tagName,
                    currentTarget: event.currentTarget.tagName
                });
                
                // CRITICAL: DO NOT PREVENT DEFAULT - this might be blocking mousemove
                console.log('üö´ NOT calling preventDefault() to test if this was blocking mousemove');
                // event.preventDefault(); // COMMENTED OUT
                // event.stopPropagation(); // COMMENTED OUT
                
                console.log('üö´ Pointer capture DISABLED to allow mousemove events');
            } else {
                console.log('üö´ Click outside model bounds');
            }
        } else {
            console.log('üö´ No active model or pixiModel found');
        }
    };
    
    // Mouse move handler for dragging - with enhanced diagnostics
    canvas._fixedMoveHandler = function(event) {
        // CRITICAL: Always log mousemove events during drag to diagnose the issue
        if (window.dragState.isDragging) {
            console.log('üîç MOUSEMOVE EVENT RECEIVED during drag:', {
                eventType: event.type,
                clientX: event.clientX,
                clientY: event.clientY,
                hasActiveModel: !!window.dragState.activeModel,
                hasDragStart: !!window.dragState.dragStart,
                hasModelStart: !!window.dragState.modelStart
            });
        }
        
        // ONLY process if we have all required state
        if (!window.dragState.isDragging || !window.dragState.activeModel || !window.dragState.dragStart || !window.dragState.modelStart) {
            // Log why we're not processing (only during drag)
            if (window.dragState.isDragging) {
                console.log('ÔøΩ Cannot process mousemove - missing state:', {
                    isDragging: window.dragState.isDragging,
                    hasActiveModel: !!window.dragState.activeModel,
                    hasDragStart: !!window.dragState.dragStart,
                    hasModelStart: !!window.dragState.modelStart
                });
            }
            return;
        }
        
        // Calculate movement delta from original drag start position
        const deltaX = event.clientX - window.dragState.dragStart.x;
        const deltaY = event.clientY - window.dragState.dragStart.y;
        
        // Update model position in real-time
        const newX = window.dragState.modelStart.x + deltaX;
        const newY = window.dragState.modelStart.y + deltaY;
        
        window.dragState.activeModel.x = newX;
        window.dragState.activeModel.y = newY;
        
        // Increment and log move counter
        if (!window.dragState.moveCount) window.dragState.moveCount = 0;
        window.dragState.moveCount++;
        
        // Log every 10th mousemove to reduce spam but show it's working
        if (window.dragState.moveCount % 10 === 1) {
            console.log('üñ±Ô∏è REAL-TIME DRAG:', {
                mousePos: { x: event.clientX, y: event.clientY },
                delta: { x: Math.round(deltaX), y: Math.round(deltaY) },
                modelPos: { x: Math.round(newX), y: Math.round(newY) },
                moveCount: window.dragState.moveCount
            });
        }
        
        event.preventDefault();
    };
    
    // Mouse up handler to end drag
    canvas._fixedUpHandler = function(event) {
        console.log('üîº Mouse up event received:', { 
            type: event.type, 
            isDragging: window.dragState.isDragging, 
            hasActiveModel: !!window.dragState.activeModel 
        });
        
        if (window.dragState.isDragging && window.dragState.activeModel) {
            // End drag operation
            window.dragState.isDragging = false;
            window.dragState.activeModel.alpha = 1.0; // Restore opacity
            
            console.log('‚úÖ Drag ended at position:', { 
                x: Math.round(window.dragState.activeModel.x), 
                y: Math.round(window.dragState.activeModel.y),
                totalMoves: window.dragState.moveCount || 0
            });
            
            // Release pointer capture if it was set
            if (canvas.releasePointerCapture && window.dragState.pointerId !== undefined) {
                try {
                    canvas.releasePointerCapture(window.dragState.pointerId);
                    console.log('‚úÖ Released pointer capture for pointerId:', window.dragState.pointerId);
                } catch (e) {
                    console.log('‚ö†Ô∏è Failed to release pointer capture:', e.message);
                }
            }
            
            // Reset state
            window.dragState.dragStart = null;
            window.dragState.modelStart = null;
            window.dragState.activeModel = null;
            window.dragState.moveCount = 0;
            window.dragState.pointerId = undefined;
            
            event.preventDefault();
            event.stopPropagation();
        } else {
            console.log('üîº Mouse up but not dragging or no active model');
        }
    };
    
    // Store handlers on canvas for cleanup (no need to reassign)
    // canvas._fixedMoveHandler and canvas._fixedUpHandler are already defined above
    
    // Remove any existing event listeners first to prevent duplicates
    canvas.removeEventListener('mousedown', canvas._fixedPointerHandler);
    canvas.removeEventListener('pointerdown', canvas._fixedPointerHandler);
    canvas.removeEventListener('mousemove', canvas._fixedMoveHandler);
    document.removeEventListener('mousemove', canvas._fixedMoveHandler);
    document.removeEventListener('mouseup', canvas._fixedUpHandler);
    document.removeEventListener('pointerup', canvas._fixedUpHandler);
    
    console.log('üîß CRITICAL: Adding fresh event listeners...');
    
    // Add all event listeners (both mouse and pointer events)
    canvas.addEventListener('mousedown', canvas._fixedPointerHandler, { passive: false });
    canvas.addEventListener('pointerdown', canvas._fixedPointerHandler, { passive: false });
    
    // CRITICAL: REMOVE canvas mousemove to test if it's conflicting with document mousemove
    console.log('üß™ TESTING: Removing canvas mousemove listeners to prevent conflicts');
    // canvas.addEventListener('mousemove', canvas._fixedMoveHandler, { passive: false }); // REMOVED
    document.addEventListener('mousemove', canvas._fixedMoveHandler, { passive: false });
    
    document.addEventListener('mouseup', canvas._fixedUpHandler, { passive: false });
    document.addEventListener('pointerup', canvas._fixedUpHandler, { passive: false });
    
    console.log('‚úÖ Event listeners added:', {
        canvasDown: 'mousedown + pointerdown',
        canvasMove: 'REMOVED - testing conflict',
        documentMove: 'mousemove', 
        documentUp: 'mouseup + pointerup'
    });
    
    // CRITICAL DIAGNOSTIC: Add global mousemove detector to test if ANY mousemove events fire
    let globalMoveCount = 0;
    document.addEventListener('mousemove', function(event) {
        if (window.dragState.isDragging) {
            globalMoveCount++;
            if (globalMoveCount <= 5) { // Only log first 5 to avoid spam
                console.log(`üåç GLOBAL MOUSEMOVE ${globalMoveCount}:`, {
                    target: event.target.tagName,
                    clientX: event.clientX,
                    clientY: event.clientY,
                    isDragging: window.dragState.isDragging
                });
            }
        }
    }, { passive: false });
    
    console.log('üîç Global mousemove detector added for diagnostics');
    
    // CRITICAL TEST: Add mousemove listeners to multiple elements to test event propagation
    console.log('üß™ Adding mousemove test listeners to multiple elements...');
    
    // Test on body
    document.body.addEventListener('mousemove', function(event) {
        if (window.dragState.isDragging && globalMoveCount <= 3) {
            console.log('üü¢ BODY MOUSEMOVE:', { target: event.target.tagName, x: event.clientX, y: event.clientY });
        }
    }, { passive: false });
    
    // Test on document.documentElement (html)
    document.documentElement.addEventListener('mousemove', function(event) {
        if (window.dragState.isDragging && globalMoveCount <= 3) {
            console.log('üü† HTML MOUSEMOVE:', { target: event.target.tagName, x: event.clientX, y: event.clientY });
        }
    }, { passive: false });
    
    // Test on window
    window.addEventListener('mousemove', function(event) {
        if (window.dragState.isDragging && globalMoveCount <= 3) {
            console.log('üî¥ WINDOW MOUSEMOVE:', { target: event.target.tagName, x: event.clientX, y: event.clientY });
        }
    }, { passive: false });
    
    console.log('üß™ Multi-level mousemove test listeners added');
    
    // Configure canvas for optimal interaction
    canvas.style.touchAction = 'none';
    canvas.style.pointerEvents = 'auto';
    
    // CRITICAL: Force all CSS properties that might block mousemove events
    canvas.style.userSelect = 'none';
    canvas.style.webkitUserSelect = 'none';
    canvas.style.msUserSelect = 'none';
    canvas.style.mozUserSelect = 'none';
    canvas.style.webkitUserDrag = 'none';
    canvas.style.webkitTouchCallout = 'none';
    canvas.style.webkitTapHighlightColor = 'transparent';
    
    // CRITICAL: Force enable all mouse event types on canvas
    canvas.style.pointerEvents = 'auto';
    canvas.setAttribute('onmousemove', ''); // Force enable mousemove attribute
    
    // CRITICAL: Check for competing event handlers (DevTools only function removed)
    console.log('üîç Event handler check complete (getEventListeners requires DevTools)');
    
    // CRITICAL: Keep stage interaction DISABLED to prevent conflicts with manual DOM handlers
    pixiApp.stage.interactive = false;
    pixiApp.stage.eventMode = 'passive';
    // Do NOT set hitArea to prevent stage from capturing events
    
    console.log('‚úÖ PIXI interaction system fix applied successfully - manual DOM only');
}

// Add basic PIXI event diagnostics
// Override onModelChange to use new loading function
function onModelChange() {
    console.log('onModelChange called');
    const modelSelect = document.getElementById('modelSelect');
    const modelName = modelSelect?.value;
    
    if (!modelName) {
        console.log('No model selected');
        return;
    }
    
    // Try to load the model with mouse interaction
    const modelPath = `/static/live2d_models/${modelName}/${modelName}.model3.json`;
    loadLive2DModel(modelPath).catch(error => {
        console.error('Failed to load model:', error);
        updateModelInfoDisplay(`‚ùå Failed to load ${modelName}\nError: ${error.message}`);
    });
}

// Global state variables for UI panels
let chatOpen = false;
let peopleOpen = false;
let settingsOpen = false;
let chatSnapped = false;
let peopleSnapped = false;
let settingsSnapped = false;

// Layout management constants
const LAYOUT_STORAGE_KEY = 'live2d_panel_layout';

// Dragging state variables
let isDragging = false;
let currentDragElement = null;
let dragOffset = { x: 0, y: 0 };

// Helper functions for layout management
function getElementPosition(elementId) {
    const element = document.getElementById(elementId);
    if (!element) return { x: 0, y: 0 };
    
    // Get computed style to check for transforms
    const computedStyle = window.getComputedStyle(element);
    const rect = element.getBoundingClientRect();
    
    // If element has been positioned manually, use the style values
    if (element.style.left && element.style.left !== '') {
        const left = parseInt(element.style.left.replace('px', ''));
        const top = parseInt(element.style.top ? element.style.top.replace('px', '') : '0');
        return { x: left, y: top };
    }
    
    // Otherwise use bounding rect, but account for potential issues
    return {
        x: Math.max(0, rect.left),
        y: Math.max(0, rect.top)
    };
}

function getElementSize(elementId) {
    const element = document.getElementById(elementId);
    if (!element) return { width: 0, height: 0 };
    
    return {
        width: element.offsetWidth,
        height: element.offsetHeight
    };
}

function applyElementLayout(element, layout) {
    // CRITICAL FIX: Reset all positioning properties to prevent cumulative drift
    element.style.left = '';
    element.style.right = '';
    element.style.top = '';
    element.style.bottom = '';
    element.style.transform = '';
    element.style.position = 'fixed';
    
    if (layout.position) {
        // Apply position with absolute values only
        if (typeof layout.position.x === 'string') {
            if (layout.position.x === 'center') {
                element.style.left = '50%';
                element.style.transform = 'translateX(-50%)';
            } else if (layout.position.x.includes('left-')) {
                element.style.left = layout.position.x.replace('left-', '') + 'px';
            } else if (layout.position.x.includes('right-')) {
                element.style.right = layout.position.x.replace('right-', '') + 'px';
            }
        } else {
            // Always use absolute pixel positioning to prevent drift
            element.style.left = Math.max(0, layout.position.x) + 'px';
        }
        
        if (typeof layout.position.y === 'string') {
            if (layout.position.y.includes('top-')) {
                element.style.top = layout.position.y.replace('top-', '') + 'px';
            } else if (layout.position.y.includes('bottom-')) {
                element.style.bottom = layout.position.y.replace('bottom-', '') + 'px';
            }
        } else {
            // Always use absolute pixel positioning to prevent drift
            element.style.top = Math.max(0, layout.position.y) + 'px';
        }
    }
    
    if (layout.size) {
        // Apply size
        if (layout.size.width !== 'auto') {
            element.style.width = layout.size.width + 'px';
        }
        if (layout.size.height !== 'auto') {
            element.style.height = layout.size.height + 'px';
        }
    }
}

function getChatSnapPosition() {
    const chatWindow = document.getElementById('chatWindow');
    if (chatWindow.classList.contains('snapped-left')) return 'left';
    if (chatWindow.classList.contains('snapped-right')) return 'right';
    if (chatWindow.classList.contains('snapped-bottom')) return 'bottom';
    return 'bottom';
}

function getPeopleSnapPosition() {
    const peoplePanel = document.getElementById('peoplePanel');
    if (peoplePanel.classList.contains('snapped-left')) return 'left';
    if (peoplePanel.classList.contains('snapped-right')) return 'right';
    return 'right';
}

function getSettingsSnapPosition() {
    const settingsPanel = document.getElementById('settingsPanel');
    if (settingsPanel.classList.contains('snapped-left')) return 'left';
    if (settingsPanel.classList.contains('snapped-right')) return 'right';
    return 'left';
}

// Clear saved layout (for debugging)
function clearSavedLayout() {
    localStorage.removeItem(LAYOUT_STORAGE_KEY);
    console.log('Saved layout cleared');
}

// Add emergency reset functionality for off-screen windows
document.addEventListener('keydown', function(e) {
    // Ctrl+Shift+R to reset window layout
    if (e.ctrlKey && e.shiftKey && e.key === 'R') {
        e.preventDefault();
        console.log('Emergency layout reset triggered');
        resetWindowLayout();
    }
    
    // Ctrl+Shift+B to bring all windows back into view (rescue mode)
    if (e.ctrlKey && e.shiftKey && e.key === 'B') {
        e.preventDefault();
        console.log('Emergency rescue mode triggered');
        rescueOffScreenWindows();
    }
    
    // Escape key to close model selection dialog
    if (e.key === 'Escape') {
        const dialog = document.getElementById('modelSelectionDialog');
        if (dialog && dialog.style.display === 'flex') {
            closeAddModelDialog();
        }
    }
});

// Emergency function to bring off-screen windows back into view
function rescueOffScreenWindows() {
    console.log('Rescuing off-screen windows...');
    
    const windows = [
        { element: document.getElementById('chatWindow'), name: 'Chat' },
        { element: document.getElementById('peoplePanel'), name: 'People' },
        { element: document.getElementById('settingsPanel'), name: 'Settings' }
    ];
    
    windows.forEach(({ element, name }) => {
        if (!element) return;
        
        const rect = element.getBoundingClientRect();
        const isOffScreen = rect.left < 0 || rect.top < 0 || 
                           rect.right > window.innerWidth || 
                           rect.bottom > window.innerHeight;
        
        if (isOffScreen) {
            console.log(`Rescuing ${name} window from off-screen position`);
            
            // Reset positioning and place in safe area
            element.style.left = '';
            element.style.right = '';
            element.style.top = '';
            element.style.bottom = '';
            element.style.transform = '';
            element.style.position = 'fixed';
            
            // Place in center-ish safe area
            const safeX = Math.max(20, Math.min(window.innerWidth - 300, 100));
            const safeY = Math.max(20, Math.min(window.innerHeight - 200, 100));
            
            element.style.left = safeX + 'px';
            element.style.top = safeY + 'px';
            
            // Make sure it's visible
            element.classList.add('open');
            if (name === 'Chat') chatOpen = true;
            if (name === 'People') peopleOpen = true;
            if (name === 'Settings') settingsOpen = true;
        }
    });
    
    updateNavIconStates();
    saveWindowLayout(); // Save the rescued positions
    console.log('Window rescue complete');
}

// Navigation functions
// People panel functionality
let populatePeopleModelsTimeout = null; // Debounce timeout

// Debounced version to prevent multiple rapid calls
function debouncedPopulatePeopleModels(delay = 100) {
    if (populatePeopleModelsTimeout) {
        clearTimeout(populatePeopleModelsTimeout);
    }
    
    populatePeopleModelsTimeout = setTimeout(() => {
        populatePeopleModels();
        populatePeopleModelsTimeout = null;
    }, delay);
}

async function populatePeopleModels() {
    const modelsList = document.getElementById('peopleModelsList');
    
    console.log('üìã populatePeopleModels called - clearing existing models');
    
    // Clear existing models
    modelsList.innerHTML = '';
    
    // Get loaded models from multi-model manager
    if (!live2dMultiModelManager) {
        modelsList.innerHTML = '<div style="text-align: center; padding: 20px; color: #aaa;">No models loaded</div>';
        return;
    }
    
    const loadedModels = live2dMultiModelManager.getAllModels();
    console.log(`üìã Found ${loadedModels.length} loaded models:`, loadedModels.map(m => m.id));
    
    if (loadedModels.length === 0) {
        modelsList.innerHTML = '<div style="text-align: center; padding: 20px; color: #aaa;">No models loaded</div>';
        return;
    }
    
    // Load character data to get icons (only once)
    let charactersData = null;
    try {
        const response = await fetch('/api/characters');
        if (response.ok) {
            charactersData = await response.json();
        }
    } catch (error) {
        console.log('Could not load character data for icons:', error.message);
    }
    
    // Create a Set to track unique model IDs and prevent duplicates
    const addedModelIds = new Set();
    
    loadedModels.forEach(modelData => {
        // Skip if this model ID was already added
        if (addedModelIds.has(modelData.id)) {
            console.warn('‚ö†Ô∏è Skipping duplicate model:', modelData.id);
            return;
        }
        
        addedModelIds.add(modelData.id);
        console.log('‚ûï Adding model to people panel:', modelData.id, modelData.name);
        
        const isActive = live2dMultiModelManager.activeModelId === modelData.id;
        
        // Try to get character icon from character data
        let characterIcon = null;
        if (charactersData && charactersData.characters && charactersData.characters[modelData.name]) {
            const charData = charactersData.characters[modelData.name];
            if (charData.basic_info && charData.basic_info.icon) {
                characterIcon = charData.basic_info.icon.processed || charData.basic_info.icon.original;
            }
        }
        
        const modelItem = document.createElement('div');
        modelItem.className = `people-model-item ${isActive ? 'active' : ''}`;
        modelItem.innerHTML = `
            <div class="people-model-avatar">
                ${characterIcon ? 
                    `<img src="${characterIcon}" alt="${modelData.name}" class="character-icon">` : 
                    (modelData.characterImage ? 
                        `<img src="${modelData.characterImage}" alt="${modelData.name}">` : 
                        'üë§'
                    )
                }
            </div>
            <div class="people-model-info">
                <div class="people-model-name">${modelData.name}</div>
                <div class="people-model-status">${isActive ? 'Active' : 'Inactive'}</div>
            </div>
            <button class="people-model-remove" onclick="event.stopPropagation(); removeModel('${modelData.id}'); return false;">√ó</button>
        `;
        
        // Add click handler for model selection
        modelItem.addEventListener('click', (e) => {
            // Only handle clicks that aren't on the remove button
            if (!e.target.classList.contains('people-model-remove')) {
                console.log('üéØ Clicking model in people panel:', modelData.id, 'Current active:', live2dMultiModelManager?.activeModelId);
                
                // Only switch if it's not already the active model
                if (live2dMultiModelManager && live2dMultiModelManager.activeModelId !== modelData.id) {
                    console.log('üîÑ Switching to model:', modelData.id);
                    live2dMultiModelManager.setActiveModel(modelData.id);
                    
                    // Update current model reference for mouse interaction
                    setTimeout(() => {
                        updateCurrentModelReference();
                        updateModelInfoDisplay(`Switched to model: ${modelData.name}\nTry clicking or dragging the model`);
                    }, 200);
                    
                    // Refresh the panel to update active states
                    debouncedPopulatePeopleModels(150);
                } else {
                    console.log('‚úÖ Model already active:', modelData.id);
                    
                    // Still update the reference in case it got lost
                    updateCurrentModelReference();
                    updateModelInfoDisplay(`Model ${modelData.name} is already active\nTry clicking or dragging the model`);
                }
            }
        });
        
        modelsList.appendChild(modelItem);
    });
    
    console.log(`‚úÖ People panel populated with ${addedModelIds.size} unique models`);
}

// Draggable functionality
function initializeDraggable() {
    const draggableElements = [
        { element: document.getElementById('chatWindow'), header: '.chat-header' },
        { element: document.getElementById('peoplePanel'), header: '.people-header' },
        { element: document.getElementById('settingsPanel'), header: '.settings-header' }
    ];
    
    draggableElements.forEach(({ element, header }) => {
        const headerElement = element.querySelector(header);
        if (headerElement) {
            headerElement.addEventListener('mousedown', (e) => startDrag(e, element));
        }
    });
    
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', stopDrag);
}

function startDrag(e, element) {
    // Check if the element is pinned and prevent dragging
    const pinButton = element.querySelector('.control-btn[onclick*="Snap"]');
    const isPinned = pinButton && pinButton.classList.contains('pinned');
    
    if (isPinned) {
        return; // Don't allow dragging if pinned
    }
    
    isDragging = true;
    currentDragElement = element;
    
    const rect = element.getBoundingClientRect();
    dragOffset.x = e.clientX - rect.left;
    dragOffset.y = e.clientY - rect.top;
    
    element.style.zIndex = '300';
    document.body.style.cursor = 'move';
}

function drag(e) {
    if (!isDragging || !currentDragElement) return;
    
    const x = e.clientX - dragOffset.x;
    const y = e.clientY - dragOffset.y;
    
    // Constrain to viewport
    const maxX = window.innerWidth - currentDragElement.offsetWidth;
    const maxY = window.innerHeight - currentDragElement.offsetHeight;
    
    const constrainedX = Math.max(0, Math.min(x, maxX));
    const constrainedY = Math.max(0, Math.min(y, maxY));
    
    currentDragElement.style.left = constrainedX + 'px';
    currentDragElement.style.top = constrainedY + 'px';
    currentDragElement.style.right = 'auto';
    currentDragElement.style.bottom = 'auto';
    currentDragElement.style.transform = 'none';
}

function stopDrag() {
    if (isDragging) {
        isDragging = false;
        if (currentDragElement) {
            currentDragElement.style.zIndex = '200';
        }
        currentDragElement = null;
        document.body.style.cursor = 'default';
        
        // Save layout when dragging stops
        saveWindowLayout();
    }
}

// Chat functionality
function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (message) {
        // Add message to chat
        addMessageToChat('user', message);
        input.value = '';
        
        // Send to AI backend via SocketIO
        sendChatMessage(message);
    }
}

function addMessageToChat(sender, message) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageElement = document.createElement('div');
    messageElement.className = `chat-message ${sender}`;
    messageElement.innerHTML = `
        <div class="message-content">${message}</div>
        <div class="message-time">${new Date().toLocaleTimeString()}</div>
    `;
    messagesContainer.appendChild(messageElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function sendChatMessage(message) {
    // Check if socket is available
    if (typeof socket !== 'undefined' && socket.connected) {
        socket.emit('chat_message', { message: message });
    } else {
        console.warn('Socket not available, using fallback API');
        // Fallback to direct API call
        sendChatToAPI(message);
    }
}

async function sendChatToAPI(message) {
    try {
        const response = await makeApiCall('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: message })
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.response) {
                addMessageToChat('assistant', data.response);
            }
        } else {
            addMessageToChat('system', 'Error: Failed to get response from AI');
        }
    } catch (error) {
        console.error('Chat API error:', error);
        addMessageToChat('system', 'Error: Could not send message');
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Update initial status
    updateModelInfoDisplay('üîÑ Loading Live2D system...\nInitializing libraries and components');
    
    // Load and apply saved window layout
    loadWindowLayout();
    
    // Initialize draggable functionality
    initializeDraggable();
    
    // Initialize navigation states
    updateNavIconStates();
    
    // Wait for all libraries to load properly
    setTimeout(async function() {
        console.log('Libraries loaded, checking availability...');
        
        // Check library availability
        if (typeof PIXI === 'undefined') {
            console.error('PIXI.js not loaded');
            updateModelInfoDisplay('‚ùå PIXI.js not loaded\nCheck that PIXI library loaded correctly');
            return;
        }
        
        if (typeof EventEmitter === 'undefined') {
            console.error('EventEmitter not available');
            updateModelInfoDisplay('‚ùå EventEmitter not available\nCheck browser compatibility');
            return;
        }
        
        // Check Live2D SDK availability
        if (typeof Live2DCubismCore === 'undefined') {
            console.error('Live2D Cubism Core SDK not loaded');
            updateModelInfoDisplay('‚ùå Live2D SDK not loaded\nCheck browser console for errors');
            return;
        }
        
        // Make SDK available globally for debug console
        window.LIVE2DCUBISMCORE = Live2DCubismCore;
        
        console.log('PIXI version:', PIXI.VERSION);
        console.log('EventEmitter available:', typeof EventEmitter !== 'undefined');
        console.log('Live2D SDK available:', typeof Live2DCubismCore !== 'undefined');
        
        // Initialize the Live2D system with timeout fallback
        console.log('Starting Live2D initialization...');
        
        try {
            await Promise.race([
                initializeLive2D(),
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Initialization timeout')), 10000)
                )
            ]);
            console.log('Live2D initialization completed!');
            
            // Update status display after initialization
            updateModelInfoDisplay('‚úÖ Live2D system initialized\nLoad a model from People panel to test interaction');
            
            // Set up initial model reference if available
            setTimeout(() => {
                updateCurrentModelReference();
            }, 1000);
        } catch (error) {
            console.error('Live2D initialization failed:', error);
            updateModelInfoDisplay(`‚ùå Live2D initialization failed\n${error.message}\nCheck browser console for details`);
        }
        
        // Verify globals are available
        console.log('Global check - window.live2dIntegration:', typeof window.live2dIntegration);
        console.log('Global check - window.live2dMultiModelManager:', typeof window.live2dMultiModelManager);
        console.log('Global check - window.LIVE2DCUBISMCORE:', typeof window.LIVE2DCUBISMCORE);
    }, 1000); // Increased delay to ensure libraries are loaded
});

// Save layout on window resize and before page unload
window.addEventListener('resize', function() {
    // Debounce resize events to avoid excessive saves
    clearTimeout(window.resizeTimeout);
    window.resizeTimeout = setTimeout(saveWindowLayout, 500);
});

window.addEventListener('beforeunload', function() {
    saveWindowLayout();
});

// ===============================================================================
// ENHANCED AI COMPANION FUNCTIONALITY
// ===============================================================================

// Voice Recording System
let isRecording = false;
let mediaRecorder = null;
let audioChunks = [];

async function toggleVoiceRecording() {
    const voiceButton = document.getElementById('voiceButton');
    
    if (!isRecording) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };
            
            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                await sendAudioToServer(audioBlob);
                
                // Stop all tracks to turn off microphone
                stream.getTracks().forEach(track => track.stop());
            };
            
            mediaRecorder.start();
            isRecording = true;
            voiceButton.innerHTML = 'üõë';
            voiceButton.style.backgroundColor = '#ff4444';
            console.log('üé§ Voice recording started');
            
        } catch (error) {
            console.error('Error accessing microphone:', error);
            addSystemMessage('Microphone access denied or not available', 'error');
        }
    } else {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
        }
        isRecording = false;
        voiceButton.innerHTML = 'üé§';
        voiceButton.style.backgroundColor = '';
        console.log('üõë Voice recording stopped');
    }
}

async function sendAudioToServer(audioBlob) {
    try {
        const formData = new FormData();
        formData.append('audio', audioBlob, 'recording.wav');
        
        // Use the same fallback system as other API calls
        let apiBaseUrl = window.ai2d_chat_CONFIG?.API_BASE_URL;
        let response;
        
        // Try primary API URL first
        if (apiBaseUrl) {
            try {
                response = await fetch(`${apiBaseUrl}/api/speech-to-text`, {
                    method: 'POST',
                    body: formData
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.text) {
                        document.getElementById('chatInput').value = data.text;
                        addSystemMessage(`Voice transcribed: "${data.text}"`, 'success');
                    }
                    return;
                }
            } catch (error) {
                console.warn(`Speech-to-text API failed with primary URL ${apiBaseUrl}:`, error.message);
            }
        }
        
        // Try fallback URLs if primary failed
        const fallbackUrls = window.ai2d_chat_CONFIG?.FALLBACK_URLS || [];
        for (const fallbackUrl of fallbackUrls) {
            try {
                console.log(`Trying speech-to-text API fallback URL: ${fallbackUrl}`);
                response = await fetch(`${fallbackUrl}/api/speech-to-text`, {
                    method: 'POST',
                    body: formData
                });
                if (response.ok) {
                    console.log(`Speech-to-text API successful with fallback URL: ${fallbackUrl}`);
                    // Update the working URL for future requests
                    window.ai2d_chat_CONFIG.API_BASE_URL = fallbackUrl;
                    const data = await response.json();
                    if (data.text) {
                        document.getElementById('chatInput').value = data.text;
                        addSystemMessage(`Voice transcribed: "${data.text}"`, 'success');
                    }
                    return;
                }
            } catch (error) {
                console.warn(`Speech-to-text API fallback failed with ${fallbackUrl}:`, error.message);
            }
        }
        
        // If all URLs failed, throw error
        throw new Error('All speech-to-text API endpoints failed');
        
    } catch (error) {
        console.error('Error sending audio to server:', error);
        addSystemMessage('Failed to process voice recording', 'error');
    }
}

// Enhanced Chat System
function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

async function sendMessage() {
    // Delegate to the enhanced multi-avatar chat system in chat.js
    if (window.sendMessage && typeof window.sendMessage === 'function') {
        try {
            await window.sendMessage();
        } catch (error) {
            console.error('Enhanced chat system error:', error);
            // Fallback to legacy system
            await sendMessageLegacy();
        }
    } else {
        // Fallback if chat.js not loaded yet
        await sendMessageLegacy();
    }
}

async function sendMessageLegacy() {
    // Legacy chat function as fallback
    const chatInput = document.getElementById('user-input') || document.getElementById('chatInput');
    const chatMessages = document.getElementById('chatMessages');
    const text = chatInput.value.trim();
    
    if (!text) return;
    
    // Add user message to chat using the enhanced system if available
    if (window.addMessage) {
        window.addMessage('user', text);
    } else {
        addChatMessage('user', text);
    }
    chatInput.value = '';
    
    try {
        // Use the same fetchWithFallback system as Live2D models
        let apiBaseUrl = window.ai2d_chat_CONFIG?.API_BASE_URL;
        let response;
        
        // Try primary API URL first
        if (apiBaseUrl) {
            try {
                response = await fetch(`${apiBaseUrl}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });
                if (response.ok) {
                    const data = await response.json();
                    
                    // Add AI response to chat using enhanced system if available
                    if (window.addMessage) {
                        window.addMessage('ai', data.reply || '[No reply]');
                    } else {
                        addChatMessage('ai', data.reply || '[No reply]');
                    }
                    
                    // Play TTS if available
                    if (data.tts_data) {
                        playEmotionalTTSAudio(data.tts_data);
                    }
                    
                    // Trigger Live2D emotion/motion if available
                    if (data.emotion && window.live2dIntegration) {
                        triggerEmotionalResponse(data.emotion, data.intensity || 0.5);
                    }
                    return;
                }
            } catch (error) {
                console.warn(`Chat API failed with primary URL ${apiBaseUrl}:`, error.message);
            }
        }
        
        // Try fallback URLs if primary failed
        const fallbackUrls = window.ai2d_chat_CONFIG?.FALLBACK_URLS || [];
        for (const fallbackUrl of fallbackUrls) {
            try {
                console.log(`Trying chat API fallback URL: ${fallbackUrl}`);
                response = await fetch(`${fallbackUrl}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });
                if (response.ok) {
                    console.log(`Chat API successful with fallback URL: ${fallbackUrl}`);
                    // Update the working URL for future requests
                    window.ai2d_chat_CONFIG.API_BASE_URL = fallbackUrl;
                    const data = await response.json();
                    
                    // Add AI response to chat using enhanced system if available
                    if (window.addMessage) {
                        window.addMessage('ai', data.reply || '[No reply]');
                    } else {
                        addChatMessage('ai', data.reply || '[No reply]');
                    }
                    
                    // Play TTS if available
                    if (data.tts_data) {
                        playEmotionalTTSAudio(data.tts_data);
                    }
                    
                    // Trigger Live2D emotion/motion if available
                    if (data.emotion && window.live2dIntegration) {
                        triggerEmotionalResponse(data.emotion, data.intensity || 0.5);
                    }
                    return;
                }
            } catch (error) {
                console.warn(`Chat API fallback failed with ${fallbackUrl}:`, error.message);
            }
        }
        
        // If all URLs failed, throw error
        throw new Error('All chat API endpoints failed');
        
    } catch (error) {
        console.error('Error sending message:', error);
        if (window.addSystemMessage) {
            window.addSystemMessage(`Failed to send message: ${error.message}`, 'error');
        } else {
            addChatMessage('system', `Failed to send message: ${error.message}`, 'error');
        }
    }
}

function addChatMessage(sender, message, type = 'info') {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${sender} ${type}`;
    
    const timestamp = new Date().toLocaleTimeString();
    messageDiv.innerHTML = `
        <div class="message-content">${escapeHtml(message)}</div>
        <div class="message-time">${timestamp}</div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Enhanced Debug Console
function toggleDebugConsole() {
    const debugPanel = document.getElementById('debugUIPanel');
    if (debugPanel.style.display === 'none' || !debugPanel.style.display) {
        debugPanel.style.display = 'block';
        console.log('üîç Debug console opened');
    } else {
        debugPanel.style.display = 'none';
        console.log('üîç Debug console closed');
    }
}

// Live2D Emotional Response Integration
function triggerEmotionalResponse(emotion, intensity = 0.5) {
    if (!window.live2dIntegration || !window.live2dIntegration.motionManager) {
        console.warn('Live2D integration not available for emotional response');
        return;
    }
    
    // Map emotions to Live2D motions
    const emotionMotionMap = {
        'happy': 'idle',
        'excited': 'head',
        'sad': 'body',
        'surprised': 'expression',
        'curious': 'special',
        'thoughtful': 'talk'
    };
    
    const motionType = emotionMotionMap[emotion] || 'idle';
    
    console.log(`üé≠ Triggering emotional response: ${emotion} (${motionType})`);
    
    // Trigger motion via Live2D integration
    if (typeof window.triggerMotion === 'function') {
        window.triggerMotion(motionType);
    }
}

// SocketIO Integration
let socket = null;

function initializeSocketIO() {
    if (typeof io !== 'undefined') {
        socket = io();
        
        socket.on('connect', function() {
            console.log('üîå Connected to server via SocketIO');
            addSystemMessage('Connected to AI live2d chat server', 'success');
        });
        
        socket.on('disconnect', function() {
            console.log('üîå Disconnected from server');
            addSystemMessage('Disconnected from server', 'warning');
        });
        
        socket.on('ai_response', function(data) {
            console.log('üì® Received AI response via SocketIO:', data);
            addChatMessage('ai', data.message);
            
            if (data.tts_data) {
                playEmotionalTTSAudio(data.tts_data);
            }
            
            if (data.emotion) {
                triggerEmotionalResponse(data.emotion, data.intensity);
            }
        });
        
        socket.on('motion_trigger', function(data) {
            console.log('üé≠ Received motion trigger:', data);
            if (data.motion_type && typeof window.triggerMotion === 'function') {
                window.triggerMotion(data.motion_type);
            }
        });
        
        console.log('üîå SocketIO initialized');
    } else {
        console.warn('‚ö†Ô∏è SocketIO not available');
    }
}

// Performance Testing Functions
function testLoadingPerformance() {
    console.log('Testing model loading performance...');
    if (live2dMultiModelManager) {
        // Test loading performance with current models
        console.log('Performance test: Measuring model loading times');
        // Implementation would go here - for now just log
    } else {
        console.log('No Live2D manager available for performance testing');
    }
}

function benchmarkModelSwitching() {
    console.log('Benchmarking model switching performance...');
    if (live2dMultiModelManager) {
        // Test model switching speed
        console.log('Performance test: Measuring model switching speed');
        // Implementation would go here - for now just log
    } else {
        console.log('No Live2D manager available for benchmarking');
    }
}

function displayPerformanceStats() {
    console.log('Displaying performance statistics...');
    if (live2dMultiModelManager) {
        // Display performance statistics
        const models = live2dMultiModelManager.getAllModels();
        console.log(`Performance Stats:
- Total models loaded: ${models.length}
- Active model: ${live2dMultiModelManager.activeModelId || 'None'}
- Memory usage: ${(performance.memory ? performance.memory.usedJSHeapSize / 1024 / 1024 : 'Unknown')} MB`);
    } else {
        console.log('No Live2D manager available for performance stats');
    }
}

function clearPerformanceCache() {
    console.log('Clearing performance cache...');
    // Clear any cached performance data
    // Implementation would go here - for now just log
    console.log('Performance cache cleared');
}

// System Utility Functions
function addSystemMessage(message, type = 'info') {
    addChatMessage('system', message, type);
}

// Initialize enhanced features when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initializing AI Companion enhanced features...');
    
    // Initialize SocketIO after a short delay
    setTimeout(() => {
        initializeSocketIO();
    }, 2000);
    
    console.log('‚úÖ AI Companion enhanced features initialized');
});

}); // Close the main DOMContentLoaded function from line 1058
</script>

</body>
</html>
