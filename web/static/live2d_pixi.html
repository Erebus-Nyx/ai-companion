<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live2D AI Companion - Dual Architecture Testing Interface</title>
    <link rel="stylesheet" href="/static/css/live2d_test.css">
    <!-- Live2D AI Companion - Production-ready avatar system with dual runtime support -->
</head>
</head>
<body>
    <div class="app-container">
        <!-- Navigation Icons (Top Right) -->
        <nav class="nav-icons" id="navIcons">
            <button class="nav-icon" onclick="openChat()" title="Chat" data-tooltip="Chat">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                </svg>
            </button>
            <button class="nav-icon" onclick="openDrawing()" title="Drawing Tools" data-tooltip="Drawing">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                    <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                    <path d="M2 2l7.586 7.586"/>
                    <circle cx="11" cy="11" r="2"/>
                </svg>
            </button>            
            <div class="nav-divider"></div>
            <button class="nav-icon" onclick="openCharacterProfiles()" title="Character Profiles" data-tooltip="Characters">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
            </button>
            <button class="nav-icon" onclick="openUserManagement()" title="User Management" data-tooltip="Users">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="8.5" cy="7" r="4"/>
                    <path d="M20 8v6M23 11h-6"/>
                </svg>
            </button>
            <button class="nav-icon" onclick="openSettings()" title="Settings" data-tooltip="Settings">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"/>
                </svg>
            </button>
            <button class="nav-icon" onclick="toggleAudioQueuePanel()" title="Audio Queue Control" data-tooltip="Audio Queue">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18V5l12-2v13"/>
                    <circle cx="6" cy="18" r="3"/>
                    <circle cx="18" cy="16" r="3"/>
                </svg>
            </button>
            <div class="nav-divider"></div>
            <button class="nav-icon" onclick="toggleFullscreen()" title="Fullscreen" data-tooltip="Fullscreen">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                </svg>
            </button>
            <button class="nav-icon" onclick="toggleHelp()" title="Help" data-tooltip="Help">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                    <point cx="12" cy="17"/>
                </svg>
            </button>
            <button class="nav-icon" onclick="logoutUser()" title="Logout" data-tooltip="Logout">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16,17 21,12 16,7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
            </button>            
            <button class="nav-icon nav-collapse" onclick="toggleNavigation()" title="Collapse Navigation" data-tooltip="Collapse">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="18,15 12,9 6,15"/>
                </svg>
            </button>
        </nav>
        
        <!-- User Selection Popup -->
        <div class="user-selection-overlay" id="userSelectionPopup">
            <div class="user-selection-popup">
                <div class="user-selection-header">
                    <h2>Select User Profile</h2>
                    <p>Choose your user profile to continue</p>
                </div>
                
                <div class="user-selection-message" id="userSelectionMessage" style="display: none;"></div>
                
                <div class="user-selection-content">
                    <div class="user-selection-list" id="userSelectionList">
                        <!-- Users will be populated here dynamically -->
                    </div>
                    
                    <!-- New User Form (initially hidden) -->
                    <form class="new-user-form" id="newUserForm" style="display: none;">
                        <div class="form-group">
                            <label for="username">Username*</label>
                            <input type="text" id="username" name="username" required minlength="3" placeholder="Enter username">
                        </div>
                        <div class="form-group">
                            <label for="display_name">Display Name</label>
                            <input type="text" id="display_name" name="display_name" placeholder="Enter display name (optional)">
                        </div>
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" name="email" placeholder="Enter email (optional)">
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Create User</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Chat Window -->
        <div class="chat-window" id="chatWindow">
            <div class="chat-header">
                <div class="chat-title-area">
                    <span class="chat-title">Chat</span>
                    <div class="active-characters" id="activeCharacters">
                        <button class="add-character-btn" onclick="showAddModelDialog()" title="Add Character">+</button>
                        <div class="character-icons-container" id="characterIconsContainer">
                            <!-- Active character icons will be populated here -->
                        </div>
                    </div>
                </div>
                <div class="window-controls">
                    <button class="close-btn" onclick="closeChat()">√ó</button>
                </div>
            </div>
            <div class="chat-content">
                <div class="chat-messages" id="chatMessages">
                    <!-- Chat messages will be populated here -->
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." onkeypress="handleChatKeyPress(event)">
                    <button class="send-btn" onclick="sendMessage()">Send</button>
                    <button class="voice-btn" id="voiceButton" onclick="toggleVoiceRecording()" title="Voice Recording">üé§</button>
                </div>
            </div>
        </div>
        
        <!-- Settings Panel (Left Side Overlay) -->
        <div class="settings-panel" id="settingsPanel">
            <div class="settings-header">
                <span class="settings-title">‚öôÔ∏è Live2D Settings</span>
                <div class="window-controls">
                    <button class="close-btn" onclick="closeSettings()">√ó</button>
                </div>
            </div>
            <div class="settings-content">
                <div class="settings-group">
                    <h4>Model Management</h4>
                    <div class="model-management-actions">
                        <div class="setting-item">
                            <label>Canvas Actions:</label>
                            <div class="model-canvas-controls">
                                <select id="existingModelSelect" class="form-select">
                                    <option value="">Select existing model...</option>
                                </select>
                                <button class="btn btn-secondary" onclick="addExistingModelToCanvas()">
                                    ‚ûï Add to Canvas
                                </button>
                            </div>
                        </div>
                        <div class="setting-item">
                            <label>Model Files:</label>
                            <div class="model-file-controls">
                                <input type="file" id="canvasModelFileInput" accept=".zip" multiple style="display: none;">
                                <button class="btn btn-primary" onclick="document.getElementById('canvasModelFileInput').click()">
                                    üìÅ Upload ZIP Model
                                </button>
                                <select id="canvasModelSelect" class="form-select">
                                    <option value="">No models on canvas...</option>
                                </select>
                                <button class="btn btn-warning" onclick="removeModelFromCanvas()" disabled id="removeModelBtn">
                                    üóëÔ∏è Remove
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Voice Management</h4>
                    <div class="voice-management-actions">
                        <div class="setting-item">
                            <label>Voice Files:</label>
                            <div class="voice-file-controls">
                                <input type="file" id="voiceFileInput" accept=".pth,.onnx,.zip" multiple style="display: none;">
                                <button class="btn btn-primary" onclick="document.getElementById('voiceFileInput').click()">
                                    üé§ Upload Voice Model
                                </button>
                                <select id="voiceSelect" class="form-select">
                                    <option value="">No voices available...</option>
                                </select>
                                <button class="btn btn-warning" onclick="removeVoiceModel()" disabled id="removeVoiceBtn">
                                    üóëÔ∏è Remove Voice
                                </button>
                            </div>
                        </div>
                        <div class="setting-item">
                            <label>Test Voice:</label>
                            <div class="voice-test-controls">
                                <input type="text" id="voiceTestText" placeholder="Enter text to test voice..." class="form-input">
                                <button class="btn btn-secondary" onclick="testSelectedVoice()" disabled id="testVoiceBtn">
                                    üîä Test Voice
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Display Controls</h4>
                    <div class="setting-item">
                        <label for="zoomSlider">Scale: <span id="zoomValue">1.0</span></label>
                        <input type="range" id="zoomSlider" min="0.1" max="3.0" step="0.025" value="1.0" oninput="updateZoom(this.value); document.getElementById('zoomValue').textContent = this.value;">
                    </div>
                    <div class="setting-controls">
                        <button class="btn btn-secondary" onclick="resetZoom()">Reset</button>
                        <button class="btn btn-secondary" onclick="fitModel()">Fit</button>
                        <button class="btn btn-secondary" onclick="centerModel()">Center</button>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Motions</h4>
                    <div class="setting-item">
                        <label for="motionGroupSelect">Motion Group:</label>
                        <select id="motionGroupSelect" onchange="onMotionGroupChange()">
                            <option value="">No motions available</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label for="motionSelect">Motion:</label>
                        <select id="motionSelect" onchange="onMotionTypeChange()">
                            <option value="">Select motion group first</option>
                        </select>
                    </div>
                    <div class="setting-controls">
                        <button class="btn btn-primary" onclick="playSelectedMotion()">Play Motion</button>
                        <button class="btn btn-secondary" onclick="playRandomMotion()">Random</button>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Expressions</h4>
                    <div class="setting-item">
                        <label for="expressionSelect">Expression:</label>
                        <select id="expressionSelect" onchange="onExpressionChange()">
                            <option value="">No expressions available</option>
                        </select>
                    </div>
                    <div class="setting-controls">
                        <button class="btn btn-primary" onclick="playExpression()">Apply Expression</button>
                        <button class="btn btn-secondary" onclick="resetExpression()">Reset</button>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Actions</h4>
                    <div class="setting-controls">
                        <button class="btn btn-primary" onclick="testModel()">Test Model</button>
                        <button class="btn btn-warning" onclick="resetModel()">Reset</button>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Avatar State Management</h4>
                    <div class="setting-controls">
                        <button class="btn btn-info" onclick="window.saveLive2DState()" title="Save current avatar positions and states">Save State</button>
                        <button class="btn btn-secondary" onclick="window.loadLive2DState()" title="Load saved avatar states">Load State</button>
                        <button class="btn btn-primary" onclick="window.exportLive2DState()" title="Export state to file">Export</button>
                        <button class="btn btn-warning" onclick="window.clearLive2DState()" title="Clear all saved state">Clear</button>
                    </div>
                    <div class="setting-item" style="margin-top: 10px;">
                        <label for="stateImportFile">Import State File:</label>
                        <input type="file" id="stateImportFile" accept=".json" onchange="handleStateImport(this)" style="font-size: 12px;">
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Background Settings</h4>
                    <div class="setting-item">
                        <label for="backgroundImageFile">Background Image:</label>
                        <input type="file" id="backgroundImageFile" accept="image/*" style="font-size: 12px; margin-bottom: 8px;">
                    </div>
                    <div class="setting-controls">
                        <button class="btn btn-primary" onclick="applyBackgroundImage()" title="Apply selected background image">Apply</button>
                        <button class="btn btn-secondary" onclick="clearBackgroundImage()" title="Remove current background image">Clear Background</button>
                        <button class="btn btn-info" onclick="showBackgroundPreview()" title="Preview selected background image">Preview</button>
                    </div>
                    <div class="setting-item" style="margin-top: 10px;">
                        <label for="backgroundOpacity">Background Opacity: <span id="backgroundOpacityValue">100</span>%</label>
                        <input type="range" id="backgroundOpacity" min="0" max="100" value="100" oninput="updateBackgroundOpacity(this.value);" style="width: 100%;">
                    </div>
                    <div class="setting-item">
                        <label for="backgroundScale">Background Scale: <span id="backgroundScaleValue">100</span>%</label>
                        <input type="range" id="backgroundScale" min="50" max="200" value="100" oninput="updateBackgroundScale(this.value);" style="width: 100%;">
                    </div>
                    <div class="setting-item">
                        <label for="backgroundPosition">Background Position:</label>
                        <select id="backgroundPosition" onchange="updateBackgroundPosition(this.value)">
                            <option value="center">Center</option>
                            <option value="top">Top</option>
                            <option value="bottom">Bottom</option>
                            <option value="left">Left</option>
                            <option value="right">Right</option>
                            <option value="cover">Cover (Fill)</option>
                            <option value="contain">Contain (Fit)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Debug & Logging -->
                <div class="settings-group">
                    <h4>Debug & Logging</h4>
                    <div class="setting-controls">
                        <button class="btn btn-info" onclick="window.open('/logs', '_blank')" title="Open log viewer in new tab">
                            üìã View Logs
                        </button>
                        <button class="btn btn-secondary" onclick="downloadConsoleLogs()" title="Download frontend console logs">
                            üì• Console Logs
                        </button>
                    </div>
                    <div class="setting-item" style="margin-top: 10px;">
                        <button class="btn btn-info" onclick="debugActiveAvatars()" title="Debug active avatars">
                            üîç Debug Avatars
                        </button>
                        <button class="btn btn-secondary" onclick="forceAutonomousConversation()" title="Force autonomous conversation">
                            ü§ñ Test Autonomous
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Help Panel -->
        <div class="help-panel" id="helpPanel">
            <div class="help-header">
                <div class="help-title">AI Companion Help</div>
                <button class="close-btn" onclick="toggleHelp()">√ó</button>
            </div>
            <div class="help-content">
                <h3>Getting Started</h3>
                <ul>
                    <li><strong>Load Models:</strong> Use the People panel to add Live2D character models</li>
                    <li><strong>Interact:</strong> Click and drag models to move them around the canvas</li>
                    <li><strong>Chat:</strong> Open the Chat panel to have conversations with your AI companions</li>
                    <li><strong>Customize:</strong> Use Settings to adjust voice, appearance, and behavior</li>
                </ul>
                
                <h3>Navigation</h3>
                <ul>
                    <li><strong>People Panel:</strong> Manage and add character models</li>
                    <li><strong>Chat Panel:</strong> Communicate with your AI companions</li>
                    <li><strong>Drawing Panel:</strong> Sketch and draw on the canvas</li>
                    <li><strong>Settings Panel:</strong> Configure models, voices, and system settings</li>
                </ul>
                
                <h3>Keyboard Shortcuts</h3>
                <ul>
                    <li><kbd>Ctrl+Shift+D</kbd> - Toggle debug console (dev mode)</li>
                    <li><kbd>Escape</kbd> - Close any open panel</li>
                    <li><kbd>F11</kbd> - Toggle fullscreen mode</li>
                </ul>
                
                <h3>Voice & Audio</h3>
                <ul>
                    <li><strong>Upload Voices:</strong> Add ONNX or PTH voice models in Settings</li>
                    <li><strong>Test Voices:</strong> Use the voice test feature to preview audio</li>
                    <li><strong>Character Voices:</strong> Assign specific voices to characters in Character Profiles</li>
                </ul>
                
                <h3>Troubleshooting</h3>
                <ul>
                    <li><strong>Models not loading:</strong> Check the debug console for errors (Ctrl+Shift+D)</li>
                    <li><strong>Voice issues:</strong> Ensure voice files are in supported formats (ONNX, PTH)</li>
                    <li><strong>Performance:</strong> Close unused panels and limit active models</li>
                </ul>
            </div>
        </div>
        
        <!-- Canvas Area -->
        <div class="canvas-container">
            <div class="canvas-frame">
                <div id="pixiContainer"></div>
                <!-- Drawing Overlay Canvas -->
                <canvas id="drawingOverlay" class="drawing-overlay-canvas" style="display: none;"></canvas>
            </div>
            <div class="loading-overlay" id="loadingOverlay" style="display: none;">
                <div class="loading-spinner"></div>
            </div>
        </div>
    </div>

    <!-- Model Selection Dialog -->
    <div class="model-selection-dialog" id="modelSelectionDialog" style="display: none;">
        <div class="dialog-overlay" onclick="closeAddModelDialog()"></div>
        <div class="dialog-content">
            <div class="dialog-header">
                <h3>Add Live2D Model</h3>
                <button class="dialog-close" onclick="closeAddModelDialog()">√ó</button>
            </div>
            <div class="dialog-body">
                <div class="model-grid" id="modelGrid">
                    <div style="text-align: center; padding: 20px; color: #aaa;">
                        Loading available models...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Selection Dialog -->
    <div class="user-selection-dialog" id="userSelectionDialog">
        <div class="dialog-content">
            <div class="dialog-header" style="cursor: move;">
                <h3>User Management</h3>
                <button class="dialog-close" onclick="closeUserDialog()">√ó</button>
            </div>
            <div class="dialog-body">
                <div class="user-selection-list" id="userSelectionList">
                    <div style="text-align: center; padding: 20px; color: #aaa;">
                        Loading users...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Profile Panel -->
    <div class="user-profile-panel" id="userProfilePanel">
        <div class="user-profile-header">
            <span class="user-profile-title">üë§ User Profile</span>
            <div class="window-controls">
                <button class="close-btn" onclick="closeUserProfile()">√ó</button>
            </div>
        </div>
        <div class="user-profile-content">
            <!-- Basic User Information Section -->
            <div class="user-section">
                <h4>User Information</h4>
                <div class="form-group">
                    <label for="userDisplayName">Display Name:</label>
                    <input type="text" id="userDisplayName" placeholder="Your display name" readonly>
                </div>
                <div class="form-group">
                    <label for="userUsername">Username:</label>
                    <input type="text" id="userUsername" placeholder="Your username" readonly>
                </div>
            </div>

            <!-- Personal Information Section -->
            <div class="user-section">
                <h4>Personal Information</h4>
                <div class="form-group">
                    <label for="userGender">Gender:</label>
                    <select id="userGender">
                        <option value="not_specified">Not Specified</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="non_binary">Non-Binary</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userAgeRange">Age Range:</label>
                    <select id="userAgeRange">
                        <option value="teen">Teen (13-17)</option>
                        <option value="young_adult">Young Adult (18-25)</option>
                        <option value="adult">Adult (26-35)</option>
                        <option value="middle_aged">Middle Aged (36-50)</option>
                        <option value="mature">Mature (51+)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userBio">Bio:</label>
                    <textarea id="userBio" placeholder="Tell us about yourself..." rows="3"></textarea>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="user-actions">
                <button class="btn btn-primary" onclick="saveUserProfile()">Save Profile</button>
                <button class="btn btn-secondary" onclick="closeUserProfile()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Character Profiles Panel -->
    <div class="character-profiles-panel" id="characterProfilesPanel">
        <div class="character-profiles-header">
            <span class="character-profiles-title">üé≠ Character Profiles</span>
            <div class="window-controls">
                <button class="close-btn" onclick="closeCharacterProfiles()">√ó</button>
            </div>
        </div>
        <div class="character-profiles-content">
            <!-- Character Selection Section -->
            <div class="character-section">
                <h4>Character Selection</h4>
                <div class="form-group">
                    <label for="characterSelect">Select Character:</label>
                    <select id="characterSelect" onchange="onCharacterChange()">
                        <option value="">Loading characters...</option>
                    </select>
                </div>
                <div class="character-controls">
                    <button class="btn btn-primary" onclick="createNewCharacter()">New Character</button>
                    <button class="btn btn-secondary" onclick="duplicateCharacter()">Duplicate</button>
                    <button class="btn btn-warning" onclick="deleteCharacter()">Delete</button>
                </div>
            </div>

            <!-- Character Information Section -->
            <div class="character-section">
                <h4>Character Information</h4>
                <div class="form-group">
                    <label for="characterName">Name:</label>
                    <input type="text" id="characterName" placeholder="Character name">
                </div>
                <div class="form-group">
                    <label for="characterDescription">Description:</label>
                    <textarea id="characterDescription" placeholder="Character description..." rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="characterAge">Age:</label>
                    <input type="text" id="characterAge" placeholder="Character age">
                </div>
                <div class="form-group">
                    <label for="characterPersonality">Personality:</label>
                    <textarea id="characterPersonality" placeholder="Character personality traits..." rows="4"></textarea>
                </div>
            </div>

            <!-- Model & Voice Assignment Section -->
            <div class="character-section">
                <h4>Model & Voice Assignment</h4>
                <div class="form-group">
                    <label for="characterDefaultModel">Default Model:</label>
                    <select id="characterDefaultModel" class="form-select">
                        <option value="">Select default model...</option>
                    </select>
                    <small class="form-help">Primary model file for this character (when multiple models exist)</small>
                </div>
                <div class="form-group">
                    <label for="characterVoice">Assigned Voice:</label>
                    <select id="characterVoice" class="form-select">
                        <option value="">Select voice...</option>
                    </select>
                    <small class="form-help">Voice model for text-to-speech synthesis</small>
                </div>
                <div class="form-group">
                    <label for="characterVoiceSettings">Voice Settings:</label>
                    <div class="voice-settings-grid">
                        <div class="voice-setting">
                            <label for="voicePitch">Pitch: <span id="voicePitchValue">1.0</span></label>
                            <input type="range" id="voicePitch" min="0.5" max="2.0" step="0.1" value="1.0" oninput="updateVoiceSetting('pitch', this.value)">
                        </div>
                        <div class="voice-setting">
                            <label for="voiceSpeed">Speed: <span id="voiceSpeedValue">1.0</span></label>
                            <input type="range" id="voiceSpeed" min="0.5" max="2.0" step="0.1" value="1.0" oninput="updateVoiceSetting('speed', this.value)">
                        </div>
                        <div class="voice-setting">
                            <label for="voiceVolume">Volume: <span id="voiceVolumeValue">1.0</span></label>
                            <input type="range" id="voiceVolume" min="0.1" max="2.0" step="0.1" value="1.0" oninput="updateVoiceSetting('volume', this.value)">
                        </div>
                    </div>
                </div>
                <div class="character-voice-test">
                    <input type="text" id="characterVoiceTestText" placeholder="Test voice with this text..." class="form-input">
                    <button class="btn btn-secondary" onclick="testCharacterVoice()" disabled id="testCharacterVoiceBtn">
                        üîä Test Character Voice
                    </button>
                </div>
            </div>

            <!-- Character Appearance Section -->
            <div class="character-section">
                <h4>Appearance</h4>
                <div class="form-group">
                    <label for="characterAppearance">Physical Description:</label>
                    <textarea id="characterAppearance" placeholder="Physical appearance..." rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="characterOutfit">Outfit:</label>
                    <textarea id="characterOutfit" placeholder="Clothing and style..." rows="2"></textarea>
                </div>
            </div>

            <!-- Character Background Section -->
            <div class="character-section">
                <h4>Background & History</h4>
                <div class="form-group">
                    <label for="characterBackground">Background:</label>
                    <textarea id="characterBackground" placeholder="Character history and background..." rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="characterGoals">Goals & Motivations:</label>
                    <textarea id="characterGoals" placeholder="What drives this character..." rows="3"></textarea>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="character-actions">
                <button class="btn btn-primary" onclick="saveCharacterProfile()">Save Character</button>
                <button class="btn btn-secondary" onclick="exportCharacter()">Export</button>
                <button class="btn btn-secondary" onclick="importCharacter()">Import</button>
            </div>
        </div>
    </div>

    <!-- User Management Panel -->
    <div class="user-management-panel" id="userManagementPanel">
        <div class="user-management-header">
            <span class="user-management-title">üë• User Management</span>
            <div class="window-controls">
                <button class="close-btn" onclick="closeUserManagement()">√ó</button>
            </div>
        </div>
        <div class="user-management-content">
            <!-- User Selection Section -->
            <div class="user-section">
                <h4>User Selection</h4>
                <div class="form-group">
                    <label for="userSelect">Select User:</label>
                    <select id="userSelect" onchange="onUserChange()">
                        <option value="">Select a user...</option>
                    </select>
                </div>
                <div class="user-controls">
                    <button class="btn btn-primary" onclick="createNewUser()">New User</button>
                    <button class="btn btn-secondary" onclick="duplicateUser()">Duplicate</button>
                    <button class="btn btn-warning" onclick="deleteUser()">Delete</button>
                </div>
            </div>

            <!-- Basic Information Section -->
            <div class="user-section">
                <h4>Basic Information</h4>
                <div class="form-group">
                    <label for="userName">Username: *</label>
                    <input type="text" id="userName" placeholder="Username (required)" required>
                </div>
                <div class="form-group">
                    <label for="newUserDisplayName">Display Name:</label>
                    <input type="text" id="newUserDisplayName" placeholder="Display name">
                </div>
                <div class="form-group">
                    <label for="userEmail">Email:</label>
                    <input type="email" id="userEmail" placeholder="user@example.com">
                </div>
                <div class="form-group">
                    <label for="userPassword">Password:</label>
                    <input type="password" id="userPassword" placeholder="Enter password">
                </div>
            </div>

            <!-- User Role & Permissions Section -->
            <div class="user-section">
                <h4>Role & Permissions</h4>
                <div class="form-group">
                    <label for="userRole">Role:</label>
                    <select id="userRole">
                        <option value="user">User</option>
                        <option value="moderator">Moderator</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Permissions:</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" id="permissionChat"> Chat Access</label>
                        <label><input type="checkbox" id="permissionDrawing"> Drawing Tools</label>
                        <label><input type="checkbox" id="permissionCharacters"> Character Management</label>
                        <label><input type="checkbox" id="permissionUserMgmt"> User Management</label>
                        <label><input type="checkbox" id="permissionSettings"> System Settings</label>
                    </div>
                </div>
            </div>

            <!-- Demographics Section -->
            <div class="user-section">
                <h4>Demographics</h4>
                <div class="form-group">
                    <label for="userAge">Age Range:</label>
                    <select id="userAge">
                        <option value="under-12">Under 12</option>
                        <option value="12-17">12-17 years</option>
                        <option value="18-24">18-24 years</option>
                        <option value="25-34">25-34 years</option>
                        <option value="35-44">35-44 years</option>
                        <option value="45-54">45-54 years</option>
                        <option value="55-64">55-64 years</option>
                        <option value="65-plus">65+ years</option>
                        <option value="prefer-not-to-say">Prefer not to say</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userGender">Gender:</label>
                    <select id="userGender">
                        <option value="not-specified">Not specified</option>
                        <option value="female">Female</option>
                        <option value="male">Male</option>
                        <option value="non-binary">Non-binary</option>
                        <option value="other">Other</option>
                        <option value="prefer-not-to-say">Prefer not to say</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userLocation">Location:</label>
                    <input type="text" id="userLocation" placeholder="City, Country">
                </div>
            </div>

            <!-- Personal Characteristics Section -->
            <div class="user-section">
                <h4>Personal Characteristics</h4>
                <div class="form-group">
                    <label for="userPersonality">Personality Traits:</label>
                    <textarea id="userPersonality" placeholder="Describe personality traits, communication style, etc..." rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="userInterests">Interests & Hobbies:</label>
                    <textarea id="userInterests" placeholder="What are you interested in? Gaming, art, music, sports, etc..." rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="userLikes">Likes:</label>
                    <textarea id="userLikes" placeholder="Things you enjoy, favorite activities, foods, etc..." rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label for="userDislikes">Dislikes:</label>
                    <textarea id="userDislikes" placeholder="Things you don't enjoy or want to avoid..." rows="2"></textarea>
                </div>
            </div>

            <!-- Communication Preferences Section -->
            <div class="user-section">
                <h4>Communication Preferences</h4>
                <div class="form-group">
                    <label for="userCommunicationStyle">Communication Style:</label>
                    <select id="userCommunicationStyle">
                        <option value="casual">Casual & Friendly</option>
                        <option value="formal">Formal & Professional</option>
                        <option value="playful">Playful & Humorous</option>
                        <option value="direct">Direct & Concise</option>
                        <option value="supportive">Supportive & Encouraging</option>
                        <option value="intellectual">Intellectual & Analytical</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userLanguagePreference">Language Preference:</label>
                    <select id="userLanguagePreference">
                        <option value="en">English</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                        <option value="ja">Japanese</option>
                        <option value="ko">Korean</option>
                        <option value="zh">Chinese</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>

            <!-- Content Preferences Section -->
            <div class="user-section">
                <h4>Content Preferences</h4>
                <div class="form-group">
                    <label>Content Filtering:</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" id="contentNSFW"> Allow NSFW Content</label>
                        <label><input type="checkbox" id="contentMature"> Allow Mature Themes</label>
                        <label><input type="checkbox" id="contentViolence"> Allow Violence</label>
                        <label><input type="checkbox" id="contentProfanity"> Allow Strong Language</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="userContentPreferences">Content Preferences:</label>
                    <textarea id="userContentPreferences" placeholder="What type of content do you prefer? Topics to focus on or avoid..." rows="3"></textarea>
                </div>
            </div>

            <!-- Notes Section -->
            <div class="user-section">
                <h4>Additional Notes</h4>
                <div class="form-group">
                    <label for="userNotes">Admin Notes:</label>
                    <textarea id="userNotes" placeholder="Internal notes about this user..." rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="userBio">Public Bio:</label>
                    <textarea id="userBio" placeholder="Public bio that may be shared with other users..." rows="3"></textarea>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="user-actions">
                <button class="btn btn-primary" onclick="saveUserProfile()">Save User</button>
                <button class="btn btn-secondary" onclick="exportUser()">Export</button>
                <button class="btn btn-secondary" onclick="importUser()">Import</button>
                <button class="btn btn-info" onclick="sendPasswordReset()">Send Password Reset</button>
            </div>

            <!-- Status Message -->
            <div id="userManagementStatus" class="status-message" style="display: none;"></div>
        </div>
    </div>

    <!-- Drawing Panel -->
    <div class="drawing-panel resizable-panel" id="drawingPanel">
        <div class="drawing-header">
            <span class="drawing-title">üé® Drawing Tools</span>
            <div class="window-controls">
                <button class="control-btn" onclick="toggleDrawingResize()" title="Toggle Resize">‚§°</button>
                <button class="close-btn" onclick="closeDrawing()">√ó</button>
            </div>
        </div>
        <div class="drawing-content">
            <!-- Drawing Mode Control -->
            <div class="drawing-section">
                <h4>Drawing Mode</h4>
                <div class="mode-controls">
                    <button class="btn btn-primary" id="toggleDrawingMode" onclick="toggleDrawingMode()" title="Toggle between drawing and Live2D interaction">
                        üé® Enable Drawing Mode
                    </button>
                    <div class="mode-info">
                        <small>Drawing mode disabled - Live2D interaction active</small>
                    </div>
                </div>
            </div>
            
            <!-- Tool Selection Section -->
            <div class="drawing-section">
                <h4>Basic Drawing Tools</h4>
                <div class="tool-grid horizontal">
                    <button class="tool-btn active" onclick="selectTool('pen')" data-tool="pen" title="Pen">‚úèÔ∏è</button>
                    <button class="tool-btn" onclick="selectTool('brush')" data-tool="brush" title="Brush">üñåÔ∏è</button>
                    <button class="tool-btn" onclick="selectTool('pencil')" data-tool="pencil" title="Pencil">‚úé</button>
                    <button class="tool-btn" onclick="selectTool('marker')" data-tool="marker" title="Marker">üñäÔ∏è</button>
                    <button class="tool-btn" onclick="selectTool('eraser')" data-tool="eraser" title="Eraser">üßΩ</button>
                </div>
                
                <h4>Textured Brushes</h4>
                <div class="tool-grid horizontal">
                    <button class="tool-btn" onclick="selectTool('oil')" data-tool="oil" title="Oil Paint">üé®</button>
                    <button class="tool-btn" onclick="selectTool('watercolor')" data-tool="watercolor" title="Watercolor">üíß</button>
                    <button class="tool-btn" onclick="selectTool('chalk')" data-tool="chalk" title="Chalk">‚ö™</button>
                    <button class="tool-btn" onclick="selectTool('charcoal')" data-tool="charcoal" title="Charcoal">‚ö´</button>
                    <button class="tool-btn" onclick="selectTool('spray')" data-tool="spray" title="Spray Paint">üí®</button>
                </div>
                
                <h4>Pattern Brushes</h4>
                <div class="tool-grid horizontal">
                    <button class="tool-btn" onclick="selectTool('stipple')" data-tool="stipple" title="Stipple">‚Ä¢‚Ä¢‚Ä¢</button>
                    <button class="tool-btn" onclick="selectTool('crosshatch')" data-tool="crosshatch" title="Crosshatch">‚öè</button>
                    <button class="tool-btn" onclick="selectTool('fur')" data-tool="fur" title="Fur Texture">ü¶î</button>
                    <button class="tool-btn" onclick="selectTool('grass')" data-tool="grass" title="Grass Texture">ÔøΩ</button>
                </div>
                
                <h4>Calligraphy & Special</h4>
                <div class="tool-grid horizontal">
                    <button class="tool-btn" onclick="selectTool('calligraphy')" data-tool="calligraphy" title="Calligraphy">üñãÔ∏è</button>
                    <button class="tool-btn" onclick="selectTool('clone')" data-tool="clone" title="Clone/Stamp">üìã</button>
                    <button class="tool-btn" onclick="selectTool('smudge')" data-tool="smudge" title="Smudge">üëÜ</button>
                    <button class="tool-btn" onclick="selectTool('blur')" data-tool="blur" title="Blur Effect">üå´Ô∏è</button>
                </div>
            </div>

            <!-- Shape Tools -->
            <div class="drawing-section">
                <h4>Shape Tools</h4>
                <div class="tool-grid horizontal">
                    <button class="tool-btn" onclick="selectTool('line')" data-tool="line" title="Line">üìè</button>
                    <button class="tool-btn" onclick="selectTool('rectangle')" data-tool="rectangle" title="Rectangle">‚¨ú</button>
                    <button class="tool-btn" onclick="selectTool('circle')" data-tool="circle" title="Circle">‚≠ï</button>
                    <button class="tool-btn" onclick="selectTool('ellipse')" data-tool="ellipse" title="Ellipse">‚≠ï</button>
                    <button class="tool-btn" onclick="selectTool('polygon')" data-tool="polygon" title="Polygon">‚¨ü</button>
                    <button class="tool-btn" onclick="selectTool('arrow')" data-tool="arrow" title="Arrow">‚û°Ô∏è</button>
                </div>
            </div>

            <!-- Selection & Transform Tools -->
            <div class="drawing-section">
                <h4>Selection & Transform</h4>
                <div class="tool-grid horizontal">
                    <button class="tool-btn" onclick="selectTool('select')" data-tool="select" title="Rectangle Select">üî≤</button>
                    <button class="tool-btn" onclick="selectTool('ellipse-select')" data-tool="ellipse-select" title="Ellipse Select">‚≠ï</button>
                    <button class="tool-btn" onclick="selectTool('lasso')" data-tool="lasso" title="Lasso Select">ü™¢</button>
                    <button class="tool-btn" onclick="selectTool('magic-wand')" data-tool="magic-wand" title="Magic Wand">ü™Ñ</button>
                    <button class="tool-btn" onclick="selectTool('move')" data-tool="move" title="Move/Transform">‚ÜîÔ∏è</button>
                    <button class="tool-btn" onclick="selectTool('crop')" data-tool="crop" title="Crop Tool">‚úÇÔ∏è</button>
                </div>
                <div class="tool-grid horizontal">
                    <button class="tool-btn" onclick="selectTool('rotate')" data-tool="rotate" title="Rotate">üîÑ</button>
                    <button class="tool-btn" onclick="selectTool('scale')" data-tool="scale" title="Scale">üìê</button>
                    <button class="tool-btn" onclick="selectTool('skew')" data-tool="skew" title="Skew">üìê</button>
                    <button class="tool-btn" onclick="selectTool('perspective')" data-tool="perspective" title="Perspective">üé≠</button>
                    <button class="tool-btn" onclick="selectTool('liquify')" data-tool="liquify" title="Liquify">üåÄ</button>
                    <button class="tool-btn" onclick="selectTool('eyedropper')" data-tool="eyedropper" title="Eyedropper">üíß</button>
                </div>
            </div>

            <!-- Smart Drawing Features -->
            <div class="drawing-section">
                <h4>Smart Drawing</h4>
                <div class="smart-controls">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="stabilizeLines" onchange="toggleStabilization(this.checked)"> 
                            Line Stabilization
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="shapeRecognition" onchange="toggleShapeRecognition(this.checked)"> 
                            Shape Recognition
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="symmetryMode" onchange="toggleSymmetry(this.checked)"> 
                            Symmetry Mode
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="pressureSensitivity" onchange="togglePressure(this.checked)"> 
                            Pressure Sensitivity
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="vectorMode" onchange="toggleVectorMode(this.checked)"> 
                            Vector Mode
                        </label>
                    </div>
                </div>
            </div>

            <!-- AI-Powered Tools -->
            <div class="drawing-section">
                <h4>AI-Powered Tools</h4>
                <div class="ai-controls">
                    <button class="btn btn-primary" onclick="requestAvatarFeedback()" title="Ask avatar for drawing feedback and critique">ü§ñ Get Avatar Feedback</button>
                    <button class="btn btn-secondary" onclick="autoCompleteDrawing()" title="AI suggests completion">‚ú® Auto-Complete</button>
                    <button class="btn btn-secondary" onclick="applyStyleTransfer()" title="Apply artistic styles">üé® Style Transfer</button>
                    <button class="btn btn-secondary" onclick="removeBackground()" title="AI-powered background removal">üóëÔ∏è Remove Background</button>
                    <button class="btn btn-secondary" onclick="smartSelection()" title="AI-assisted object selection">üéØ Smart Select</button>
                    <button class="btn btn-secondary" onclick="generatePoseReference()" title="Generate pose guides">üö∂ Pose Reference</button>
                </div>
                
                <div class="smart-controls">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="autonomous-feedback-toggle" checked>
                            Autonomous Commentary
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="feedback-frequency">Feedback Frequency:</label>
                        <select id="feedback-frequency" class="form-control">
                            <option value="low">Low (25s intervals)</option>
                            <option value="medium" selected>Medium (15s intervals)</option>
                            <option value="high">High (8s intervals)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Color and Size Section -->
            <div class="drawing-section">
                <h4>Color & Size</h4>
                <div class="form-group">
                    <label for="colorPicker">Current Color:</label>
                    <div class="color-picker-row">
                        <input type="color" id="colorPicker" value="#000000" onchange="setDrawingColor(this.value)">
                        <button class="btn btn-mini" onclick="showColorPalette()" title="Show/Hide Color Palette">üé® Palette</button>
                    </div>
                </div>
                <div class="color-history" id="colorHistory">
                    <div class="color-history-label">Recent Colors (click to expand palette):</div>
                    <!-- Recent colors will appear here -->
                </div>
                
                <div class="form-group">
                    <label for="brushSize">Brush Size: <span id="brushSizeValue">5</span>px</label>
                    <input type="range" id="brushSize" min="1" max="100" value="5" oninput="setBrushSize(this.value)" class="slider">
                </div>
                
                <div class="form-group">
                    <label for="opacitySlider">Opacity: <span id="opacityValue">100</span>%</label>
                    <input type="range" id="opacitySlider" min="0" max="100" value="100" oninput="setOpacity(this.value)" class="slider">
                </div>
                
                <div class="form-group">
                    <label for="flowSlider">Flow: <span id="flowValue">100</span>%</label>
                    <input type="range" id="flowSlider" min="1" max="100" value="100" oninput="setFlow(this.value)" class="slider">
                </div>
                
                <div class="form-group">
                    <label for="hardnessSlider">Hardness: <span id="hardnessValue">100</span>%</label>
                    <input type="range" id="hardnessSlider" min="0" max="100" value="100" oninput="setHardness(this.value)" class="slider">
                </div>
                
                <div class="form-group">
                    <label for="spacingSlider">Spacing: <span id="spacingValue">25</span>%</label>
                    <input type="range" id="spacingSlider" min="1" max="300" value="25" oninput="setSpacing(this.value)" class="slider">
                </div>
            </div>

            <!-- Layers Section -->
            <div class="drawing-section">
                <h4>Layers</h4>
                <div class="layers-list" id="layersList">
                    <div class="layer-item active">
                        <span class="layer-name">Background</span>
                        <div class="layer-controls">
                            <button class="layer-btn" onclick="toggleLayerVisibility(0)" title="Toggle Visibility">üëÅÔ∏è</button>
                            <button class="layer-btn" onclick="setLayerBlendMode(0)" title="Blend Mode">üîÄ</button>
                            <button class="layer-btn" onclick="deleteLayer(0)" title="Delete Layer">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
                <div class="layer-controls">
                    <button class="btn btn-secondary" onclick="addNewLayer()">Add Layer</button>
                    <button class="btn btn-secondary" onclick="mergeDown()">Merge Down</button>
                    <button class="btn btn-secondary" onclick="duplicateLayer()">Duplicate</button>
                </div>
            </div>

            <!-- Live2D Integration -->
            <div class="drawing-section">
                <h4>Live2D Integration</h4>
                <div class="live2d-controls">
                    <button class="btn btn-primary" onclick="enableModelTracing()" title="Trace over Live2D model">üìù Model Trace</button>
                    <button class="btn btn-secondary" onclick="captureModelPose()" title="Capture current pose as reference">üì∏ Capture Pose</button>
                    <button class="btn btn-secondary" onclick="toggleModelOutline()" title="Show model outline for reference">üî≤ Show Outline</button>
                    <button class="btn btn-secondary" onclick="recordMotion()" title="Record model movements as guides">üé¨ Record Motion</button>
                </div>
                
                <h4>Live2D Specific Tools</h4>
                <div class="live2d-controls">
                    <button class="btn btn-accent" onclick="costumeDesigner()" title="Draw directly on model as texture overlay">üëó Costume Designer</button>
                    <button class="btn btn-accent" onclick="expressionSketching()" title="Quick emotion sketches over face">üòä Expression Sketch</button>
                    <button class="btn btn-accent" onclick="emotionOverlay()" title="Draw emotions that trigger expressions">üí≠ Emotion Overlay</button>
                    <button class="btn btn-accent" onclick="interactiveAnnotations()" title="Clickable drawings that trigger actions">üìå Interactive Notes</button>
                    <button class="btn btn-accent" onclick="costumePainter()" title="Paint directly onto model textures">üé® Costume Painter</button>
                    <button class="btn btn-accent" onclick="sceneCreator()" title="Draw backgrounds that interact with model">üåÑ Scene Creator</button>
                </div>
            </div>

            <!-- History & Undo -->
            <div class="drawing-section">
                <h4>History & Actions</h4>
                <div class="history-controls">
                    <button class="btn btn-secondary" onclick="undoAction()" title="Undo last action">‚Ü∂ Undo</button>
                    <button class="btn btn-secondary" onclick="redoAction()" title="Redo last undone action">‚Ü∑ Redo</button>
                    <button class="btn btn-secondary" onclick="showHistoryTimeline()" title="Show action timeline">üìã History Panel</button>
                    <button class="btn btn-secondary" onclick="createBranch()" title="Create alternate version">üåø Branch History</button>
                </div>
                <div class="snapshot-controls">
                    <button class="btn btn-primary" onclick="saveSnapshot()" title="Save current state">üì∑ Snapshot</button>
                    <button class="btn btn-secondary" onclick="loadSnapshot()" title="Load saved state">üìÇ Load Snapshot</button>
                    <button class="btn btn-secondary" onclick="compareSnapshots()" title="Compare different states">‚öñÔ∏è Compare</button>
                </div>
                
                <h4>Edit Actions</h4>
                <div class="edit-controls">
                    <button class="btn btn-secondary" onclick="copySelection()" title="Copy selected area">üìã Copy</button>
                    <button class="btn btn-secondary" onclick="pasteSelection()" title="Paste from clipboard">üìÑ Paste</button>
                    <button class="btn btn-secondary" onclick="cutSelection()" title="Cut selected area">‚úÇÔ∏è Cut</button>
                    <button class="btn btn-secondary" onclick="pasteExternal()" title="Paste from external apps">üìã Paste External</button>
                </div>
            </div>

            <!-- Advanced Features -->
            <div class="drawing-section">
                <h4>Story Mode & Visual Novels</h4>
                <div class="story-controls">
                    <button class="btn btn-primary" onclick="enterStoryMode()" title="Create interactive visual novels">üìñ Story Mode</button>
                    <button class="btn btn-secondary" onclick="addDialogueBubble()" title="Add speech bubbles">üí¨ Dialogue Bubble</button>
                    <button class="btn btn-secondary" onclick="addNarrationBox()" title="Add narration text">üìù Narration Box</button>
                    <button class="btn btn-secondary" onclick="createChoicePoint()" title="Add decision points">üîÄ Choice Point</button>
                </div>
            </div>

            <!-- Canvas Controls Section -->
            <div class="drawing-section">
                <h4>Canvas Actions</h4>
                <div class="canvas-info">
                    <p>Drawing canvas overlays the main Live2D area.</p>
                    <p><strong>Usage:</strong> Enable drawing mode above to draw over Live2D models.</p>
                </div>
                <div class="canvas-controls">
                    <button class="btn btn-warning" onclick="clearCanvas()" title="Clear all drawing">üóëÔ∏è Clear Canvas</button>
                    <button class="btn btn-primary" onclick="saveDrawing()" title="Save drawing to gallery">üíæ Save Drawing</button>
                    <button class="btn btn-secondary" onclick="exportPNG()" title="Export as PNG image">üì§ Export PNG</button>
                    <button class="btn btn-secondary" onclick="exportSVG()" title="Export as vector SVG">üì§ Export SVG</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI Feedback Display -->
    <div class="ai-feedback">
        <div class="feedback-header">
            <span>ü§ñ</span> Avatar Feedback
        </div>
        <div class="feedback-text">
            Your AI companion will provide drawing feedback here...
        </div>
    </div>
    
    <!-- History Timeline -->
    <div class="history-timeline">
        <h4 style="margin: 0 0 12px 0; color: #fff; font-size: 14px;">Drawing History</h4>
        <div class="timeline-item current">
            <div class="timeline-icon">üé®</div>
            <div class="timeline-text">Initial canvas</div>
            <div class="timeline-time">Now</div>
        </div>
    </div>

<!-- Load PIXI.js and Live2D libraries in correct order -->
<!-- Step 1: Load PIXI.js 6.5.10 from dist folder -->
<script src="/static/dist/pixi-6.5.10.min.js"></script>

<!-- Step 2: Load EventEmitter compatibility for PIXI v6 -->
<script src="/static/js/eventemitter_preloader_v6.js"></script>

<!-- Step 3: Load Live2D v2 Bundle for Cubism 2.x models -->
<script src="/static/dist/live2d_bundle.js"></script>

<!-- Step 4: Load Cubism 5 Core for modern models -->
<script src="/static/dist/CubismSdkForWeb-5-r.4/Core/live2dcubismcore.min.js"></script>

<!-- Step 6: Verify dual architecture setup -->
<script>
console.log('=== Dual Architecture Verification ===');
console.log('PIXI version:', typeof PIXI !== 'undefined' ? PIXI.VERSION : 'Not loaded');
console.log('EventEmitter available:', typeof EventEmitter !== 'undefined');
console.log('Live2D v2 Bundle loaded:', typeof window.Live2D !== 'undefined');
console.log('Cubism 5 Core loaded:', typeof window.Live2DCubismCore !== 'undefined');

// Debug Live2D v2 Bundle
if (typeof window.Live2D !== 'undefined') {
    console.log('‚úì Live2D v2 Bundle ready for Cubism 2.x models');
    console.log('- window.Live2D:', typeof window.Live2D);
    console.log('- window.Live2DModelWebGL:', typeof window.Live2DModelWebGL);
    console.log('- window.live2dv2:', typeof window.live2dv2);
}

// Debug Cubism 5 Core
if (typeof window.Live2DCubismCore !== 'undefined') {
    console.log('‚úì Cubism 5 Core ready for modern models');
    console.log('- Core version:', window.Live2DCubismCore.Version ? window.Live2DCubismCore.Version.csmGetVersion() : 'unknown');
}

console.log('=== End Verification ===');
</script>

<!-- Step 5: Load pixi-live2d-display (local for offline installation) -->
<script src="/static/dist/pixi-live2d-display-0.4.0.min.js"></script>

<!-- Step 5: Verify Live2D plugin initialization -->
<script>
// AI Companion API Configuration - Dynamic configuration loading
window.ai2d_chat_CONFIG = {
    // Always use empty string to force relative URLs - works with any proxy setup
    API_BASE_URL: '',
    
    // Configuration loading status
    _configLoaded: false,
    _configPromise: null
};

// Function to load server configuration dynamically
async function loadServerConfig() {
    if (window.ai2d_chat_CONFIG._configLoaded) {
        return window.ai2d_chat_CONFIG;
    }
    
    if (window.ai2d_chat_CONFIG._configPromise) {
        return window.ai2d_chat_CONFIG._configPromise;
    }
    
    window.ai2d_chat_CONFIG._configPromise = (async () => {
        try {
            console.log('Loading server configuration from API...');
            
            // Always use relative URLs for API calls - this works with proxies automatically
            const configResponse = await fetch('/api/system/config');
            if (configResponse.ok) {
                const serverConfig = await configResponse.json();
                
                // Store server config for reference but don't change API_BASE_URL
                window.ai2d_chat_CONFIG.serverConfig = serverConfig;
                window.ai2d_chat_CONFIG._configLoaded = true;
                
                console.log('‚úÖ Server configuration loaded successfully, using relative URLs for all API calls');
                return window.ai2d_chat_CONFIG;
            } else {
                throw new Error(`Config API returned ${configResponse.status}`);
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è Failed to load server config from API, continuing with relative URLs:', error.message);
            
            // Always use relative URLs as fallback
            window.ai2d_chat_CONFIG._configLoaded = true;
            
            console.log('Using relative URLs for all API calls (proxy-compatible)');
            return window.ai2d_chat_CONFIG;
        }
    })();
    
    return window.ai2d_chat_CONFIG._configPromise;
}

// Initialize configuration
console.log('AI Companion API Config: Using relative URLs (proxy-compatible)');

// Helper function for making API calls with relative URLs
window.makeApiCall = async function(endpoint, options = {}) {
    // Always use relative URLs - let the browser and proxy handle the rest
    const url = endpoint.startsWith('/') ? endpoint : `/${endpoint}`;
    console.log(`Making API call to: ${url}`);
    
    return fetch(url, options);
};
</script>

<script>
// Initialize Live2D plugin following Live2D Viewer Web pattern
console.log('Initializing Live2D plugin (Live2D Viewer Web compatible)...');

// Wait for all scripts to load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        console.log('Checking library compatibility...');
        
        // Verify libraries are loaded
        if (typeof PIXI === 'undefined') {
            console.error('PIXI.js not loaded');
            return;
        }
        
        if (typeof EventEmitter === 'undefined') {
            console.error('EventEmitter not available');
            return;
        }
        
        console.log('‚úì PIXI version:', PIXI.VERSION);
        console.log('‚úì EventEmitter type:', typeof EventEmitter);
        
        // Check if PIXI.utils.EventEmitter exists (Live2D Viewer Web pattern)
        if (PIXI.utils && PIXI.utils.EventEmitter) {
            console.log('‚úì PIXI.utils.EventEmitter available (Live2D Viewer Web compatible)');
        }
        
        // Check if Live2D plugin is available
        if (typeof PIXI.live2d === 'undefined') {
            console.error('‚úó PIXI.live2d not loaded - pixi-live2d-display may not be compatible');
            console.log('Available PIXI properties:', Object.keys(PIXI));
            
            // Try to diagnose the issue
            if (window.pixiLive2DLoadError) {
                console.error('Library loading error detected - check network tab');
            }
        } else {
            console.log('‚úì PIXI.live2d loaded successfully');
            console.log('Available PIXI.live2d properties:', Object.keys(PIXI.live2d));
            
            // Check for Live2DModel
            if (PIXI.live2d.Live2DModel) {
                console.log('‚úì Live2DModel class available');
                window.Live2DModel = PIXI.live2d.Live2DModel;
                
                // Test if it has the expected methods
                if (typeof PIXI.live2d.Live2DModel.from === 'function') {
                    console.log('‚úì Live2DModel.from() method available');
                } else {
                    console.warn('Live2DModel.from() method not found');
                }
            } else {
                console.warn('Live2DModel not found in PIXI.live2d');
            }
            
            // Check for Live2DFactory
            if (PIXI.live2d.Live2DFactory) {
                console.log('‚úì Live2DFactory available');
                window.Live2DFactory = PIXI.live2d.Live2DFactory;
            } else {
                console.warn('Live2DFactory not found in PIXI.live2d');
            }
        }
        
        console.log('Live2D plugin initialization check complete');
        console.log('System ready for Live2D model loading');
        
        // NOW INITIALIZE THE LIVE2D SYSTEM
        if (typeof initializeLive2D === 'function') {
            console.log('Starting Live2D modular system initialization...');
            
            // Load server configuration before initializing Live2D
            loadServerConfig().then(() => {
                console.log('Server configuration loaded, initializing Live2D...');
                return initializeLive2D();
            }).then(() => {
                console.log('Live2D system initialization complete!');
            }).catch(error => {
                console.error('Live2D system initialization failed:', error);
            });
        } else {
            console.error('initializeLive2D function not found!');
        }
        
    }, 500); // Increased delay to ensure all libraries are loaded
});
</script>

<!-- Step 5: Load Live2D modular system -->
    
    <script src="/static/js/live2d_modules/live2d_config.js"></script>
    <script src="/static/js/live2d_modules/live2d_core.js"></script>  
    <script src="/static/js/live2d_modules/live2d_core_simple.js"></script>
    <script src="/static/js/live2d_modules/live2d_integration.js"></script>
    <script src="/static/js/live2d_modules/live2d_interaction.js"></script>
    <script src="/static/js/live2d_modules/live2d_logger.js"></script>
    <script src="/static/js/live2d_modules/live2d_model_loader.js"></script>
    <script src="/static/js/live2d_modules/live2d_model_manager.js"></script>
    <script src="/static/js/live2d_modules/live2d_model_import_manager.js"></script>
    <script src="/static/js/live2d_modules/live2d_motion_manager.js"></script>
    <script src="/static/js/live2d_modules/live2d_motions.js"></script>
    <script src="/static/js/live2d_modules/live2d_mouse_interaction.js"></script>    
    <script src="/static/js/live2d_modules/live2d_multi_model_manager.js"></script>    
    <script src="/static/js/live2d_modules/live2d_simple_fix.js"></script>    
    <script src="/static/js/live2d_modules/live2d_tester.js"></script>
    <script src="/static/js/live2d_modules/live2d_ui_controller.js"></script>
    <script src="/static/js/live2d_modules/live2d_state_manager.js"></script>

    <!-- UI components -->
    <script src="/static/js/ui_modules/ui_drawing_system.js"></script>
    <script src="/static/js/ui_modules/ui_icon_manager.js"></script>     
    <script src="/static/js/ui_modules/ui_people_panel.js"></script>
    <script src="/static/js/ui_modules/ui_panel_manager.js"></script>
    <script src="/static/js/ui_modules/ui_character_profiles.js"></script>
    <script src="/static/js/ui_modules/ui_user_management.js"></script>
    <script src="/static/js/ui_modules/ui_user_selection.js"></script>
    <script src="/static/js/ui_modules/ui_debug_console.js"></script>
    <script src="/static/js/ui_modules/ui_debug_logger.js"></script>
    <script src="/static/js/ui_modules/ui_user_profile.js"></script>    

    <!-- Audio Processing -->
    <script src="/static/js/audio_modules/audio_context_manager.js"></script>
    <script src="/static/js/audio_modules/audio_queue_manager.js"></script>
    <script src="/static/js/audio_modules/audio_queue_control_panel.js"></script>
    <script src="/static/js/audio_modules/audio_queue_testing.js"></script>
    <script src="/static/js/audio_modules/audio_voice_recording.js"></script>
    <script src="/static/js/audio_modules/audio_tts.js"></script> 

    <!-- Chat components -->
    <script src="/static/js/chat_modules/avatar_interaction_manager.js"></script>
    <script src="/static/js/chat_modules/avatar_personality_manager.js"></script>
    <script src="/static/js/chat_modules/chat_character_manager.js"></script>
    <script src="/static/js/chat_modules/chat_manager.js"></script>    

    <!-- Additional Functionality -->
    <script src="/static/js/console_logger.js"></script>
    <script src="/static/js/autonomous_avatars.js"></script>
    <script src="/static/js/db_manager.js"></script>
    <script src="/static/js/config_api_helpers.js"></script>

    <!-- Compatibility Functions -->
    <script src="/static/js/compatibility_functions.js"></script>

    <!-- Debug Tools -->
    <!-- <script src="/static/js/debug_model_visibility.js"></script> -->
    <!-- <script src="/static/js/debug_stage_inspection.js"></script> -->

    <!-- Main Initialization System -->
    <script src="/static/js/main_initialization.js"></script>

    <!-- SocketIO for real-time communication -->
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>

<script>
// Global variables for the modular system
window.live2dIntegration = window.live2dIntegration || null;
uiController = null; // Already declared in live2d_model_loader.js
// live2dMultiModelManager is declared in live2d_model_loader.js
// currentModel is declared in live2d_model_loader.js
// pixiApp is declared in live2d_model_loader.js

// Function to update current model reference when active model changes
function updateCurrentModelReference() {
    if (live2dMultiModelManager) {
        const activeModelData = live2dMultiModelManager.getActiveModel();
        console.log('üîç Active model check:', {
            hasActiveModelData: !!activeModelData,
            activeModelDataKeys: activeModelData ? Object.keys(activeModelData) : null,
            hasModel: activeModelData ? !!activeModelData.model : false,
            modelType: activeModelData && activeModelData.model ? typeof activeModelData.model : null,
            modelName: activeModelData ? activeModelData.name : null
        });
        
        if (activeModelData && activeModelData.model) {
            currentModel = activeModelData.model;
            console.log('üîÑ Updated currentModel reference to:', activeModelData.name);
            
            // Update PIXI app reference from integration
            if (window.live2dIntegration && window.live2dIntegration.app) {
                pixiApp = window.live2dIntegration.app;
                console.log('üîÑ Updated pixiApp reference from integration');
            }
            
            // Set up mouse interaction for the new current model (only if not already set up)
            if (currentModel && pixiApp && !currentModel._interactionSetup) {
                setupLive2DMouseInteraction(currentModel);
                currentModel._interactionSetup = true; // Mark as set up to prevent duplicates
            }
            
            return true;
        } else {
            // Try alternative method - get all models and find the active one
            const allModels = live2dMultiModelManager.getAllModels();
            console.log('üîç Trying alternative method - all models:', allModels.length);
            
            for (let modelData of allModels) {
                if (modelData.model && modelData.model.visible) {
                    currentModel = modelData.model;
                    console.log('üîÑ Found visible model:', modelData.name);
                    
                    // Update PIXI app reference
                    if (window.live2dIntegration && window.live2dIntegration.app) {
                        pixiApp = window.live2dIntegration.app;
                    }
                    
                    // Set up mouse interaction (only if not already set up)
                    if (currentModel && pixiApp && !currentModel._interactionSetup) {
                        setupLive2DMouseInteraction(currentModel);
                        currentModel._interactionSetup = true;
                    }
                    
                    return true;
                }
            }
            
            currentModel = null;
            console.log('‚ùå No active model found');
            return false;
        }
    }
    currentModel = null;
    return false;
}

// Initialize the modular Live2D system
async function initializeLive2D() {
    try {
        console.log('Initializing Live2D modular system...');
        
        // Check if modular classes are available, if not use fallback
        if (typeof Live2DIntegration === 'undefined') {
            console.warn('Live2DIntegration class not found, using fallback initialization');
            await initializeFallbackLive2D();
            return;
        }
        
        // Create integration instance
        window.live2dIntegration = new Live2DIntegration();
        
        // Initialize integration (canvas container)
        const success = await window.live2dIntegration.initialize('pixiContainer');
        
        if (!success) {
            throw new Error('Failed to initialize Live2D integration');
        }
        
        // Create UI controller
        uiController = new Live2DUIController(window.live2dIntegration);
        
        // Initialize UI controller
        await uiController.initialize();
        
        // Store reference to multi-model manager for global access
        live2dMultiModelManager = window.live2dIntegration.modelManager;
        
        // Store PIXI app reference from integration.core.app (correct location)
        pixiApp = window.live2dIntegration.core.app;
        
        // CRITICAL: Make globals available to debug console and other scripts
        window.live2dMultiModelManager = live2dMultiModelManager;
        window.uiController = uiController;
        window.pixiApp = pixiApp;
        
        // Additional debug: verify PIXI app is correctly assigned
        console.log('üîç PIXI app assignment check:', {
            'live2dIntegration.app': !!window.live2dIntegration.app,
            'live2dIntegration.core.app': !!window.live2dIntegration.core.app,
            'assigned pixiApp': !!pixiApp,
            'window.pixiApp': !!window.pixiApp
        });
        
        // CRITICAL: Also expose the SDK for debug console
        window.LIVE2DCUBISMCORE = window.Live2DCubismCore;
        
        // CRITICAL: Apply interaction fix immediately after initialization
        console.log('üîß Applying PIXI interaction fix...');
        fixPixiInteractionSystem();
        
        // Set up connection between multi-model manager and UI controller
        live2dMultiModelManager.setUIController(uiController);
        
        // Initialize the People panel with actual loaded models (clear any hardcoded data)
        populatePeopleModels();
        
        console.log('Live2D system initialized successfully!');
        
    } catch (error) {
        console.error('Failed to initialize Live2D system:', error);
        console.log('Attempting fallback initialization...');
        await initializeFallbackLive2D();
    }
}

// Fallback initialization with Direct Mouse Interaction Implementation
async function initializeFallbackLive2D() {
    try {
        console.log('Initializing fallback Live2D system with mouse interaction...');
        
        // Create basic PIXI application
        pixiApp = new PIXI.Application({
            width: window.innerWidth,
            height: window.innerHeight,
            backgroundColor: 0x000000, // Black background instead of blue
            transparent: true,
            antialias: true,
            resolution: window.devicePixelRatio || 1,
            autoDensity: true
        });
        
        // Add canvas to container
        const container = document.getElementById('pixiContainer');
        container.appendChild(pixiApp.view);
        
        // Set up stage interaction (CRITICAL for mouse events)
        pixiApp.stage.interactive = true;
        pixiApp.stage.hitArea = pixiApp.screen;
        
        // Make globals available
        window.pixiApp = pixiApp;
        window.currentModel = null;
        
        console.log('‚úÖ Fallback Live2D system with mouse interaction initialized');
        
        // Set up model info display
        updateModelInfoDisplay('System ready - load a model to test mouse interaction');
        
        // Try to load a test model if available
        await tryLoadTestModel();
        
    } catch (error) {
        console.error('Failed to initialize fallback Live2D system:', error);
        updateModelInfoDisplay('‚ùå Failed to initialize Live2D system');
    }
}

// Try to load a test model for interaction testing
async function tryLoadTestModel() {
    try {
        // This would attempt to load a model from the server
        const response = await fetch('/api/live2d/models');
        if (response.ok) {
            const models = await response.json();
            if (models && models.length > 0) {
                console.log(`Found ${models.length} models available for testing`);
                updateModelInfoDisplay(`Found ${models.length} models - use People panel to load one`);
            }
        }
    } catch (error) {
        console.log('Could not fetch models for testing:', error.message);
        updateModelInfoDisplay('System ready - add models via People panel');
    }
}

// Live2D Viewer Web Mouse Interaction Implementation
function setupLive2DMouseInteraction(model) {
    if (!model || !pixiApp) {
        console.warn('Cannot setup mouse interaction: missing model or PIXI app');
        return;
    }
    
    console.log('üñ±Ô∏è Setting up Live2D Viewer Web mouse interaction for model:', model.internalModel?.settings?.name || 'Unknown');
    
    // Enable interaction on the model (Live2D Viewer Web pattern)
    model.interactive = true;
    model.buttonMode = true;
    
    // Set up dragging variables
    let isDragging = false;
    let dragStart = { x: 0, y: 0 };
    let modelStart = { x: 0, y: 0 };
    
    // Mouse down - start dragging (Live2D Viewer Web pattern)
    model.removeAllListeners('pointerdown'); // Prevent duplicate listeners
    model.on('pointerdown', (event) => {
        isDragging = true;
        const position = event.data.global;
        dragStart.x = position.x;
        dragStart.y = position.y;
        modelStart.x = model.x;
        modelStart.y = model.y;
        
        // Prevent event bubbling
        event.stopPropagation();
        console.log('üñ±Ô∏è Model drag started at:', position);
        
        // Update model info
        updateModelInfoDisplay(`Dragging model from (${Math.round(modelStart.x)}, ${Math.round(modelStart.y)})`);
    });
    
    // Mouse move - drag the model (use app stage for global movement)
    pixiApp.stage.removeAllListeners('pointermove'); // Prevent duplicate listeners
    pixiApp.stage.on('pointermove', (event) => {
        if (!isDragging) return;
        
        const position = event.data.global;
        const deltaX = position.x - dragStart.x;
        const deltaY = position.y - dragStart.y;
        
        model.x = modelStart.x + deltaX;
        model.y = modelStart.y + deltaY;
        
        // Update model info during drag
        updateModelInfoDisplay(`Position: (${Math.round(model.x)}, ${Math.round(model.y)}) Scale: ${model.scale.x.toFixed(2)}`);
    });
    
    // Mouse up - stop dragging
    pixiApp.stage.removeAllListeners('pointerup'); // Prevent duplicate listeners
    pixiApp.stage.on('pointerup', () => {
        if (isDragging) {
            isDragging = false;
            console.log('üñ±Ô∏è Model drag ended at:', { x: model.x, y: model.y });
            updateModelInfoDisplay(`‚úÖ Model positioned at (${Math.round(model.x)}, ${Math.round(model.y)})`);
        }
    });
    
    // Handle mouse leave canvas
    pixiApp.stage.removeAllListeners('pointerupoutside'); // Prevent duplicate listeners
    pixiApp.stage.on('pointerupoutside', () => {
        if (isDragging) {
            isDragging = false;
            console.log('üñ±Ô∏è Model drag ended (outside canvas)');
            updateModelInfoDisplay(`‚úÖ Model positioned at (${Math.round(model.x)}, ${Math.round(model.y)})`);
        }
    });
    
    // Set up mouse wheel scaling (Live2D Viewer Web pattern)
    setupModelScaling(model);
    
    // Set up hit area testing if available
    setupModelHitAreas(model);
    
    console.log('‚úÖ Mouse interaction setup complete for model');
}

// Live2D Viewer Web scaling pattern implementation
function setupModelScaling(model) {
    if (!pixiApp?.view) {
        console.warn('Cannot setup model scaling: no canvas available');
        return;
    }
    
    const canvas = pixiApp.view;
    
    // Remove any existing wheel listeners to prevent duplicates
    const existingHandler = canvas._live2dWheelHandler;
    if (existingHandler) {
        canvas.removeEventListener('wheel', existingHandler);
    }
    
    // Create wheel handler
    function handleModelWheel(event) {
        event.preventDefault();
        
        if (!model || !model.scale) return;
        
        // Use 0.025 increments for wheel scaling
        const scaleIncrement = 0.025;
        const direction = event.deltaY > 0 ? -2 : 2; // Negative for zoom out, positive for zoom in
        const currentScale = model.scale.x;
        const newScale = currentScale + (direction * scaleIncrement);
        
        // Limit scale between 0.1 and 5.0 (Live2D Viewer Web limits)
        if (newScale >= 0.1 && newScale <= 5.0) {
            // Apply to current model
            model.scale.set(newScale);
            
            // Apply to all models in multi-model manager for consistency
            if (window.live2dModelManager?.models) {
                window.live2dModelManager.models.forEach(modelInfo => {
                    if (modelInfo.model && modelInfo.model.scale) {
                        modelInfo.model.scale.set(newScale);
                    }
                });
            }
            
            console.log('üîç Model scaled to:', newScale.toFixed(3));
            
            // Update UI slider if available
            const slider = document.getElementById('zoomSlider');
            const display = document.getElementById('zoomValue');
            if (slider) slider.value = newScale;
            if (display) display.textContent = newScale.toFixed(3);
            
            // Update model info
            updateModelInfoDisplay(`Position: (${Math.round(model.x)}, ${Math.round(model.y)}) Scale: ${newScale.toFixed(3)}`);
        }
    }
    
    // Store handler reference for cleanup
    canvas._live2dWheelHandler = handleModelWheel;
    
    // Add wheel event listener
    canvas.addEventListener('wheel', handleModelWheel, { passive: false });
    
    console.log('üîç Mouse wheel scaling set up for model');
}

// Live2D Viewer Web hit area pattern implementation
function setupModelHitAreas(model) {
    if (!model?.internalModel) {
        console.log('Hit areas not available for this model');
        return;
    }
    
    model.removeAllListeners('pointerdown'); // Remove previous listeners
    model.on('pointerdown', (event) => {
        const point = event.data.global;
        
        // Convert global coordinates to model local coordinates
        const localPoint = model.toLocal(point);
        
        console.log('üéØ Hit test at:', localPoint);
        
        // Test hit areas if available (Live2D Viewer Web pattern)
        if (model.internalModel.hitTest) {
            try {
                const hitAreas = model.internalModel.hitTest(localPoint.x, localPoint.y);
                
                if (hitAreas && hitAreas.length > 0) {
                    console.log('üéØ Hit areas detected:', hitAreas);
                    updateModelInfoDisplay(`üéØ Hit: ${hitAreas.join(', ')}`);
                    
                    // Trigger motions based on hit areas
                    hitAreas.forEach(hitArea => {
                        console.log(`üé≠ Hit area: ${hitArea}`);
                        // Add motion triggers here if needed
                    });
                } else {
                    console.log('üéØ No hit areas at this location');
                }
            } catch (error) {
                console.warn('Hit test failed:', error);
            }
        } else {
            console.log('üéØ Hit testing not available for this model');
        }
    });
}

// Enhanced model loading function with mouse interaction
async function loadLive2DModel(modelPath) {
    try {
        console.log('üé≠ Loading Live2D model from:', modelPath);
        
        if (!pixiApp) {
            throw new Error('PIXI application not available');
        }
        
        updateModelInfoDisplay('Loading model...');
        
        // Clear existing model
        if (currentModel) {
            pixiApp.stage.removeChild(currentModel);
            currentModel.destroy();
            currentModel = null;
        }
        
        // Load new model using Live2D Viewer Web pattern
        currentModel = await Live2DModel.from(modelPath);
        
        if (!currentModel) {
            throw new Error('Failed to create Live2D model');
        }
        
        // Add to stage
        pixiApp.stage.addChild(currentModel);
        
        // Center the model
        currentModel.x = pixiApp.screen.width / 2;
        currentModel.y = pixiApp.screen.height / 2;
        
        // Auto-scale models that are too large
        // Calculate the model's natural height and apply intelligent scaling
        const modelHeight = currentModel.height;
        const viewportHeight = pixiApp.screen.height;
        const maxAllowedHeight = viewportHeight * 0.75; // 3/4 of viewport height
        
        let scaleFactor = 0.3; // Default scale factor
        
        if (modelHeight > maxAllowedHeight) {
            // Model is too large, calculate scale to fit within 3/4 viewport height
            scaleFactor = maxAllowedHeight / modelHeight;
            console.log(`üéØ Auto-scaling large model: Original height ${modelHeight}px -> Scaled to ${Math.round(modelHeight * scaleFactor)}px (${(scaleFactor * 100).toFixed(1)}%)`);
        } else {
            console.log(`‚úÖ Model fits naturally: Height ${modelHeight}px (using default scale ${scaleFactor})`);
        }
        
        // Set the calculated scale
        currentModel.scale.set(scaleFactor);
        
        // CRITICAL: Enable mouse interactions using Live2D Viewer Web patterns
        setupLive2DMouseInteraction(currentModel);
        
        // Store globally
        window.currentModel = currentModel;
        
        console.log('‚úÖ Model loaded successfully with mouse interaction:', currentModel);
        
        // Update model info display
        const modelName = currentModel.internalModel?.settings?.name || 'Unknown Model';
        updateModelInfoDisplay(`‚úÖ ${modelName} loaded - drag to move, scroll to scale`);
        
        return currentModel;
        
    } catch (error) {
        console.error('‚ùå Error loading model:', error);
        updateModelInfoDisplay(`‚ùå Failed to load model: ${error.message}`);
        throw error;
    }
}
    // Single DOMContentLoaded event listener with backup pattern
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('üöÄ Starting AI Companion with BACKUP initialization pattern...');
        
        // Add delay to ensure all scripts are loaded
        setTimeout(async function() {
            try {
                // Set up layout management
                if (typeof setupLayoutManagement === 'function') {
                    setupLayoutManagement();
                }
                
                // Load server configuration if available
                if (typeof loadServerConfig === 'function') {
                    await loadServerConfig();
                    console.log('‚úì Server configuration loaded');
                }
                
                // CRITICAL: Initialize Live2D FIRST before other systems
                const live2dSuccess = await initializeLive2D();
                
                if (!live2dSuccess) {
                    console.error('‚ùå Live2D initialization failed - other systems may not work properly');
                } else {
                    console.log('‚úÖ Live2D system ready for other components');
                }
                
                // Initialize other systems AFTER Live2D is ready
                if (typeof initializeAICompanion === 'function') {
                    const initialized = await initializeAICompanion();
                    
                    if (initialized) {
                        console.log('‚úÖ AI Companion initialization complete!');
                        
                        // Report status
                        setTimeout(() => {
                            if (typeof reportInitializationStatus === 'function') {
                                reportInitializationStatus();
                            }
                        }, 2000);
                    }
                } else {
                    console.log('‚úÖ Backup initialization pattern complete!');
                }
                
            } catch (error) {
                console.error('‚ùå Critical initialization error:', error);
                if (typeof reportInitializationStatus === 'function') {
                    reportInitializationStatus();
                }
            }
        }, 500); // Delay to ensure script loading
    });
    
    // State import handler
    function handleStateImport(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            if (window.live2dStateManager) {
                window.live2dStateManager.importState(file).then(success => {
                    if (success) {
                        alert('Live2D state imported successfully!');
                    } else {
                        alert('Failed to import Live2D state. Please check the file format.');
                    }
                    input.value = ''; // Clear the input
                });
            } else {
                alert('Live2D State Manager not available.');
                input.value = '';
            }
        }
    }
    
    // Background Image Management System
    class BackgroundImageManager {
        constructor() {
            this.backgroundElement = null;
            this.currentSettings = {
                opacity: 100,
                scale: 100,
                position: 'center'
            };
            this.currentImage = null;
            this.imageCache = new Map(); // Add image cache
            this.isLoading = false; // Add loading state
            this.initialize();
        }
        
        initialize() {
            this.createBackgroundElement();
            this.loadSavedBackground();
        }
        
        createBackgroundElement() {
            // Create background element if it doesn't exist
            if (!this.backgroundElement) {
                this.backgroundElement = document.createElement('div');
                this.backgroundElement.id = 'canvasBackground';
                this.backgroundElement.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-size: cover;
                    background-position: center;
                    background-repeat: no-repeat;
                    z-index: -1;
                    pointer-events: none;
                `;
                
                // Insert into canvas container
                const canvasFrame = document.querySelector('.canvas-frame');
                if (canvasFrame) {
                    canvasFrame.insertBefore(this.backgroundElement, canvasFrame.firstChild);
                }
            }
        }
        
        async setBackgroundImage(file) {
            if (!file || !file.type.startsWith('image/')) {
                console.error('Invalid file type. Please select an image.');
                return false;
            }
            
            try {
                console.log('üñºÔ∏è Setting background image:', file.name, `(${(file.size / 1024 / 1024).toFixed(2)} MB)`);
                this.isLoading = true;
                
                // Upload file to server instead of converting to base64
                const backgroundUrl = await this.uploadBackgroundFile(file, this.currentSettings);
                
                // Apply background immediately with the returned URL
                this.currentImage = backgroundUrl;
                this.applyBackground(backgroundUrl);
                
                console.log('‚úÖ Background image uploaded and applied successfully');
                this.isLoading = false;
                return true;
            } catch (error) {
                console.error('‚ùå Error setting background image:', error);
                this.isLoading = false;
                throw error;
            }
        }
        
        async uploadBackgroundFile(file, settings) {
            try {
                const formData = new FormData();
                formData.append('background_file', file);
                formData.append('opacity', settings.opacity);
                formData.append('scale', settings.scale);
                formData.append('position', settings.position);
                
                const response = await fetch('/api/users/background', {
                    method: 'POST',
                    body: formData // Use FormData instead of JSON
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to upload background: ${response.statusText} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('‚úÖ Background uploaded to server:', result);
                return result.background_url;
                
            } catch (error) {
                console.error('‚ùå Error uploading background file:', error);
                throw error;
            }
        }
        
        async loadSavedBackground() {
            if (this.isLoading) {
                console.log('üîÑ Background already loading, skipping...');
                return;
            }
            
            try {
                console.log('üìã Loading saved background from server...');
                this.isLoading = true;
                
                // Check cache first
                const currentUser = window.userSelectionSystem?.currentUser;
                const cacheKey = `background_${currentUser?.id || 'default'}`;
                
                if (this.imageCache.has(cacheKey)) {
                    console.log('üöÄ Loading background from cache');
                    const cachedData = this.imageCache.get(cacheKey);
                    this.currentImage = cachedData.url;
                    this.currentSettings = { ...this.currentSettings, ...cachedData.settings };
                    this.applyBackground(cachedData.url);
                    this.updateBackgroundStyle();
                    this.updateUIControls();
                    this.isLoading = false;
                    console.log('‚úÖ Background loaded from cache in <1ms');
                    return;
                }
                
                const response = await fetch('/api/users/background');
                if (!response.ok) {
                    if (response.status === 401) {
                        console.log('‚ö†Ô∏è No user logged in, background not loaded');
                        this.isLoading = false;
                        return;
                    }
                    const errorText = await response.text();
                    console.error(`‚ùå Failed to load background: ${response.statusText} - ${errorText}`);
                    this.isLoading = false;
                    return;
                }
                
                const result = await response.json();
                console.log('üìã Background response received:', result?.background_url ? 'has URL' : 'empty');
                
                if (result.background_url) {
                    this.currentImage = result.background_url;
                    
                    // Cache the background data
                    this.imageCache.set(cacheKey, {
                        url: result.background_url,
                        settings: result.background_settings || {}
                    });
                    
                    this.applyBackground(result.background_url);
                    console.log('‚úÖ Background image loaded from server');
                }
                
                if (result.background_settings) {
                    this.currentSettings = { ...this.currentSettings, ...result.background_settings };
                    this.updateBackgroundStyle();
                    this.updateUIControls();
                    console.log('‚úÖ Background settings loaded from server');
                } else {
                    console.log('üìã No background data found');
                }
                
                this.isLoading = false;
                
            } catch (error) {
                console.error('‚ùå Error loading background from server:', error);
                this.isLoading = false;
            }
        }
        
        applyBackground(imageData) {
            if (this.backgroundElement && imageData) {
                // Handle both URLs and base64 data
                if (imageData.startsWith('data:')) {
                    // Base64 data - use directly
                    this.backgroundElement.style.backgroundImage = `url(${imageData})`;
                } else {
                    // URL path - use directly
                    this.backgroundElement.style.backgroundImage = `url(${imageData})`;
                }
                this.updateBackgroundStyle();
            }
        }
        
        updateBackgroundStyle() {
            if (!this.backgroundElement) return;
            
            const { opacity, scale, position } = this.currentSettings;
            
            this.backgroundElement.style.opacity = opacity / 100;
            this.backgroundElement.style.transform = `scale(${scale / 100})`;
            
            // Handle different position options
            switch (position) {
                case 'cover':
                    this.backgroundElement.style.backgroundSize = 'cover';
                    this.backgroundElement.style.backgroundPosition = 'center';
                    break;
                case 'contain':
                    this.backgroundElement.style.backgroundSize = 'contain';
                    this.backgroundElement.style.backgroundPosition = 'center';
                    break;
                case 'center':
                    this.backgroundElement.style.backgroundSize = 'cover';
                    this.backgroundElement.style.backgroundPosition = 'center';
                    break;
                case 'top':
                    this.backgroundElement.style.backgroundSize = 'cover';
                    this.backgroundElement.style.backgroundPosition = 'top';
                    break;
                case 'bottom':
                    this.backgroundElement.style.backgroundSize = 'cover';
                    this.backgroundElement.style.backgroundPosition = 'bottom';
                    break;
                case 'left':
                    this.backgroundElement.style.backgroundSize = 'cover';
                    this.backgroundElement.style.backgroundPosition = 'left';
                    break;
                case 'right':
                    this.backgroundElement.style.backgroundSize = 'cover';
                    this.backgroundElement.style.backgroundPosition = 'right';
                    break;
            }
        }
        
        updateUIControls() {
            const opacitySlider = document.getElementById('backgroundOpacity');
            const scaleSlider = document.getElementById('backgroundScale');
            const positionSelect = document.getElementById('backgroundPosition');
            const opacityValue = document.getElementById('backgroundOpacityValue');
            const scaleValue = document.getElementById('backgroundScaleValue');
            
            if (opacitySlider) {
                opacitySlider.value = this.currentSettings.opacity;
                if (opacityValue) opacityValue.textContent = this.currentSettings.opacity;
            }
            if (scaleSlider) {
                scaleSlider.value = this.currentSettings.scale;
                if (scaleValue) scaleValue.textContent = this.currentSettings.scale;
            }
            if (positionSelect) {
                positionSelect.value = this.currentSettings.position;
            }
        }
        
        async updateOpacity(value) {
            this.currentSettings.opacity = parseInt(value);
            this.updateBackgroundStyle();
            await this.saveCurrentSettings();
            
            const opacityValue = document.getElementById('backgroundOpacityValue');
            if (opacityValue) opacityValue.textContent = value;
        }
        
        async updateScale(value) {
            this.currentSettings.scale = parseInt(value);
            this.updateBackgroundStyle();
            await this.saveCurrentSettings();
            
            const scaleValue = document.getElementById('backgroundScaleValue');
            if (scaleValue) scaleValue.textContent = value;
        }
        
        async updatePosition(value) {
            this.currentSettings.position = value;
            this.updateBackgroundStyle();
            await this.saveCurrentSettings();
        }
        
        async saveCurrentSettings() {
            if (this.currentImage) {
                try {
                    // Send settings-only update (JSON) to preserve existing background file
                    const response = await fetch('/api/users/background', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            background_url: this.currentImage,
                            background_settings: this.currentSettings
                        })
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Failed to save settings: ${response.statusText} - ${errorText}`);
                    }
                    
                    console.log('‚úÖ Background settings saved successfully');
                } catch (error) {
                    console.error('‚ùå Failed to save background settings:', error);
                }
            }
        }
        
        async clearBackground() {
            try {
                console.log('üóëÔ∏è Clearing background...');
                
                const response = await fetch('/api/users/background', {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to clear background: ${response.statusText} - ${errorText}`);
                }
                
                // Clear local state
                this.currentImage = null;
                this.currentSettings = {
                    opacity: 100,
                    scale: 100,
                    position: 'center'
                };
                
                // Clear UI
                if (this.backgroundElement) {
                    this.backgroundElement.style.backgroundImage = 'none';
                }
                
                this.updateUIControls();
                
                console.log('‚úÖ Background cleared successfully');
                
            } catch (error) {
                console.error('‚ùå Error clearing background:', error);
                throw error;
            }
        }
        
        showPreview() {
            if (this.currentImage) {
                // Create a preview window
                const preview = window.open('', 'Background Preview', 'width=800,height=600');
                if (preview) {
                    preview.document.write(`
                        <html>
                            <head><title>Background Preview</title></head>
                            <body style="margin:0; background-image:url(${this.currentImage}); background-size:cover; background-position:center;">
                                <div style="position:fixed; top:10px; right:10px; background:rgba(0,0,0,0.7); color:white; padding:10px; border-radius:5px;">
                                    Background Preview<br>
                                    <button onclick="window.close()" style="margin-top:5px;">Close</button>
                                </div>
                            </body>
                        </html>
                    `);
                }
            } else {
                alert('No background image is currently set.');
            }
        }
    }
    
    // Initialize background manager
    let backgroundManager;
    document.addEventListener('DOMContentLoaded', () => {
        // Wait a bit for the DOM to be fully ready
        setTimeout(() => {
            backgroundManager = new BackgroundImageManager();
            
            // Listen for user changes to clear cache and reload settings
            document.addEventListener('userChanged', async (event) => {
                console.log('üë§ User changed, preparing clean environment for:', event.detail.user);
                
                try {
                    // FIRST: Clear cache to prevent cross-user interference
                    await clearUserSwitchCache();
                    
                    // THEN: Reload user-specific settings
                    if (backgroundManager) {
                        try {
                            await backgroundManager.loadSavedBackground();
                            console.log('‚úÖ Background reloaded for new user');
                        } catch (error) {
                            console.error('‚ùå Failed to reload background for new user:', error);
                        }
                    }
                    
                    console.log('‚úÖ User switch completed successfully');
                } catch (error) {
                    console.error('‚ùå Error during user switch:', error);
                }
            });
            
            console.log('üñºÔ∏è Background manager initialized with user change listener');
        }, 1000);
    });
    
    // Function to reload background when user changes
    async function reloadUserBackground() {
        if (backgroundManager) {
            try {
                await backgroundManager.loadSavedBackground();
                console.log('‚úÖ Background reloaded for new user');
            } catch (error) {
                console.error('‚ùå Failed to reload background:', error);
            }
        }
    }
    
    // Make reloadUserBackground available globally
    window.reloadUserBackground = reloadUserBackground;
    
    // User switch cache clearing function
    async function clearUserSwitchCache() {
        console.log('üßπ Clearing cache for user switch...');
        
        try {
            // Clear user-specific cached data that might interfere between users
            const userSpecificKeys = [
                // Background-related keys (now handled by database, but clear any legacy)
                'ai2d_chat_background_image',
                'ai2d_chat_background_settings',
                
                // Live2D model state keys
                'live2d_model_positions',
                'live2d_model_settings',
                'live2d_current_model',
                
                // Chat-related cached data
                'chat_history_cache',
                'conversation_context',
                'last_chat_state',
                
                // Voice/audio settings cache
                'audio_settings_cache',
                'voice_preferences_cache',
                
                // UI state that should reset per user
                'ui_panel_states',
                'user_preferences_cache',
                'character_selection_cache'
            ];
            
            // Clear specific localStorage keys
            userSpecificKeys.forEach(key => {
                if (localStorage.getItem(key)) {
                    localStorage.removeItem(key);
                    console.log(`üóëÔ∏è Cleared localStorage key: ${key}`);
                }
            });
            
            // Clear sessionStorage completely (user session data)
            const sessionCount = sessionStorage.length;
            if (sessionCount > 0) {
                sessionStorage.clear();
                console.log(`üóëÔ∏è Cleared ${sessionCount} sessionStorage items`);
            }
            
            // Clear any cached DOM state that might persist
            // Reset model-related UI elements
            const modelSelectElements = document.querySelectorAll('select[id*="model"], select[id*="character"]');
            modelSelectElements.forEach(select => {
                if (select.selectedIndex > 0) {
                    select.selectedIndex = 0;
                }
            });
            
            // Clear any voice selection caches
            if (window.voiceModels) {
                // Don't clear the array, but reset any user-specific selections
                const voiceSelects = document.querySelectorAll('select[id*="voice"]');
                voiceSelects.forEach(select => {
                    if (select.selectedIndex > 0) {
                        select.selectedIndex = 0;
                    }
                });
            }
            
            // Force garbage collection if available (development only)
            if (window.gc && typeof window.gc === 'function') {
                try {
                    window.gc();
                    console.log('üóëÔ∏è Forced garbage collection');
                } catch (e) {
                    // Ignore errors - gc might not be available
                }
            }
            
            console.log('‚úÖ User switch cache cleared successfully');
            
        } catch (error) {
            console.warn('‚ö†Ô∏è Some cache clearing operations failed during user switch:', error);
        }
    }
    
    // Make clearUserSwitchCache available globally
    window.clearUserSwitchCache = clearUserSwitchCache;
    
    // Global functions for HTML handlers
    async function applyBackgroundImage() {
        const fileInput = document.getElementById('backgroundImageFile');
        if (fileInput && fileInput.files && fileInput.files[0] && backgroundManager) {
            try {
                const success = await backgroundManager.setBackgroundImage(fileInput.files[0]);
                if (success) {
                    console.log('‚úÖ Background image applied successfully');
                    if (typeof showMessage === 'function') {
                        showMessage('Background image applied successfully!', 'success');
                    }
                    // Clear the file input after successful upload
                    fileInput.value = '';
                } else {
                    console.error('‚ùå Failed to apply background image');
                    if (typeof showMessage === 'function') {
                        showMessage('Failed to apply background image. Please try again.', 'error');
                    } else {
                        alert('Failed to apply background image. Please try again.');
                    }
                }
            } catch (error) {
                console.error('‚ùå Background apply error:', error);
                if (typeof showMessage === 'function') {
                    showMessage(`Background apply failed: ${error.message}`, 'error');
                } else {
                    alert(`Background apply failed: ${error.message}`);
                }
            }
        } else {
            alert('Please select a background image file first.');
        }
    }

    async function handleBackgroundImageUpload(input) {
        if (input.files && input.files[0] && backgroundManager) {
            try {
                const success = await backgroundManager.setBackgroundImage(input.files[0]);
                if (success) {
                    console.log('‚úÖ Background image uploaded successfully');
                    if (typeof showMessage === 'function') {
                        showMessage('Background image uploaded successfully!', 'success');
                    }
                } else {
                    console.error('‚ùå Failed to upload background image');
                    if (typeof showMessage === 'function') {
                        showMessage('Failed to upload background image. Please try again.', 'error');
                    } else {
                        alert('Failed to upload background image. Please try again.');
                    }
                }
            } catch (error) {
                console.error('‚ùå Background upload error:', error);
                if (typeof showMessage === 'function') {
                    showMessage(`Background upload failed: ${error.message}`, 'error');
                } else {
                    alert(`Background upload failed: ${error.message}`);
                }
            } finally {
                input.value = ''; // Clear the input
            }
        }
    }
    
    async function updateBackgroundOpacity(value) {
        if (backgroundManager) {
            try {
                await backgroundManager.updateOpacity(value);
            } catch (error) {
                console.error('‚ùå Failed to update background opacity:', error);
            }
        }
    }
    
    async function updateBackgroundScale(value) {
        if (backgroundManager) {
            try {
                await backgroundManager.updateScale(value);
            } catch (error) {
                console.error('‚ùå Failed to update background scale:', error);
            }
        }
    }
    
    async function updateBackgroundPosition(value) {
        if (backgroundManager) {
            try {
                await backgroundManager.updatePosition(value);
            } catch (error) {
                console.error('‚ùå Failed to update background position:', error);
            }
        }
    }
    
    async function clearBackgroundImage() {
        if (backgroundManager) {
            try {
                await backgroundManager.clearBackground();
                
                // Reset UI controls
                const opacitySlider = document.getElementById('backgroundOpacity');
                const scaleSlider = document.getElementById('backgroundScale');
                const positionSelect = document.getElementById('backgroundPosition');
                const opacityValue = document.getElementById('backgroundOpacityValue');
                const scaleValue = document.getElementById('backgroundScaleValue');
                
                if (opacitySlider) opacitySlider.value = 100;
                if (scaleSlider) scaleSlider.value = 100;
                if (positionSelect) positionSelect.value = 'center';
                if (opacityValue) opacityValue.textContent = '100';
                if (scaleValue) scaleValue.textContent = '100';
                
                console.log('‚úÖ Background cleared successfully');
                if (typeof showMessage === 'function') {
                    showMessage('Background cleared successfully!', 'success');
                }
                
            } catch (error) {
                console.error('‚ùå Failed to clear background:', error);
                if (typeof showMessage === 'function') {
                    showMessage(`Failed to clear background: ${error.message}`, 'error');
                } else {
                    alert(`Failed to clear background: ${error.message}`);
                }
            }
        }
    }
    
    function showBackgroundPreview() {
        const fileInput = document.getElementById('backgroundImageFile');
        if (fileInput && fileInput.files && fileInput.files[0]) {
            // Preview the selected file without uploading
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = window.open('', 'Background Preview', 'width=800,height=600');
                if (preview) {
                    preview.document.write(`
                        <html>
                            <head><title>Background Preview - ${file.name}</title></head>
                            <body style="margin:0; background-image:url(${e.target.result}); background-size:cover; background-position:center;">
                                <div style="position:fixed; top:10px; right:10px; background:rgba(0,0,0,0.7); color:white; padding:10px; border-radius:5px;">
                                    Preview: ${file.name}<br>
                                    <button onclick="window.close()" style="margin-top:5px;">Close</button>
                                </div>
                            </body>
                        </html>
                    `);
                }
            };
            reader.readAsDataURL(file);
        } else if (backgroundManager && backgroundManager.currentImage) {
            // Fallback to current background if no file selected
            backgroundManager.showPreview();
        } else {
            alert('Please select a background image file first.');
        }
    }
    
    // Live2D Model Zoom Controls
    function updateZoom(value) {
        const scale = parseFloat(value);
        
        // Apply to all models in the multi-model manager
        if (window.live2dModelManager?.models) {
            window.live2dModelManager.models.forEach(modelInfo => {
                if (modelInfo.model && modelInfo.model.scale) {
                    modelInfo.model.scale.set(scale);
                    console.log(`üîç Model "${modelInfo.name}" scaled to: ${scale}`);
                }
            });
        }
        
        // Update the display value
        const display = document.getElementById('zoomValue');
        if (display) {
            display.textContent = scale.toFixed(3);
        }
        
        console.log('üîç Zoom updated to:', scale);
    }
    
    function resetZoom() {
        const zoomSlider = document.getElementById('zoomSlider');
        const zoomValue = document.getElementById('zoomValue');
        
        if (zoomSlider) {
            zoomSlider.value = 1.0;
            updateZoom(1.0);
        }
        
        if (zoomValue) {
            zoomValue.textContent = '1.0';
        }
        
        console.log('üîç Zoom reset to 1.0');
    }
    
    function fitModel() {
        if (!pixiApp || !window.live2dModelManager?.models?.length) {
            console.warn('No models available to fit');
            return;
        }
        
        // Get the first model for fitting calculations
        const firstModel = window.live2dModelManager.models[0].model;
        if (!firstModel) return;
        
        // Calculate scale to fit model to canvas
        const canvasWidth = pixiApp.view.width;
        const canvasHeight = pixiApp.view.height;
        const modelBounds = firstModel.getBounds();
        
        if (modelBounds.width === 0 || modelBounds.height === 0) {
            console.warn('Model bounds are zero, cannot fit model');
            return;
        }
        
        const scaleX = (canvasWidth * 0.8) / modelBounds.width;
        const scaleY = (canvasHeight * 0.8) / modelBounds.height;
        const fitScale = Math.min(scaleX, scaleY);
        
        // Apply fit scale to all models
        window.live2dModelManager.models.forEach(modelInfo => {
            if (modelInfo.model && modelInfo.model.scale) {
                modelInfo.model.scale.set(fitScale);
            }
        });
        
        // Update UI
        const zoomSlider = document.getElementById('zoomSlider');
        const zoomValue = document.getElementById('zoomValue');
        
        if (zoomSlider) zoomSlider.value = fitScale;
        if (zoomValue) zoomValue.textContent = fitScale.toFixed(3);
        
        console.log('üîç Model fitted to canvas with scale:', fitScale.toFixed(3));
    }
    
    function centerModel() {
        if (!pixiApp || !window.live2dModelManager?.models?.length) {
            console.warn('No models available to center');
            return;
        }
        
        const canvasWidth = pixiApp.view.width;
        const canvasHeight = pixiApp.view.height;
        
        // Center all models
        window.live2dModelManager.models.forEach(modelInfo => {
            if (modelInfo.model) {
                modelInfo.model.x = canvasWidth / 2;
                modelInfo.model.y = canvasHeight / 2;
                console.log(`üìç Model "${modelInfo.name}" centered at (${modelInfo.model.x}, ${modelInfo.model.y})`);
            }
        });
        
        console.log('üìç All models centered');
    }
    
    // Panel management functions are now handled by UIPanelManager2
    // See /static/js/ui_modules/ui_panel_manager.js
    
    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
        } else {
            document.exitFullscreen();
        }
    }
    
    // Global function assignments for onclick handlers
    // Note: Panel management functions are now handled by UIPanelManager2
    // window.openChat, window.closeChat, window.openDrawing are handled by UIPanelManager2
    window.toggleFullscreen = toggleFullscreen;
    
    // Help function
    function toggleHelp() {
        if (window.uiPanelManager2) {
            window.uiPanelManager2.toggleHelp();
        } else {
            console.error('UIPanelManager2 not available');
        }
    }
    window.toggleHelp = toggleHelp;
    
    // Character Management Functions
    function loadCharactersForProfiles() {
        fetch('/api/live2d/models')
            .then(response => response.json())
            .then(data => {
                const characterSelect = document.getElementById('characterSelect');
                if (characterSelect && data.success) {
                    characterSelect.innerHTML = '<option value="">Select a character...</option>';
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.model_name;
                        option.textContent = model.model_name;
                        characterSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Failed to load characters:', error);
            });
    }
    
    // User Management Functions
    function loadUsersForManagement() {
        fetch('/api/users')
            .then(response => response.json())
            .then(data => {
                const userSelect = document.getElementById('userSelect');
                if (userSelect && data.success) {
                    userSelect.innerHTML = '<option value="">Select a user...</option>';
                    data.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.username;
                        option.textContent = user.display_name || user.username;
                        userSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Failed to load users:', error);
            });
    }
    
    // Assign management functions to window object
    window.loadCharactersForProfiles = loadCharactersForProfiles;
    window.loadUsersForManagement = loadUsersForManagement;
    window.onCharacterChange = onCharacterChange;
    
    function onCharacterChange() {
        const characterSelect = document.getElementById('characterSelect');
        const modelName = characterSelect.value;
        
        if (modelName) {
            loadCharacterData(modelName);
        } else {
            clearCharacterForm();
        }
    }
    
    function loadCharacterData(modelName) {
        fetch(`/api/live2d/models/${modelName}/character`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.character) {
                    populateCharacterForm(data.character);
                } else {
                    console.warn('No character data found for model:', modelName);
                    clearCharacterForm();
                }
            })
            .catch(error => {
                console.error('Failed to load character data:', error);
                clearCharacterForm();
            });
    }
    
    function populateCharacterForm(character) {
        document.getElementById('characterName').value = character.name || '';
        document.getElementById('characterDescription').value = character.description || '';
        document.getElementById('characterAge').value = character.age || '';
        document.getElementById('characterPersonality').value = character.personality_notes || '';
        document.getElementById('characterAppearance').value = character.appearance_notes || '';
        document.getElementById('characterOutfit').value = character.appearance_notes || '';
        document.getElementById('characterBackground').value = character.background_story || '';
        document.getElementById('characterGoals').value = character.favorite_things || '';
    }
    
    function clearCharacterForm() {
        document.getElementById('characterName').value = '';
        document.getElementById('characterDescription').value = '';
        document.getElementById('characterAge').value = '';
        document.getElementById('characterPersonality').value = '';
        document.getElementById('characterAppearance').value = '';
        document.getElementById('characterOutfit').value = '';
        document.getElementById('characterBackground').value = '';
        document.getElementById('characterGoals').value = '';
    }
    
    function saveCharacterProfile() {
        const characterSelect = document.getElementById('characterSelect');
        const modelName = characterSelect.value;
        
        if (!modelName) {
            alert('Please select a character first');
            return;
        }
        
        const characterData = {
            name: document.getElementById('characterName').value,
            description: document.getElementById('characterDescription').value,
            personality_notes: document.getElementById('characterPersonality').value,
            appearance_notes: document.getElementById('characterAppearance').value,
            background_story: document.getElementById('characterBackground').value,
            favorite_things: document.getElementById('characterGoals').value
        };
        
        fetch(`/api/live2d/models/${modelName}/character`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(characterData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Character profile saved successfully!');
            } else {
                alert('Failed to save character profile: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error saving character profile:', error);
            alert('Failed to save character profile');
        });
    }
    
    function createNewCharacter() {
        const modelName = prompt('Enter model name for new character:');
        if (modelName) {
            const characterData = {
                name: modelName.charAt(0).toUpperCase() + modelName.slice(1),
                description: 'New character',
                personality_notes: 'Friendly and helpful',
                appearance_notes: 'Virtual companion',
                background_story: `A new AI companion named ${modelName}`,
                favorite_things: 'Helping users, learning new things'
            };
            
            fetch(`/api/live2d/models/${modelName}/character`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(characterData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Character created successfully!');
                    loadCharactersForProfiles();
                } else {
                    alert('Failed to create character: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error creating character:', error);
                alert('Failed to create character');
            });
        }
    }
    
    function duplicateCharacter() {
        const characterSelect = document.getElementById('characterSelect');
        const modelName = characterSelect.value;
        
        if (!modelName) {
            alert('Please select a character to duplicate');
            return;
        }
        
        const newName = prompt('Enter name for duplicated character:');
        if (newName) {
            // Get current character data and create new one
            fetch(`/api/live2d/models/${modelName}/character`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.character) {
                        const duplicatedData = {
                            ...data.character,
                            name: newName.charAt(0).toUpperCase() + newName.slice(1)
                        };
                        
                        return fetch(`/api/live2d/models/${newName}/character`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(duplicatedData)
                        });
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Character duplicated successfully!');
                        loadCharactersForProfiles();
                    } else {
                        alert('Failed to duplicate character: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error duplicating character:', error);
                    alert('Failed to duplicate character');
                });
        }
    }
    
    function deleteCharacter() {
        const characterSelect = document.getElementById('characterSelect');
        const modelName = characterSelect.value;
        
        if (!modelName) {
            alert('Please select a character to delete');
            return;
        }
        
        if (confirm(`Are you sure you want to delete the character "${modelName}"?`)) {
            fetch(`/api/live2d/models/${modelName}/character`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Character deleted successfully!');
                    loadCharactersForProfiles();
                    clearCharacterForm();
                } else {
                    alert('Failed to delete character: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error deleting character:', error);
                alert('Failed to delete character');
            });
        }
    }
    
    function exportCharacter() {
        const characterSelect = document.getElementById('characterSelect');
        const modelName = characterSelect.value;
        
        if (!modelName) {
            alert('Please select a character to export');
            return;
        }
        
        fetch(`/api/live2d/models/${modelName}/character`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.character) {
                    const dataStr = JSON.stringify(data.character, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${modelName}_character.json`;
                    link.click();
                    URL.revokeObjectURL(url);
                } else {
                    alert('Failed to export character: No character data found');
                }
            })
            .catch(error => {
                console.error('Error exporting character:', error);
                alert('Failed to export character');
            });
    }
    
    function importCharacter() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const characterData = JSON.parse(e.target.result);
                        const modelName = prompt('Enter model name for imported character:', characterData.name || 'imported_character');
                        
                        if (modelName) {
                            fetch(`/api/live2d/models/${modelName}/character`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(characterData)
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    alert('Character imported successfully!');
                                    loadCharactersForProfiles();
                                } else {
                                    alert('Failed to import character: ' + (data.error || 'Unknown error'));
                                }
                            })
                            .catch(error => {
                                console.error('Error importing character:', error);
                                alert('Failed to import character');
                            });
                        }
                    } catch (error) {
                        alert('Invalid JSON file');
                    }
                };
                reader.readAsText(file);
            }
        };
        input.click();
    }
    
    // Assign character management functions to window object
    window.createNewCharacter = createNewCharacter;
    window.duplicateCharacter = duplicateCharacter;
    window.deleteCharacter = deleteCharacter;
    window.exportCharacter = exportCharacter;
    window.importCharacter = importCharacter;

    // Debug function to test chat functionality
    function testChatMessage() {
        console.log('Testing chat message functionality...');
        
        // Ensure chat window is open
        if (window.openChat) {
            window.openChat();
        }
        
        // Test adding a message using the chat manager
        if (typeof addMessage === 'function') {
            // addMessage('system', 'Chat system test message - if you can see this, the chat is working!', 'info');
            console.log('‚úÖ Test message function available (test message disabled)');
        } else {
            console.error('‚ùå addMessage function not available');
        }
    }
    
    // Auto-test chat functionality after page load
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
            // testChatMessage(); // Disabled automatic test message
        }, 2000);
        
        // Test model dialog functions after a delay to ensure all scripts are loaded
        setTimeout(() => {
            console.log('Testing model dialog functions...');
            console.log('showAddModelDialog available:', typeof window.showAddModelDialog);
            console.log('closeAddModelDialog available:', typeof window.closeAddModelDialog);
            
            if (typeof window.showAddModelDialog !== 'function') {
                console.error('‚ùå showAddModelDialog function not available - adding fallback');
                window.showAddModelDialog = function() {
                    console.log('Fallback showAddModelDialog called');
                    var dialog = document.getElementById('modelSelectionDialog');
                    if (dialog) {
                        dialog.style.display = 'block';
                        dialog.classList.add('open');
                        console.log('Model selection dialog opened via fallback');
                    } else {
                        console.error('Model selection dialog element not found');
                    }
                };
            }
            
            if (typeof window.closeAddModelDialog !== 'function') {
                console.error('‚ùå closeAddModelDialog function not available - adding fallback');
                window.closeAddModelDialog = function() {
                    console.log('Fallback closeAddModelDialog called');
                    var dialog = document.getElementById('modelSelectionDialog');
                    if (dialog) {
                        dialog.classList.remove('open');
                        setTimeout(() => {
                            dialog.style.display = 'none';
                        }, 300);
                        console.log('Model selection dialog closed via fallback');
                    }
                };
            }
        }, 3000);
    });
    
    // Model Management Functions for Settings Panel - Using Live2D Module
    // All model management functions are now handled by live2d_model_import_manager.js
    
    // Voice Management Functions
    window.voiceModels = []; // Store available voice models
    
    // Initialize voice file input handler
    document.addEventListener('DOMContentLoaded', function() {
        const voiceFileInput = document.getElementById('voiceFileInput');
        if (voiceFileInput) {
            voiceFileInput.addEventListener('change', handleVoiceFileUpload);
        }
        
        // Load existing voices on startup
        loadAvailableVoices();
    });
    
    function handleVoiceFileUpload(event) {
        const files = event.target.files;
        if (!files || files.length === 0) return;
        
        console.log(`üì§ Uploading ${files.length} voice file(s)...`);
        
        for (let file of files) {
            uploadVoiceFile(file);
        }
        
        // Clear the input
        event.target.value = '';
    }
    
    async function uploadVoiceFile(file) {
        try {
            const formData = new FormData();
            formData.append('voice_file', file);
            
            console.log(`üì§ Uploading voice file: ${file.name}`);
            console.log(`üì§ File size: ${file.size} bytes`);
            console.log(`üì§ File type: ${file.type}`);
            
            const response = await fetch('/api/voices/upload', {
                method: 'POST',
                body: formData
            });
            
            console.log(`üì§ Upload response status: ${response.status}`);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error(`‚ùå Upload failed: ${response.statusText} - ${errorText}`);
                throw new Error(`Upload failed: ${response.statusText}`);
            }
            
            const result = await response.json();
            console.log('‚úÖ Voice file uploaded successfully:', result);
            
            // Show success message
            if (typeof showMessage === 'function') {
                showMessage(`Voice "${result.name}" uploaded successfully!`, 'success');
            } else {
                console.log(`Voice "${result.name}" uploaded successfully!`);
            }
            
            // Reload voice list
            await loadAvailableVoices();
            
        } catch (error) {
            console.error('‚ùå Voice upload failed:', error);
            if (typeof showMessage === 'function') {
                showMessage(`Failed to upload voice file: ${error.message}`, 'error');
            } else {
                alert(`Failed to upload voice file: ${error.message}`);
            }
        }
    }
    
    async function loadAvailableVoices() {
        try {
            console.log('üìã Loading available voices...');
            const response = await fetch('/api/voices/list');
            console.log(`üìã Voice list response status: ${response.status}`);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error(`‚ùå Failed to load voices: ${response.statusText} - ${errorText}`);
                throw new Error(`Failed to load voices: ${response.statusText}`);
            }
            
            const voices = await response.json();
            window.voiceModels = voices;
            
            console.log(`üìã Loaded ${voices.length} voice models:`, voices);
            
            // Update voice dropdowns
            updateVoiceDropdowns(voices);
            
        } catch (error) {
            console.error('‚ùå Failed to load voices:', error);
            window.voiceModels = [];
            updateVoiceDropdowns([]);
        }
    }
    
    function updateVoiceDropdowns(voices) {
        const voiceSelect = document.getElementById('voiceSelect');
        const characterVoice = document.getElementById('characterVoice');
        
        // Update settings voice dropdown
        if (voiceSelect) {
            voiceSelect.innerHTML = '<option value="">No voices available...</option>';
            voices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.id;
                option.textContent = `${voice.name} (${voice.type})`;
                voiceSelect.appendChild(option);
            });
            
            // Update remove button state
            const removeBtn = document.getElementById('removeVoiceBtn');
            if (removeBtn) {
                removeBtn.disabled = voices.length === 0;
            }
            
            // Update test button state
            const testBtn = document.getElementById('testVoiceBtn');
            if (testBtn) {
                testBtn.disabled = voices.length === 0;
            }
        }
        
        // Update character voice dropdown
        if (characterVoice) {
            const currentValue = characterVoice.value;
            characterVoice.innerHTML = '<option value="">Select voice...</option>';
            voices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.id;
                option.textContent = `${voice.name} (${voice.type})`;
                if (voice.id === currentValue) {
                    option.selected = true;
                }
                characterVoice.appendChild(option);
            });
        }
    }
    
    async function removeVoiceModel() {
        const voiceSelect = document.getElementById('voiceSelect');
        const selectedVoice = voiceSelect.value;
        
        if (!selectedVoice) {
            showMessage('Please select a voice to remove', 'warning');
            return;
        }
        
        if (!confirm('Are you sure you want to remove this voice model?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/voices/${selectedVoice}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                throw new Error(`Failed to remove voice: ${response.statusText}`);
            }
            
            const result = await response.json();
            console.log('‚úÖ Voice removed successfully:', result);
            
            showMessage('Voice model removed successfully!', 'success');
            
            // Reload voice list
            await loadAvailableVoices();
            
        } catch (error) {
            console.error('‚ùå Failed to remove voice:', error);
            showMessage(`Failed to remove voice: ${error.message}`, 'error');
        }
    }
    
    async function testSelectedVoice() {
        const voiceSelect = document.getElementById('voiceSelect');
        const testText = document.getElementById('voiceTestText');
        
        const selectedVoice = voiceSelect.value;
        const text = testText.value.trim();
        
        if (!selectedVoice) {
            showMessage('Please select a voice to test', 'warning');
            return;
        }
        
        if (!text) {
            testText.value = 'Hello, this is a voice test.';
            text = testText.value;
        }
        
        try {
            console.log(`üîä Testing voice: ${selectedVoice} with text: "${text}"`);
            
            const response = await fetch('/api/voices/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    voice_id: selectedVoice,
                    text: text
                })
            });
            
            if (!response.ok) {
                throw new Error(`Voice test failed: ${response.statusText}`);
            }
            
            // The response should be audio data
            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            
            audio.play().catch(error => {
                console.error('‚ùå Failed to play test audio:', error);
                showMessage('Failed to play test audio', 'error');
            });
            
        } catch (error) {
            console.error('‚ùå Voice test failed:', error);
            showMessage(`Voice test failed: ${error.message}`, 'error');
        }
    }
    
    async function testCharacterVoice() {
        const characterVoice = document.getElementById('characterVoice');
        const testText = document.getElementById('characterVoiceTestText');
        
        const selectedVoice = characterVoice.value;
        const text = testText.value.trim();
        
        if (!selectedVoice) {
            showMessage('Please select a voice for this character', 'warning');
            return;
        }
        
        if (!text) {
            testText.value = 'Hello, this is my character voice.';
            text = testText.value;
        }
        
        // Get voice settings
        const pitch = document.getElementById('voicePitch')?.value || 1.0;
        const speed = document.getElementById('voiceSpeed')?.value || 1.0;
        const volume = document.getElementById('voiceVolume')?.value || 1.0;
        
        try {
            console.log(`üîä Testing character voice: ${selectedVoice} with settings - pitch: ${pitch}, speed: ${speed}, volume: ${volume}`);
            
            const response = await fetch('/api/voices/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    voice_id: selectedVoice,
                    text: text,
                    settings: {
                        pitch: parseFloat(pitch),
                        speed: parseFloat(speed),
                        volume: parseFloat(volume)
                    }
                })
            });
            
            if (!response.ok) {
                throw new Error(`Character voice test failed: ${response.statusText}`);
            }
            
            // The response should be audio data
            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            
            audio.play().catch(error => {
                console.error('‚ùå Failed to play character test audio:', error);
                showMessage('Failed to play character test audio', 'error');
            });
            
        } catch (error) {
            console.error('‚ùå Character voice test failed:', error);
            showMessage(`Character voice test failed: ${error.message}`, 'error');
        }
    }
    
    function updateVoiceSetting(setting, value) {
        // Update the display value
        const valueDisplay = document.getElementById(`voice${setting.charAt(0).toUpperCase() + setting.slice(1)}Value`);
        if (valueDisplay) {
            valueDisplay.textContent = value;
        }
        
        console.log(`üéöÔ∏è Updated voice ${setting} to ${value}`);
    }
    
    // Character profile voice/model management functions
    async function loadCharacterModelsAndVoices() {
        try {
            // Load available models for default model dropdown
            const modelsResponse = await fetch('/api/live2d/models');
            if (modelsResponse.ok) {
                const models = await modelsResponse.json();
                updateCharacterDefaultModelDropdown(models);
            }
            
            // Load available voices (already loaded by loadAvailableVoices)
            // Character voice dropdown is updated by updateVoiceDropdowns
            
        } catch (error) {
            console.error('‚ùå Failed to load character models and voices:', error);
        }
    }
    
    function updateCharacterDefaultModelDropdown(models) {
        const defaultModelSelect = document.getElementById('characterDefaultModel');
        if (!defaultModelSelect) return;
        
        const currentValue = defaultModelSelect.value;
        defaultModelSelect.innerHTML = '<option value="">Select default model...</option>';
        
        models.forEach(model => {
            const option = document.createElement('option');
            option.value = model.id;
            option.textContent = model.name;
            if (model.id === currentValue) {
                option.selected = true;
            }
            defaultModelSelect.appendChild(option);
        });
    }
    
    // Override character profile functions to include voice/model data
    const originalSaveCharacterProfile = window.saveCharacterProfile;
    window.saveCharacterProfile = async function() {
        // Get voice and model assignment data
        const voiceData = {
            voice_id: document.getElementById('characterVoice')?.value || null,
            default_model: document.getElementById('characterDefaultModel')?.value || null,
            voice_settings: {
                pitch: parseFloat(document.getElementById('voicePitch')?.value || 1.0),
                speed: parseFloat(document.getElementById('voiceSpeed')?.value || 1.0),
                volume: parseFloat(document.getElementById('voiceVolume')?.value || 1.0)
            }
        };
        
        console.log('üíæ Saving character with voice/model data:', voiceData);
        
        // Call original save function if it exists
        if (originalSaveCharacterProfile) {
            await originalSaveCharacterProfile();
        }
        
        // Save voice/model assignments separately
        await saveCharacterVoiceAssignments(voiceData);
    };
    
    async function saveCharacterVoiceAssignments(voiceData) {
        const characterName = document.getElementById('characterName')?.value;
        if (!characterName) {
            console.warn('‚ö†Ô∏è No character name provided for voice assignment');
            return;
        }
        
        try {
            const response = await fetch('/api/characters/voice-assignment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    character_name: characterName,
                    ...voiceData
                })
            });
            
            if (!response.ok) {
                throw new Error(`Failed to save voice assignment: ${response.statusText}`);
            }
            
            const result = await response.json();
            console.log('‚úÖ Character voice assignment saved:', result);
            
        } catch (error) {
            console.error('‚ùå Failed to save character voice assignment:', error);
            showMessage(`Failed to save voice assignment: ${error.message}`, 'error');
        }
    }
    
    // Load character voice assignments when character is selected
    const originalOnCharacterChange = window.onCharacterChange;
    window.onCharacterChange = async function() {
        // Call original function if it exists
        if (originalOnCharacterChange) {
            await originalOnCharacterChange();
        }
        
        // Load voice assignments for selected character
        await loadCharacterVoiceAssignments();
    };
    
    async function loadCharacterVoiceAssignments() {
        const characterName = document.getElementById('characterName')?.value;
        if (!characterName) return;
        
        try {
            const response = await fetch(`/api/characters/voice-assignment/${encodeURIComponent(characterName)}`);
            if (!response.ok) {
                if (response.status === 404) {
                    // No voice assignment found - this is normal for new characters
                    return;
                }
                throw new Error(`Failed to load voice assignment: ${response.statusText}`);
            }
            
            const voiceAssignment = await response.json();
            console.log('üìã Loaded character voice assignment:', voiceAssignment);
            
            // Update UI with loaded data
            if (voiceAssignment.voice_id) {
                const voiceSelect = document.getElementById('characterVoice');
                if (voiceSelect) voiceSelect.value = voiceAssignment.voice_id;
            }
            
            if (voiceAssignment.default_model) {
                const modelSelect = document.getElementById('characterDefaultModel');
                if (modelSelect) modelSelect.value = voiceAssignment.default_model;
            }
            
            if (voiceAssignment.voice_settings) {
                const settings = voiceAssignment.voice_settings;
                if (settings.pitch && document.getElementById('voicePitch')) {
                    document.getElementById('voicePitch').value = settings.pitch;
                    updateVoiceSetting('pitch', settings.pitch);
                }
                if (settings.speed && document.getElementById('voiceSpeed')) {
                    document.getElementById('voiceSpeed').value = settings.speed;
                    updateVoiceSetting('speed', settings.speed);
                }
                if (settings.volume && document.getElementById('voiceVolume')) {
                    document.getElementById('voiceVolume').value = settings.volume;
                    updateVoiceSetting('volume', settings.volume);
                }
            }
            
        } catch (error) {
            console.error('‚ùå Failed to load character voice assignment:', error);
        }
    }
    
    // Panel initialization hooks - these will be called by UIPanelManager2
    // when panels are opened
    
    function initCharacterProfilesPanel() {
        // Load models and voices for dropdowns
        loadCharacterModelsAndVoices();
    }
    
    function initSettingsPanel() {
        // Load model lists when settings panel opens
        if (window.loadExistingModelsForSettings) {
            window.loadExistingModelsForSettings();
        }
        if (window.loadCanvasModelsForSettings) {
            window.loadCanvasModelsForSettings();
        }
    }
    
    // Make these available globally so UIPanelManager2 can call them
    window.initCharacterProfilesPanel = initCharacterProfilesPanel;
    window.initSettingsPanel = initSettingsPanel;
    
    // Handle file upload for ZIP models
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('canvasModelFileInput');
        if (fileInput) {
            fileInput.addEventListener('change', function(e) {
                const files = e.target.files;
                if (files.length > 0) {
                    for (let file of files) {
                        if (file.name.endsWith('.zip')) {
                            // Use module function for ZIP upload
                            if (window.uploadModelZip) {
                                window.uploadModelZip(file);
                            }
                        } else {
                            if (window.live2dModelImportManager) {
                                window.live2dModelImportManager.showToast('Please select ZIP files only', 'warning');
                            }
                        }
                    }
                }
            });
        }
    });
    
    // Test function for debugging the model dialog
    window.testModelDialog = function() {
        console.log('=== Model Dialog Test ===');
        console.log('1. Dialog element exists:', !!document.getElementById('modelSelectionDialog'));
        console.log('2. Add button exists:', !!document.querySelector('.add-character-btn'));
        console.log('3. showAddModelDialog function:', typeof window.showAddModelDialog);
        console.log('4. closeAddModelDialog function:', typeof window.closeAddModelDialog);
        console.log('5. loadAvailableModelsForDialog function:', typeof window.loadAvailableModelsForDialog);
        
        if (typeof window.showAddModelDialog === 'function') {
            console.log('6. Attempting to open dialog...');
            window.showAddModelDialog();
            
            setTimeout(() => {
                const dialog = document.getElementById('modelSelectionDialog');
                const isVisible = dialog && (
                    dialog.style.display === 'block' || 
                    dialog.style.display === 'flex' ||
                    dialog.classList.contains('open')
                );
                console.log('7. Dialog visible after call:', isVisible);
                console.log('8. Dialog display style:', dialog ? dialog.style.display : 'N/A');
                console.log('9. Dialog has open class:', dialog ? dialog.classList.contains('open') : 'N/A');
                console.log('=== End Test ===');
            }, 100);
        } else {
            console.error('6. showAddModelDialog function not available!');
        }
    };
    </script>

    <!-- Dev Environment Auto-Login and Cache Clearing -->
    <script>
    // Development Environment Detection and Auto-Login System
    (function() {
        'use strict';
        
        console.log('üöÄ Checking for development environment...');
        
        // Detect development environment
        function isDevEnvironment() {
            const hostname = window.location.hostname.toLowerCase();
            const devHosts = [
                'localhost',
                '127.0.0.1',
                '0.0.0.0',
                '192.168.',  // Local network range
                '10.0.',     // Private network range
                '172.16.',   // Private network range
                'dev.',      // Dev subdomain
                'test.',     // Test subdomain
                'staging.',  // Staging subdomain
                'debug.',    // Debug subdomain
            ];
            
            const isDev = devHosts.some(host => 
                hostname === host || hostname.startsWith(host)
            ) || hostname.includes('.local') || window.location.port;
            
            console.log(`üîç Development environment: ${isDev} (hostname: ${hostname}, port: ${window.location.port})`);
            return isDev;
        }
        
        // Clear cache if dev environment and initial startup
        // Note: This is for general development cache clearing (hourly)
        // User-specific cache clearing happens on user switch via clearUserSwitchCache()
        function clearDevCache() {
            if (isDevEnvironment()) {
                const lastClearKey = 'ai2d_chat_last_cache_clear';
                const lastClear = localStorage.getItem(lastClearKey);
                const now = Date.now();
                const oneHour = 60 * 60 * 1000; // 1 hour in milliseconds
                
                // Clear cache if more than 1 hour since last clear or never cleared
                if (!lastClear || (now - parseInt(lastClear)) > oneHour) {
                    console.log('üßπ Clearing development cache...');
                    
                    // Clear various storage types
                    try {
                        // Clear localStorage (except the clear timestamp)
                        const keysToKeep = [lastClearKey];
                        const allKeys = Object.keys(localStorage);
                        allKeys.forEach(key => {
                            if (!keysToKeep.includes(key)) {
                                localStorage.removeItem(key);
                            }
                        });
                        
                        // Clear sessionStorage
                        sessionStorage.clear();
                        
                        // Clear IndexedDB (if any)
                        if ('indexedDB' in window) {
                            // This is a more complex operation, but for now we'll skip it
                            console.log('üóÉÔ∏è IndexedDB clearing skipped (would require async operation)');
                        }
                        
                        // Set new clear timestamp
                        localStorage.setItem(lastClearKey, now.toString());
                        
                        console.log('‚úÖ Development cache cleared successfully');
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Some cache clearing operations failed:', error);
                    }
                } else {
                    console.log('‚è∞ Cache was cleared recently, skipping...');
                }
            }
        }
        
        // Auto-login for development environment
        async function autoLoginDev() {
            if (!isDevEnvironment()) {
                console.log('üîí Production environment - auto-login disabled');
                return;
            }
            
            console.log('üîë Development auto-login enabled');
            
            // Wait for user selection system to be available
            let attempts = 0;
            const maxAttempts = 50; // 5 seconds max wait
            
            const checkUserSystem = () => {
                return new Promise((resolve) => {
                    const checkInterval = setInterval(() => {
                        attempts++;
                        
                        if (window.userSelectionSystem && window.userSelectionSystem.users) {
                            clearInterval(checkInterval);
                            resolve(true);
                        } else if (attempts >= maxAttempts) {
                            clearInterval(checkInterval);
                            resolve(false);
                        }
                    }, 100);
                });
            };
            
            const systemReady = await checkUserSystem();
            
            if (!systemReady) {
                console.warn('‚ö†Ô∏è User selection system not ready - auto-login aborted');
                return;
            }
            
            // Check if already logged in
            if (window.userSelectionSystem.currentUser) {
                console.log('üë§ User already logged in:', window.userSelectionSystem.currentUser.username);
                return;
            }
            
            console.log('üéØ Starting auto-login process...');
            
            const users = window.userSelectionSystem.users;
            
            if (users && users.length > 0) {
                // Find admin user or use first user
                let targetUser = users.find(user => 
                    user.username === 'admin' || 
                    user.username === 'dev' || 
                    user.username === 'default' ||
                    user.is_admin === true
                ) || users[0];
                
                console.log(`üöÄ Auto-selecting user: ${targetUser.username} (${targetUser.display_name || 'No display name'})`);
                
                // Auto-select the user
                try {
                    await window.userSelectionSystem.selectUser(targetUser.id);
                    console.log('‚úÖ Auto-login successful!');
                } catch (error) {
                    console.error('‚ùå Auto-login failed:', error);
                }
            } else {
                console.log('üë§ No existing users found - creating default admin user...');
                
                // Create default admin user
                try {
                    const defaultUser = {
                        username: 'admin',
                        display_name: 'Admin User',
                        email: 'admin@dev.local',
                        is_admin: true
                    };
                    
                    // Try to create the user via API
                    const response = await fetch('/api/users', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(defaultUser)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('‚úÖ Default admin user created:', result.user);
                        
                        // Reload users and auto-select
                        await window.userSelectionSystem.loadUsers();
                        const newUser = window.userSelectionSystem.users.find(u => u.username === 'admin');
                        if (newUser) {
                            await window.userSelectionSystem.selectUser(newUser.id);
                            console.log('‚úÖ Auto-login with new admin user successful!');
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Failed to create default admin user');
                    }
                } catch (error) {
                    console.error('‚ùå Error creating default admin user:', error);
                }
            }
        }
        
        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                // Only run auto-login, cache clearing now happens on user switch
                autoLoginDev();
            }, 1000); // Wait 1 second for other systems to initialize
        });
        
        // Debug info
        if (isDevEnvironment()) {
            console.log('üõ†Ô∏è Development mode features enabled:');
            console.log('  - Auto-login with admin/first user');
            console.log('  - User-specific cache clearing on user switch');
            console.log('  - Enhanced logging');
            console.log('  - Debug console frame visible');
            console.log('  - Logout will still show login screen for testing');
        }
        
        // Make functions globally available
        window.isDevEnvironment = isDevEnvironment;
        window.clearDevCache = clearDevCache;
        window.autoLoginDev = autoLoginDev;
        window.clearUserSwitchCache = clearUserSwitchCache;
    })();
    </script>

    <!-- Development Debug Console Frame -->
    <script>
    // Debug Console Frame for Development Environment
    (function() {
        'use strict';
        
        let debugConsoleFrame = null;
        let originalConsole = {};
        let consoleBuffer = [];
        const maxBufferSize = 1000; // Keep last 1000 messages
        let isPaused = false; // Track pause state
        let pausedBuffer = []; // Buffer for messages received while paused
        
        // Initialize debug console frame (only in dev environment)
        function initDebugConsoleFrame() {
            if (!window.isDevEnvironment || !window.isDevEnvironment()) return;
            
            console.log('üêõ Initializing debug console frame...');
            
            // Create debug console frame
            createDebugConsoleFrame();
            
            // Intercept console methods
            interceptConsole();
            
            console.log('‚úÖ Debug console frame initialized');
        }
        
        function createDebugConsoleFrame() {
            // Remove existing frame if it exists
            const existing = document.getElementById('debugConsoleFrame');
            if (existing) {
                existing.remove();
            }
            
            // Create frame container
            debugConsoleFrame = document.createElement('div');
            debugConsoleFrame.id = 'debugConsoleFrame';
            debugConsoleFrame.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 35%;
                height: 50%;
                background: rgba(0, 0, 0, 0.70);
                border: 1px solid rgba(51, 51, 51, 0.3);
                border-radius: 0 0 8px 0;
                color: #00ff00;
                font-family: 'Courier New', monospace;
                font-size: 12px;
                z-index: 1;
                overflow: hidden;
                display: flex;
                flex-direction: column;
                pointer-events: auto;
                user-select: text;
                box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
                backdrop-filter: blur(2px);
            `;
            
            // Create header
            const header = document.createElement('div');
            header.style.cssText = `
                background: rgba(0, 50, 0, 0.2);
                color: #00ff00;
                padding: 4px 8px;
                font-weight: bold;
                border-bottom: 1px solid rgba(51, 51, 51, 0.3);
                font-size: 11px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-shrink: 0;
                backdrop-filter: blur(1px);
            `;
            header.innerHTML = `
                <span>üêõ Debug Console</span>
                <div>
                    <button id="pauseDebugConsole" style="background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(85, 85, 85, 0.5); color: #ffaa00; font-size: 9px; padding: 2px 6px; cursor: pointer; margin-right: 4px; backdrop-filter: blur(1px);">‚è∏Ô∏è Pause</button>
                    <button id="clearDebugConsole" style="background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(85, 85, 85, 0.5); color: #00ff00; font-size: 9px; padding: 2px 6px; cursor: pointer; margin-right: 4px; backdrop-filter: blur(1px);">Clear</button>
                    <button id="closeDebugConsole" style="background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(85, 85, 85, 0.5); color: #ff4444; font-size: 9px; padding: 2px 6px; cursor: pointer; backdrop-filter: blur(1px);">√ó</button>
                </div>
            `;
            
            // Create scrollable content area
            const content = document.createElement('div');
            content.id = 'debugConsoleContent';
            content.style.cssText = `
                flex: 1;
                overflow-y: auto;
                overflow-x: hidden;
                padding: 8px;
                white-space: pre-wrap;
                word-wrap: break-word;
                line-height: 1.3;
            `;
            
            // Add event listeners
            header.querySelector('#pauseDebugConsole').addEventListener('click', togglePauseDebugConsole);
            header.querySelector('#clearDebugConsole').addEventListener('click', clearDebugConsole);
            header.querySelector('#closeDebugConsole').addEventListener('click', closeDebugConsole);
            
            // Assemble frame
            debugConsoleFrame.appendChild(header);
            debugConsoleFrame.appendChild(content);
            
            // Insert into page (behind canvas)
            document.body.appendChild(debugConsoleFrame);
            
            // Load existing console buffer
            updateDebugConsoleDisplay();
        }
        
        function interceptConsole() {
            const methods = ['log', 'warn', 'error', 'info', 'debug'];
            
            methods.forEach(method => {
                originalConsole[method] = console[method];
                console[method] = function(...args) {
                    // Call original console method
                    originalConsole[method].apply(console, args);
                    
                    // Add to debug console
                    addToDebugConsole(method, args);
                };
            });
        }
        
        function addToDebugConsole(method, args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => {
                if (typeof arg === 'object') {
                    try {
                        return JSON.stringify(arg, null, 2);
                    } catch (e) {
                        return String(arg);
                    }
                }
                return String(arg);
            }).join(' ');
            
            const logEntry = {
                timestamp,
                method,
                message,
                formatted: formatLogEntry(timestamp, method, message)
            };
            
            // If paused, add to pause buffer instead of main buffer
            if (isPaused) {
                pausedBuffer.push(logEntry);
                // Still add to main buffer for history but don't update display
                consoleBuffer.push(logEntry);
                
                // Trim main buffer if too large
                if (consoleBuffer.length > maxBufferSize) {
                    consoleBuffer = consoleBuffer.slice(-maxBufferSize);
                }
                return; // Don't update display while paused
            }
            
            // Add to buffer normally when not paused
            consoleBuffer.push(logEntry);
            
            // Trim buffer if too large
            if (consoleBuffer.length > maxBufferSize) {
                consoleBuffer = consoleBuffer.slice(-maxBufferSize);
            }
            
            // Update display
            updateDebugConsoleDisplay();
        }
        
        function formatLogEntry(timestamp, method, message) {
            const methodColors = {
                log: '#00ff00',
                info: '#00ccff',
                warn: '#ffaa00',
                error: '#ff4444',
                debug: '#cc88ff'
            };
            
            const color = methodColors[method] || '#00ff00';
            const methodIcon = {
                log: 'üìù',
                info: '‚ÑπÔ∏è',
                warn: '‚ö†Ô∏è',
                error: '‚ùå',
                debug: 'üêõ'
            }[method] || 'üìù';
            
            return `<span style="color: #666;">[${timestamp}]</span> <span style="color: ${color};">${methodIcon} ${method.toUpperCase()}</span>: ${message}`;
        }
        
        function updateDebugConsoleDisplay() {
            const content = document.getElementById('debugConsoleContent');
            if (!content) return;
            
            // Get last 100 entries for display
            const displayBuffer = consoleBuffer.slice(-100);
            let displayText = displayBuffer.map(entry => entry.formatted).join('\n');
            
            // Add pause indicator and cached message count if paused
            if (isPaused) {
                const pauseIndicator = `<div style="background: rgba(255, 170, 0, 0.2); padding: 4px; margin: 4px 0; border-left: 3px solid #ffaa00; font-weight: bold;">
                    ‚è∏Ô∏è PAUSED - ${pausedBuffer.length} messages cached
                </div>`;
                displayText += '\n' + pauseIndicator;
            }
            
            content.innerHTML = displayText;
            
            // Auto-scroll to bottom only if not paused (to allow reading)
            if (!isPaused) {
                content.scrollTop = content.scrollHeight;
            }
        }
        
        function clearDebugConsole() {
            consoleBuffer = [];
            pausedBuffer = [];
            updateDebugConsoleDisplay();
            console.log('üßπ Debug console cleared');
        }
        
        function togglePauseDebugConsole() {
            isPaused = !isPaused;
            const pauseBtn = document.getElementById('pauseDebugConsole');
            
            if (isPaused) {
                pauseBtn.textContent = '‚ñ∂Ô∏è Resume';
                pauseBtn.style.color = '#00ff00';
                pausedBuffer = []; // Clear pause buffer when starting pause
                console.log('‚è∏Ô∏è Debug console paused - messages will be cached');
            } else {
                pauseBtn.textContent = '‚è∏Ô∏è Pause';
                pauseBtn.style.color = '#ffaa00';
                
                // Flush cached messages when resuming
                if (pausedBuffer.length > 0) {
                    console.log(`‚ñ∂Ô∏è Debug console resumed - displaying ${pausedBuffer.length} cached messages`);
                    updateDebugConsoleDisplay();
                    pausedBuffer = []; // Clear pause buffer after display
                } else {
                    console.log('‚ñ∂Ô∏è Debug console resumed');
                }
            }
        }
        
        function closeDebugConsole() {
            if (debugConsoleFrame) {
                debugConsoleFrame.style.display = 'none';
                console.log('üëÅÔ∏è Debug console hidden (refresh to show again)');
            }
        }
        
        function toggleDebugConsole() {
            if (debugConsoleFrame) {
                const isVisible = debugConsoleFrame.style.display !== 'none';
                debugConsoleFrame.style.display = isVisible ? 'none' : 'flex';
                console.log(isVisible ? 'üëÅÔ∏è Debug console hidden' : 'üëÅÔ∏è Debug console shown');
            }
        }
        
        // Make toggle function globally available for keyboard shortcuts
        window.toggleDebugConsole = toggleDebugConsole;
        window.initDebugConsoleFrame = initDebugConsoleFrame;
        
        // Add keyboard shortcut (Ctrl+Shift+D) to toggle debug console
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'D' && window.isDevEnvironment && window.isDevEnvironment()) {
                e.preventDefault();
                toggleDebugConsole();
            }
        });
        
        // Initial message and initialization
        if (window.isDevEnvironment && window.isDevEnvironment()) {
            // Initialize debug console frame
            initDebugConsoleFrame();
            
            setTimeout(() => {
                console.log('üêõ Debug console frame ready! Press Ctrl+Shift+D to toggle visibility.');
            }, 500);
        }
    })();
    </script>

</body>
</html>
