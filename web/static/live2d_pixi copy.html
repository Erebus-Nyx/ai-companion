<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live2D AI Companion - Dual Architecture Testing Interface</title>
    <link rel="stylesheet" href="/static/css/live2d_test.css">
    <!-- Live2D AI Companion - Production-ready avatar system with dual runtime support -->
</head>
</head>
<body>
    <div class="app-container">
        <!-- Navigation Icons (Top Right) -->
        <nav class="nav-icons" id="navIcons">
            <button class="nav-icon" onclick="openChat()" title="Chat" data-tooltip="Chat">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                </svg>
            </button>
            <button class="nav-icon" onclick="openPeople()" title="People" data-tooltip="People">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
            </button>
            <button class="nav-icon" onclick="openSettings()" title="Settings" data-tooltip="Settings">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"/>
                </svg>
            </button>
            <div class="nav-divider"></div>
            <button class="nav-icon" onclick="openCharacterProfiles()" title="Character Profiles" data-tooltip="Characters">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
            </button>
            <button class="nav-icon" onclick="openDrawing()" title="Drawing Tools" data-tooltip="Drawing">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                    <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                    <path d="M2 2l7.586 7.586"/>
                    <circle cx="11" cy="11" r="2"/>
                </svg>
            </button>
            <div class="nav-divider"></div>
            <button class="nav-icon" onclick="toggleFullscreen()" title="Fullscreen" data-tooltip="Fullscreen">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                </svg>
            </button>
            <button class="nav-icon" onclick="toggleHelp()" title="Help" data-tooltip="Help">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                    <point cx="12" cy="17"/>
                </svg>
            </button>
        </nav>
        
        <!-- Chat Window -->
        <div class="chat-window" id="chatWindow">
            <div class="chat-header">
                <span class="chat-title">Chat</span>
                <div class="window-controls">
                    <button class="control-btn" onclick="toggleChatSnap()" title="Toggle Snap">📌</button>
                    <button class="close-btn" onclick="closeChat()">×</button>
                </div>
            </div>
            <div class="chat-content">
                <div class="chat-messages" id="chatMessages">
                    <!-- Chat messages will be populated here -->
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." onkeypress="handleChatKeyPress(event)">
                    <button class="send-btn" onclick="sendMessage()">Send</button>
                    <button class="voice-btn" id="voiceButton" onclick="toggleVoiceRecording()" title="Voice Recording">🎤</button>
                </div>
            </div>
        </div>
        
        <!-- People Panel (Right Side) -->
        <div class="people-panel" id="peoplePanel">
            <div class="people-header">
                <span class="people-title">People</span>
                <div class="window-controls">
                    <button class="control-btn" onclick="togglePeopleSnap()" title="Toggle Snap">📌</button>
                    <button class="close-btn" onclick="closePeople()">×</button>
                </div>
            </div>
            <div class="people-content">
                <div class="people-models-list" id="peopleModelsList">
                    <!-- Model icons will be populated here vertically -->
                </div>
                <div class="people-controls">
                    <button class="add-model-btn" onclick="showAddModelDialog()" title="Add new model">
                        <span class="add-icon">+</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Settings Panel (Left Side Overlay) -->
        <div class="settings-panel" id="settingsPanel">
            <div class="settings-header">
                <span class="settings-title">Live2D Settings</span>
                <div class="window-controls">
                    <button class="control-btn" onclick="toggleSettingsSnap()" title="Toggle Snap">📌</button>
                    <button class="close-btn" onclick="closeSettings()">×</button>
                </div>
            </div>
            <div class="settings-content">
                <div class="settings-group">
                    <h4>Model Selection</h4>
                    <div class="setting-item">
                        <label for="modelSelect">Model:</label>
                        <select id="modelSelect" onchange="onModelChange()">
                            <option value="">Select a model...</option>
                        </select>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Display Controls</h4>
                    <div class="setting-item">
                        <label for="zoomSlider">Scale: <span id="zoomValue">1.0</span></label>
                        <input type="range" id="zoomSlider" min="0.1" max="3.0" step="0.1" value="1.0" oninput="updateZoom(this.value); document.getElementById('zoomValue').textContent = this.value;">
                    </div>
                    <div class="setting-controls">
                        <button class="btn btn-secondary" onclick="resetZoom()">Reset</button>
                        <button class="btn btn-secondary" onclick="fitModel()">Fit</button>
                        <button class="btn btn-secondary" onclick="centerModel()">Center</button>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Motions</h4>
                    <div class="setting-item">
                        <label for="motionGroupSelect">Motion Group:</label>
                        <select id="motionGroupSelect" onchange="onMotionGroupChange()">
                            <option value="">No motions available</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label for="motionSelect">Motion:</label>
                        <select id="motionSelect" onchange="onMotionTypeChange()">
                            <option value="">Select motion group first</option>
                        </select>
                    </div>
                    <div class="setting-controls">
                        <button class="btn btn-primary" onclick="playSelectedMotion()">Play Motion</button>
                        <button class="btn btn-secondary" onclick="playRandomMotion()">Random</button>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Expressions</h4>
                    <div class="setting-item">
                        <label for="expressionSelect">Expression:</label>
                        <select id="expressionSelect" onchange="onExpressionChange()">
                            <option value="">No expressions available</option>
                        </select>
                    </div>
                    <div class="setting-controls">
                        <button class="btn btn-primary" onclick="playExpression()">Apply Expression</button>
                        <button class="btn btn-secondary" onclick="resetExpression()">Reset</button>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h4>Actions</h4>
                    <div class="setting-controls">
                        <button class="btn btn-primary" onclick="testModel()">Test Model</button>
                        <button class="btn btn-warning" onclick="resetModel()">Reset</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Canvas Area -->
        <div class="canvas-container">
            <div class="canvas-frame">
                <div id="pixiContainer"></div>
                <!-- Drawing Overlay Canvas -->
                <canvas id="drawingOverlay" class="drawing-overlay-canvas" style="display: none;"></canvas>
            </div>
            <div class="loading-overlay" id="loadingOverlay" style="display: none;">
                <div class="loading-spinner"></div>
            </div>
        </div>
    </div>

    <!-- Model Selection Dialog -->
    <div class="model-selection-dialog" id="modelSelectionDialog" style="display: none;">
        <div class="dialog-overlay" onclick="closeAddModelDialog()"></div>
        <div class="dialog-content">
            <div class="dialog-header">
                <h3>Add Live2D Model</h3>
                <button class="dialog-close" onclick="closeAddModelDialog()">×</button>
            </div>
            <div class="dialog-body">
                <div class="model-grid" id="modelGrid">
                    <div style="text-align: center; padding: 20px; color: #aaa;">
                        Loading available models...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Selection Dialog -->
    <div class="user-selection-dialog" id="userSelectionDialog">
        <div class="dialog-content">
            <div class="dialog-header" style="cursor: move;">
                <h3>User Management</h3>
                <button class="dialog-close" onclick="closeUserDialog()">×</button>
            </div>
            <div class="dialog-body">
                <div class="user-selection-list" id="userSelectionList">
                    <div style="text-align: center; padding: 20px; color: #aaa;">
                        Loading users...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Profile Panel -->
    <div class="user-profile-panel" id="userProfilePanel">
        <div class="user-profile-header">
            <span class="user-profile-title">User Profile</span>
            <div class="window-controls">
                <button class="control-btn" onclick="toggleUserProfileSnap()" title="Toggle Snap">📌</button>
                <button class="close-btn" onclick="closeUserProfile()">×</button>
            </div>
        </div>
        <div class="user-profile-content">
            <!-- Basic User Information Section -->
            <div class="user-section">
                <h4>User Information</h4>
                <div class="form-group">
                    <label for="userDisplayName">Display Name:</label>
                    <input type="text" id="userDisplayName" placeholder="Your display name" readonly>
                </div>
                <div class="form-group">
                    <label for="userUsername">Username:</label>
                    <input type="text" id="userUsername" placeholder="Your username" readonly>
                </div>
            </div>

            <!-- Personal Information Section -->
            <div class="user-section">
                <h4>Personal Information</h4>
                <div class="form-group">
                    <label for="userGender">Gender:</label>
                    <select id="userGender">
                        <option value="not_specified">Not Specified</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="non_binary">Non-Binary</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userAgeRange">Age Range:</label>
                    <select id="userAgeRange">
                        <option value="teen">Teen (13-17)</option>
                        <option value="young_adult">Young Adult (18-25)</option>
                        <option value="adult">Adult (26-35)</option>
                        <option value="middle_aged">Middle Aged (36-50)</option>
                        <option value="mature">Mature (51+)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userBio">Bio:</label>
                    <textarea id="userBio" placeholder="Tell us about yourself..." rows="3"></textarea>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="user-actions">
                <button class="btn btn-primary" onclick="saveUserProfile()">Save Profile</button>
                <button class="btn btn-secondary" onclick="closeUserProfile()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Character Profiles Panel -->
    <div class="character-profiles-panel" id="characterProfilesPanel">
        <div class="character-profiles-header">
            <span class="character-profiles-title">Character Profiles</span>
            <div class="window-controls">
                <button class="control-btn" onclick="toggleCharacterProfilesSnap()" title="Toggle Snap">📌</button>
                <button class="close-btn" onclick="closeCharacterProfiles()">×</button>
            </div>
        </div>
        <div class="character-profiles-content">
            <!-- Character Selection Section -->
            <div class="character-section">
                <h4>Character Selection</h4>
                <div class="form-group">
                    <label for="characterSelect">Select Character:</label>
                    <select id="characterSelect" onchange="onCharacterChange()">
                        <option value="">Loading characters...</option>
                    </select>
                </div>
                <div class="character-controls">
                    <button class="btn btn-primary" onclick="createNewCharacter()">New Character</button>
                    <button class="btn btn-secondary" onclick="duplicateCharacter()">Duplicate</button>
                    <button class="btn btn-warning" onclick="deleteCharacter()">Delete</button>
                </div>
            </div>

            <!-- Character Information Section -->
            <div class="character-section">
                <h4>Character Information</h4>
                <div class="form-group">
                    <label for="characterName">Name:</label>
                    <input type="text" id="characterName" placeholder="Character name">
                </div>
                <div class="form-group">
                    <label for="characterDescription">Description:</label>
                    <textarea id="characterDescription" placeholder="Character description..." rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="characterAge">Age:</label>
                    <input type="text" id="characterAge" placeholder="Character age">
                </div>
                <div class="form-group">
                    <label for="characterPersonality">Personality:</label>
                    <textarea id="characterPersonality" placeholder="Character personality traits..." rows="4"></textarea>
                </div>
            </div>

            <!-- Character Appearance Section -->
            <div class="character-section">
                <h4>Appearance</h4>
                <div class="form-group">
                    <label for="characterAppearance">Physical Description:</label>
                    <textarea id="characterAppearance" placeholder="Physical appearance..." rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="characterOutfit">Outfit:</label>
                    <textarea id="characterOutfit" placeholder="Clothing and style..." rows="2"></textarea>
                </div>
            </div>

            <!-- Character Background Section -->
            <div class="character-section">
                <h4>Background & History</h4>
                <div class="form-group">
                    <label for="characterBackground">Background:</label>
                    <textarea id="characterBackground" placeholder="Character history and background..." rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="characterGoals">Goals & Motivations:</label>
                    <textarea id="characterGoals" placeholder="What drives this character..." rows="3"></textarea>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="character-actions">
                <button class="btn btn-primary" onclick="saveCharacterProfile()">Save Character</button>
                <button class="btn btn-secondary" onclick="exportCharacter()">Export</button>
                <button class="btn btn-secondary" onclick="importCharacter()">Import</button>
            </div>
        </div>
    </div>

    <!-- Drawing Panel -->
    <div class="drawing-panel resizable-panel" id="drawingPanel">
        <div class="drawing-header">
            <span class="drawing-title">Drawing Tools</span>
            <div class="window-controls">
                <button class="control-btn" onclick="toggleDrawingSnap()" title="Toggle Snap">📌</button>
                <button class="control-btn" onclick="toggleDrawingResize()" title="Toggle Resize">⤡</button>
                <button class="close-btn" onclick="closeDrawing()">×</button>
            </div>
        </div>
        <div class="drawing-content">
            <!-- Drawing Mode Control -->
            <div class="drawing-section">
                <h4>Drawing Mode</h4>
                <div class="mode-controls">
                    <button class="btn btn-primary" id="toggleDrawingMode" onclick="toggleDrawingMode()" title="Toggle between drawing and Live2D interaction">
                        🎨 Enable Drawing Mode
                    </button>
                    <div class="mode-info">
                        <small>Drawing mode disabled - Live2D interaction active</small>
                    </div>
                </div>
            </div>
            
            <!-- Tool Selection Section -->
            <div class="drawing-section">
                <h4>Drawing Tools</h4>
                <div class="tool-grid horizontal">
                    <button class="tool-btn active" onclick="selectTool('pen')" data-tool="pen" title="Pen">✏️</button>
                    <button class="tool-btn" onclick="selectTool('brush')" data-tool="brush" title="Brush">🖌️</button>
                    <button class="tool-btn" onclick="selectTool('watercolor')" data-tool="watercolor" title="Watercolor">💧</button>
                    <button class="tool-btn" onclick="selectTool('charcoal')" data-tool="charcoal" title="Charcoal">⚫</button>
                    <button class="tool-btn" onclick="selectTool('spray')" data-tool="spray" title="Spray Paint">💨</button>
                    <button class="tool-btn" onclick="selectTool('blur')" data-tool="blur" title="Blur Effect">🌫️</button>                         
                    <button class="tool-btn" onclick="selectTool('eraser')" data-tool="eraser" title="Eraser">🧽</button>               
                </div>
                <h4>Shape Tools</h4>
                <div class="tool-grid horizontal">
                    <button class="tool-btn" onclick="selectTool('line')" data-tool="line" title="Line">📏</button>
                    <button class="tool-btn" onclick="selectTool('rectangle')" data-tool="rectangle" title="Rectangle">⬜</button>
                    <button class="tool-btn" onclick="selectTool('circle')" data-tool="circle" title="Circle">⭕</button>
                    <button class="tool-btn" onclick="selectTool('arrow')" data-tool="arrow" title="Arrow">➡️</button>
                </div>
                <h4>Selection & Transform</h4>
                <div class="tool-grid horizontal">
                    <button class="tool-btn" onclick="selectTool('select')" data-tool="select" title="Rectangle Select">🔲</button>
                    <button class="tool-btn" onclick="selectTool('lasso')" data-tool="lasso" title="Lasso Select">🪢</button>
                    <button class="tool-btn" onclick="selectTool('move')" data-tool="move" title="Move/Transform">↔️</button>
                    <button class="tool-btn" onclick="selectTool('eyedropper')" data-tool="eyedropper" title="Eyedropper">💧</button>
                </div>
            </div>

            <!-- Color and Size Section -->
            <div class="drawing-section">
                <h4>Color & Size</h4>
                <div class="form-group">
                    <label for="colorPicker">Color:</label>
                    <input type="color" id="colorPicker" value="#000000" onchange="setDrawingColor(this.value)">
                </div>
                <div class="form-group">
                    <label for="brushSize">Brush Size: <span id="brushSizeValue">5</span>px</label>
                    <input type="range" id="brushSize" min="1" max="50" value="5" oninput="setBrushSize(this.value)">
                </div>
                <div class="form-group">
                    <label for="opacitySlider">Opacity: <span id="opacityValue">100</span>%</label>
                    <input type="range" id="opacitySlider" min="0" max="100" value="100" oninput="setOpacity(this.value)">
                </div>
            </div>

            <!-- Layers Section -->
            <div class="drawing-section">
                <h4>Layers</h4>
                <div class="layers-list" id="layersList">
                    <div class="layer-item active">
                        <span class="layer-name">Background</span>
                        <div class="layer-controls">
                            <button class="layer-btn" onclick="toggleLayerVisibility(0)" title="Toggle Visibility">👁️</button>
                            <button class="layer-btn" onclick="deleteLayer(0)" title="Delete Layer">🗑️</button>
                        </div>
                    </div>
                </div>
                <div class="layer-controls">
                    <button class="btn btn-secondary" onclick="addNewLayer()">Add Layer</button>
                    <button class="btn btn-secondary" onclick="mergeDown()">Merge Down</button>
                </div>
            </div>

            <!-- Drawing Canvas Section -->
            <div class="drawing-section">
                <h4>Canvas</h4>
                <div class="canvas-info">
                    <p>Drawing canvas overlays the main Live2D area.</p>
                    <p><strong>Usage:</strong> Enable drawing mode above to draw over Live2D models.</p>
                    <p><strong>Toggle:</strong> Switch between drawing and Live2D interaction modes.</p>
                </div>
                <div class="canvas-controls">
                    <button class="btn btn-secondary" onclick="clearCanvas()">Clear Drawing</button>
                    <button class="btn btn-secondary" onclick="saveDrawing()">Save Drawing</button>
                    <button class="btn btn-secondary" onclick="exportPNG()">Export PNG</button>
                </div>
            </div>

            <!-- Export Section -->
            <div class="drawing-section">
                <h4>Export</h4>
                <div class="export-controls">
                    <button class="btn btn-primary" onclick="saveDrawing()">Save Drawing</button>
                    <button class="btn btn-secondary" onclick="exportPNG()">Export PNG</button>
                    <button class="btn btn-secondary" onclick="exportSVG()">Export SVG</button>
                </div>
            </div>
        </div>
    </div>

<!-- Load PIXI.js and Live2D libraries in correct order -->
<!-- Step 1: Load PIXI.js 6.5.10 from dist folder -->
<script src="/static/dist/pixi-6.5.10.min.js"></script>

<!-- Step 2: Load EventEmitter compatibility for PIXI v6 -->
<script src="/static/js/eventemitter_preloader_v6.js"></script>

<!-- Step 3: Load Live2D v2 Bundle for Cubism 2.x models -->
<script src="/static/dist/live2d_bundle.js"></script>

<!-- Step 4: Load Cubism 5 Core for modern models -->
<script src="/static/dist/CubismSdkForWeb-5-r.4/Core/live2dcubismcore.min.js"></script>

<!-- Step 6: Verify dual architecture setup -->
<script>
console.log('=== Dual Architecture Verification ===');
console.log('PIXI version:', typeof PIXI !== 'undefined' ? PIXI.VERSION : 'Not loaded');
console.log('EventEmitter available:', typeof EventEmitter !== 'undefined');
console.log('Live2D v2 Bundle loaded:', typeof window.Live2D !== 'undefined');
console.log('Cubism 5 Core loaded:', typeof window.Live2DCubismCore !== 'undefined');

// Debug Live2D v2 Bundle
if (typeof window.Live2D !== 'undefined') {
    console.log('✓ Live2D v2 Bundle ready for Cubism 2.x models');
    console.log('- window.Live2D:', typeof window.Live2D);
    console.log('- window.Live2DModelWebGL:', typeof window.Live2DModelWebGL);
    console.log('- window.live2dv2:', typeof window.live2dv2);
}

// Debug Cubism 5 Core
if (typeof window.Live2DCubismCore !== 'undefined') {
    console.log('✓ Cubism 5 Core ready for modern models');
    console.log('- Core version:', window.Live2DCubismCore.Version ? window.Live2DCubismCore.Version.csmGetVersion() : 'unknown');
}

console.log('=== End Verification ===');
</script>

<!-- Step 5: Load pixi-live2d-display (local for offline installation) -->
<script src="/static/dist/pixi-live2d-display-0.4.0.min.js"></script>

<!-- Step 5: Verify Live2D plugin initialization -->
<script>
// AI Companion API Configuration - Dynamic configuration loading
window.ai2d_chat_CONFIG = {
    // Default fallback configuration
    API_BASE_URL: (() => {
        const protocol = window.location.protocol;
        const hostname = window.location.hostname;
        const port = window.location.port;
        
        // Use current protocol and host
        if (port) {
            return `${protocol}//${hostname}:${port}`;
        }
        return `${protocol}//${hostname}`;
    })(),
    
    // Configuration loading status
    _configLoaded: false,
    _configPromise: null
};

// Function to load server configuration dynamically
async function loadServerConfig() {
    if (window.ai2d_chat_CONFIG._configLoaded) {
        return window.ai2d_chat_CONFIG;
    }
    
    if (window.ai2d_chat_CONFIG._configPromise) {
        return window.ai2d_chat_CONFIG._configPromise;
    }
    
    window.ai2d_chat_CONFIG._configPromise = (async () => {
        try {
            console.log('Loading server configuration from API...');
            
            // Try to fetch configuration from the server
            const configResponse = await fetch('/api/system/config');
            if (configResponse.ok) {
                const serverConfig = await configResponse.json();
                
                // Update the configuration
                window.ai2d_chat_CONFIG.API_BASE_URL = serverConfig.server.base_url;
                window.ai2d_chat_CONFIG.serverConfig = serverConfig;
                window.ai2d_chat_CONFIG._configLoaded = true;
                
                console.log('✅ Server configuration loaded successfully:', serverConfig.server.base_url);
                return window.ai2d_chat_CONFIG;
            } else {
                throw new Error(`Config API returned ${configResponse.status}`);
            }
        } catch (error) {
            console.warn('⚠️ Failed to load server config from API, using fallback:', error.message);
            
            // Fallback: use current location as base
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            const port = window.location.port;
            
            window.ai2d_chat_CONFIG.API_BASE_URL = port ? 
                `${protocol}//${hostname}:${port}` : 
                `${protocol}//${hostname}`;
            
            window.ai2d_chat_CONFIG._configLoaded = true;
            
            console.log('Using fallback configuration:', window.ai2d_chat_CONFIG.API_BASE_URL);
            return window.ai2d_chat_CONFIG;
        }
    })();
    
    return window.ai2d_chat_CONFIG._configPromise;
}

// Initialize configuration
console.log('AI Companion API Config (initial):', window.ai2d_chat_CONFIG.API_BASE_URL);
console.log('Protocol detected:', window.location.protocol);

// Helper function for making API calls with proper config loading
window.makeApiCall = async function(endpoint, options = {}) {
    // Ensure config is loaded
    await loadServerConfig();
    
    const url = `${window.ai2d_chat_CONFIG.API_BASE_URL}${endpoint}`;
    console.log(`Making API call to: ${url}`);
    
    return fetch(url, options);
};
</script>

<script>
// Initialize Live2D plugin following Live2D Viewer Web pattern
console.log('Initializing Live2D plugin (Live2D Viewer Web compatible)...');

// Wait for all scripts to load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        console.log('Checking library compatibility...');
        
        // Verify libraries are loaded
        if (typeof PIXI === 'undefined') {
            console.error('PIXI.js not loaded');
            return;
        }
        
        if (typeof EventEmitter === 'undefined') {
            console.error('EventEmitter not available');
            return;
        }
        
        console.log('✓ PIXI version:', PIXI.VERSION);
        console.log('✓ EventEmitter type:', typeof EventEmitter);
        
        // Check if PIXI.utils.EventEmitter exists (Live2D Viewer Web pattern)
        if (PIXI.utils && PIXI.utils.EventEmitter) {
            console.log('✓ PIXI.utils.EventEmitter available (Live2D Viewer Web compatible)');
        }
        
        // Check if Live2D plugin is available
        if (typeof PIXI.live2d === 'undefined') {
            console.error('✗ PIXI.live2d not loaded - pixi-live2d-display may not be compatible');
            console.log('Available PIXI properties:', Object.keys(PIXI));
            
            // Try to diagnose the issue
            if (window.pixiLive2DLoadError) {
                console.error('Library loading error detected - check network tab');
            }
        } else {
            console.log('✓ PIXI.live2d loaded successfully');
            console.log('Available PIXI.live2d properties:', Object.keys(PIXI.live2d));
            
            // Check for Live2DModel
            if (PIXI.live2d.Live2DModel) {
                console.log('✓ Live2DModel class available');
                window.Live2DModel = PIXI.live2d.Live2DModel;
                
                // Test if it has the expected methods
                if (typeof PIXI.live2d.Live2DModel.from === 'function') {
                    console.log('✓ Live2DModel.from() method available');
                } else {
                    console.warn('Live2DModel.from() method not found');
                }
            } else {
                console.warn('Live2DModel not found in PIXI.live2d');
            }
            
            // Check for Live2DFactory
            if (PIXI.live2d.Live2DFactory) {
                console.log('✓ Live2DFactory available');
                window.Live2DFactory = PIXI.live2d.Live2DFactory;
            } else {
                console.warn('Live2DFactory not found in PIXI.live2d');
            }
        }
        
        console.log('Live2D plugin initialization check complete');
        console.log('System ready for Live2D model loading');
        
        // NOW INITIALIZE THE LIVE2D SYSTEM
        if (typeof initializeLive2D === 'function') {
            console.log('Starting Live2D modular system initialization...');
            
            // Load server configuration before initializing Live2D
            loadServerConfig().then(() => {
                console.log('Server configuration loaded, initializing Live2D...');
                return initializeLive2D();
            }).then(() => {
                console.log('Live2D system initialization complete!');
            }).catch(error => {
                console.error('Live2D system initialization failed:', error);
            });
        } else {
            console.error('initializeLive2D function not found!');
        }
        
    }, 500); // Increased delay to ensure all libraries are loaded
});
</script>

<!-- Step 5: Load Live2D modular system -->
    
    <script src="/static/js/live2d_config.js"></script>
    <script src="/static/js/live2d_core.js"></script>  
    <script src="/static/js/live2d_core_simple.js"></script>
    <script src="/static/js/live2d_integration.js"></script>
    <script src="/static/js/live2d_interaction.js"></script>
    <script src="/static/js/live2d_logger.js"></script>
    <script src="/static/js/live2d_model_loader.js"></script>
    <script src="/static/js/live2d_model_manager.js"></script>
    <script src="/static/js/live2d_motion_manager.js"></script>
    <script src="/static/js/live2d_motions.js"></script>
    <script src="/static/js/live2d_mouse_interaction.js"></script>    
    <script src="/static/js/live2d_multi_model_manager.js"></script>    
    <script src="/static/js/live2d_simple_fix.js"></script>    
    <script src="/static/js/live2d_tester.js"></script>
    <script src="/static/js/live2d_ui_controller.js"></script>

    <!-- UI components -->
    <script src="/static/js/ui_drawing_system.js"></script>
    <script src="/static/js/ui_icon_manager.js"></script>     
    <script src="/static/js/ui_panel_management.js"></script>
    <script src="/static/js/ui_people_panel.js"></script>
    <script src="/static/js/ui_panel_manager.js"></script>
    <script src="/static/js/ui_character_profiles.js"></script>
    <script src="/static/js/ui_debug_console.js"></script>
    <script src="/static/js/ui_debug_logger.js"></script>

    <!-- Audio Processing -->
    <script src="/static/js/audio_voice_recording.js"></script>
    <script src="/static/js/audio_tts.js"></script> 

    <!-- Additional Functionality -->
    <script src="/static/js/autonomous_avatars.js"></script>
    <script src="/static/js/chat_manager.js"></script>
    <script src="/static/js/db_manager.js"></script>
    <script src="/static/js/user_profile.js"></script>
    <script src="/static/js/config_api_helpers.js"></script>

    <!-- Compatibility Functions -->
    <script src="/static/js/compatibility_functions.js"></script>

    <!-- Debug Tools -->
    <!-- <script src="/static/js/debug_model_visibility.js"></script> -->
    <!-- <script src="/static/js/debug_stage_inspection.js"></script> -->

    <!-- Main Initialization System -->
    <script src="/static/js/main_initialization.js"></script>

    <!-- SocketIO for real-time communication -->
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>

<script>
// Global variables for the modular system
let live2dIntegration = null;
let uiController = null;
let live2dMultiModelManager = null; // Make available globally for remove buttons
let currentModel = null; // Add current model reference
let pixiApp = null; // Add PIXI app reference

// Function to update current model reference when active model changes
function updateCurrentModelReference() {
    if (live2dMultiModelManager) {
        const activeModelData = live2dMultiModelManager.getActiveModel();
        console.log('🔍 Active model check:', {
            hasActiveModelData: !!activeModelData,
            activeModelDataKeys: activeModelData ? Object.keys(activeModelData) : null,
            hasModel: activeModelData ? !!activeModelData.model : false,
            modelType: activeModelData && activeModelData.model ? typeof activeModelData.model : null,
            modelName: activeModelData ? activeModelData.name : null
        });
        
        if (activeModelData && activeModelData.model) {
            currentModel = activeModelData.model;
            console.log('🔄 Updated currentModel reference to:', activeModelData.name);
            
            // Update PIXI app reference from integration
            if (live2dIntegration && live2dIntegration.app) {
                pixiApp = live2dIntegration.app;
                console.log('🔄 Updated pixiApp reference from integration');
            }
            
            // Set up mouse interaction for the new current model (only if not already set up)
            if (currentModel && pixiApp && !currentModel._interactionSetup) {
                setupLive2DMouseInteraction(currentModel);
                currentModel._interactionSetup = true; // Mark as set up to prevent duplicates
            }
            
            return true;
        } else {
            // Try alternative method - get all models and find the active one
            const allModels = live2dMultiModelManager.getAllModels();
            console.log('🔍 Trying alternative method - all models:', allModels.length);
            
            for (let modelData of allModels) {
                if (modelData.model && modelData.model.visible) {
                    currentModel = modelData.model;
                    console.log('🔄 Found visible model:', modelData.name);
                    
                    // Update PIXI app reference
                    if (live2dIntegration && live2dIntegration.app) {
                        pixiApp = live2dIntegration.app;
                    }
                    
                    // Set up mouse interaction (only if not already set up)
                    if (currentModel && pixiApp && !currentModel._interactionSetup) {
                        setupLive2DMouseInteraction(currentModel);
                        currentModel._interactionSetup = true;
                    }
                    
                    return true;
                }
            }
            
            currentModel = null;
            console.log('❌ No active model found');
            return false;
        }
    }
    currentModel = null;
    return false;
}

// Initialize the modular Live2D system
async function initializeLive2D() {
    try {
        console.log('Initializing Live2D modular system...');
        
        // Check if modular classes are available, if not use fallback
        if (typeof Live2DIntegration === 'undefined') {
            console.warn('Live2DIntegration class not found, using fallback initialization');
            await initializeFallbackLive2D();
            return;
        }
        
        // Create integration instance
        live2dIntegration = new Live2DIntegration();
        
        // Initialize integration (canvas container)
        const success = await live2dIntegration.initialize('pixiContainer');
        
        if (!success) {
            throw new Error('Failed to initialize Live2D integration');
        }
        
        // Create UI controller
        uiController = new Live2DUIController(live2dIntegration);
        
        // Initialize UI controller
        await uiController.initialize();
        
        // Store reference to multi-model manager for global access
        live2dMultiModelManager = live2dIntegration.modelManager;
        
        // Store PIXI app reference from integration.core.app (correct location)
        pixiApp = live2dIntegration.core.app;
        
        // CRITICAL: Make globals available to debug console and other scripts
        window.live2dIntegration = live2dIntegration;
        window.live2dMultiModelManager = live2dMultiModelManager;
        window.uiController = uiController;
        window.pixiApp = pixiApp;
        
        // Additional debug: verify PIXI app is correctly assigned
        console.log('🔍 PIXI app assignment check:', {
            'live2dIntegration.app': !!live2dIntegration.app,
            'live2dIntegration.core.app': !!live2dIntegration.core.app,
            'assigned pixiApp': !!pixiApp,
            'window.pixiApp': !!window.pixiApp
        });
        
        // CRITICAL: Also expose the interaction manager for debug functions
        if (live2dIntegration && live2dIntegration.core && live2dIntegration.core.interactionManager) {
            window.interactionManager = live2dIntegration.core.interactionManager;
            console.log('✅ Interaction manager exposed globally');
        }
        
        // Also expose the SDK for debug console
        window.LIVE2DCUBISMCORE = window.Live2DCubismCore;
        
        // CRITICAL: Apply interaction fix immediately after initialization
        console.log('🔧 Applying PIXI interaction fix...');
        fixPixiInteractionSystem();
        
        // Set up connection between multi-model manager and UI controller
        live2dMultiModelManager.setUIController(uiController);
        
        // Initialize the People panel with actual loaded models (clear any hardcoded data)
        populatePeopleModels();
        
        console.log('Live2D system initialized successfully!');
        
    } catch (error) {
        console.error('Failed to initialize Live2D system:', error);
        console.log('Attempting fallback initialization...');
        await initializeFallbackLive2D();
    }
}

// Fallback initialization with Direct Mouse Interaction Implementation
async function initializeFallbackLive2D() {
    try {
        console.log('Initializing fallback Live2D system with mouse interaction...');
        
        // Create basic PIXI application
        pixiApp = new PIXI.Application({
            width: window.innerWidth,
            height: window.innerHeight,
            backgroundColor: 0x000000, // Black background instead of blue
            transparent: true,
            antialias: true,
            resolution: window.devicePixelRatio || 1,
            autoDensity: true
        });
        
        // Add canvas to container
        const container = document.getElementById('pixiContainer');
        container.appendChild(pixiApp.view);
        
        // Set up stage interaction (CRITICAL for mouse events)
        pixiApp.stage.interactive = true;
        pixiApp.stage.hitArea = pixiApp.screen;
        
        // Make globals available
        window.pixiApp = pixiApp;
        window.currentModel = null;
        
        console.log('✅ Fallback Live2D system with mouse interaction initialized');
        
        // Set up model info display
        updateModelInfoDisplay('System ready - load a model to test mouse interaction');
        
        // Try to load a test model if available
        await tryLoadTestModel();
        
    } catch (error) {
        console.error('Failed to initialize fallback Live2D system:', error);
        updateModelInfoDisplay('❌ Failed to initialize Live2D system');
    }
}

// Try to load a test model for interaction testing
async function tryLoadTestModel() {
    try {
        // This would attempt to load a model from the server
        const response = await fetch('/api/live2d/models');
        if (response.ok) {
            const models = await response.json();
            if (models && models.length > 0) {
                console.log(`Found ${models.length} models available for testing`);
                updateModelInfoDisplay(`Found ${models.length} models - use People panel to load one`);
            }
        }
    } catch (error) {
        console.log('Could not fetch models for testing:', error.message);
        updateModelInfoDisplay('System ready - add models via People panel');
    }
}

// Live2D Viewer Web Mouse Interaction Implementation
function setupLive2DMouseInteraction(model) {
    if (!model || !pixiApp) {
        console.warn('Cannot setup mouse interaction: missing model or PIXI app');
        return;
    }
    
    console.log('🖱️ Setting up Live2D Viewer Web mouse interaction for model:', model.internalModel?.settings?.name || 'Unknown');
    
    // Enable interaction on the model (Live2D Viewer Web pattern)
    model.interactive = true;
    model.buttonMode = true;
    
    // Set up dragging variables
    let isDragging = false;
    let dragStart = { x: 0, y: 0 };
    let modelStart = { x: 0, y: 0 };
    
    // Mouse down - start dragging (Live2D Viewer Web pattern)
    model.removeAllListeners('pointerdown'); // Prevent duplicate listeners
    model.on('pointerdown', (event) => {
        isDragging = true;
        const position = event.data.global;
        dragStart.x = position.x;
        dragStart.y = position.y;
        modelStart.x = model.x;
        modelStart.y = model.y;
        
        // Prevent event bubbling
        event.stopPropagation();
        console.log('🖱️ Model drag started at:', position);
        
        // Update model info
        updateModelInfoDisplay(`Dragging model from (${Math.round(modelStart.x)}, ${Math.round(modelStart.y)})`);
    });
    
    // Mouse move - drag the model (use app stage for global movement)
    pixiApp.stage.removeAllListeners('pointermove'); // Prevent duplicate listeners
    pixiApp.stage.on('pointermove', (event) => {
        if (!isDragging) return;
        
        const position = event.data.global;
        const deltaX = position.x - dragStart.x;
        const deltaY = position.y - dragStart.y;
        
        model.x = modelStart.x + deltaX;
        model.y = modelStart.y + deltaY;
        
        // Update model info during drag
        updateModelInfoDisplay(`Position: (${Math.round(model.x)}, ${Math.round(model.y)}) Scale: ${model.scale.x.toFixed(2)}`);
    });
    
    // Mouse up - stop dragging
    pixiApp.stage.removeAllListeners('pointerup'); // Prevent duplicate listeners
    pixiApp.stage.on('pointerup', () => {
        if (isDragging) {
            isDragging = false;
            console.log('🖱️ Model drag ended at:', { x: model.x, y: model.y });
            updateModelInfoDisplay(`✅ Model positioned at (${Math.round(model.x)}, ${Math.round(model.y)})`);
        }
    });
    
    // Handle mouse leave canvas
    pixiApp.stage.removeAllListeners('pointerupoutside'); // Prevent duplicate listeners
    pixiApp.stage.on('pointerupoutside', () => {
        if (isDragging) {
            isDragging = false;
            console.log('🖱️ Model drag ended (outside canvas)');
            updateModelInfoDisplay(`✅ Model positioned at (${Math.round(model.x)}, ${Math.round(model.y)})`);
        }
    });
    
    // Set up mouse wheel scaling (Live2D Viewer Web pattern)
    setupModelScaling(model);
    
    // Set up hit area testing if available
    setupModelHitAreas(model);
    
    console.log('✅ Mouse interaction setup complete for model');
}

// Live2D Viewer Web scaling pattern implementation
function setupModelScaling(model) {
    if (!pixiApp?.view) {
        console.warn('Cannot setup model scaling: no canvas available');
        return;
    }
    
    const canvas = pixiApp.view;
    
    // Remove any existing wheel listeners to prevent duplicates
    const existingHandler = canvas._live2dWheelHandler;
    if (existingHandler) {
        canvas.removeEventListener('wheel', existingHandler);
    }
    
    // Create wheel handler
    function handleModelWheel(event) {
        event.preventDefault();
        
        if (!model || !model.scale) return;
        
        const scaleFactor = event.deltaY > 0 ? 0.9 : 1.1;
        const newScale = model.scale.x * scaleFactor;
        
        // Limit scale between 0.1 and 5.0 (Live2D Viewer Web limits)
        if (newScale >= 0.1 && newScale <= 5.0) {
            model.scale.set(newScale);
            console.log('🔍 Model scaled to:', newScale.toFixed(2));
            
            // Update UI slider if available
            const slider = document.getElementById('zoomSlider');
            const display = document.getElementById('zoomValue');
            if (slider) slider.value = newScale;
            if (display) display.textContent = newScale.toFixed(2);
            
            // Update model info
            updateModelInfoDisplay(`Position: (${Math.round(model.x)}, ${Math.round(model.y)}) Scale: ${newScale.toFixed(2)}`);
        }
    }
    
    // Store handler reference for cleanup
    canvas._live2dWheelHandler = handleModelWheel;
    
    // Add wheel event listener
    canvas.addEventListener('wheel', handleModelWheel, { passive: false });
    
    console.log('🔍 Mouse wheel scaling set up for model');
}

// Live2D Viewer Web hit area pattern implementation
function setupModelHitAreas(model) {
    if (!model?.internalModel) {
        console.log('Hit areas not available for this model');
        return;
    }
    
    model.removeAllListeners('pointerdown'); // Remove previous listeners
    model.on('pointerdown', (event) => {
        const point = event.data.global;
        
        // Convert global coordinates to model local coordinates
        const localPoint = model.toLocal(point);
        
        console.log('🎯 Hit test at:', localPoint);
        
        // Test hit areas if available (Live2D Viewer Web pattern)
        if (model.internalModel.hitTest) {
            try {
                const hitAreas = model.internalModel.hitTest(localPoint.x, localPoint.y);
                
                if (hitAreas && hitAreas.length > 0) {
                    console.log('🎯 Hit areas detected:', hitAreas);
                    updateModelInfoDisplay(`🎯 Hit: ${hitAreas.join(', ')}`);
                    
                    // Trigger motions based on hit areas
                    hitAreas.forEach(hitArea => {
                        console.log(`🎭 Hit area: ${hitArea}`);
                        // Add motion triggers here if needed
                    });
                } else {
                    console.log('🎯 No hit areas at this location');
                }
            } catch (error) {
                console.warn('Hit test failed:', error);
            }
        } else {
            console.log('🎯 Hit testing not available for this model');
        }
    });
}

// Enhanced model loading function with mouse interaction
async function loadLive2DModel(modelPath) {
    try {
        console.log('🎭 Loading Live2D model from:', modelPath);
        
        if (!pixiApp) {
            throw new Error('PIXI application not available');
        }
        
        updateModelInfoDisplay('Loading model...');
        
        // Clear existing model
        if (currentModel) {
            pixiApp.stage.removeChild(currentModel);
            currentModel.destroy();
            currentModel = null;
        }
        
        // Load new model using Live2D Viewer Web pattern
        currentModel = await Live2DModel.from(modelPath);
        
        if (!currentModel) {
            throw new Error('Failed to create Live2D model');
        }
        
        // Add to stage
        pixiApp.stage.addChild(currentModel);
        
        // Center the model
        currentModel.x = pixiApp.screen.width / 2;
        currentModel.y = pixiApp.screen.height / 2;
        
        // Set initial scale
        currentModel.scale.set(0.3);
        
        // CRITICAL: Enable mouse interactions using Live2D Viewer Web patterns
        setupLive2DMouseInteraction(currentModel);
        
        // Store globally
        window.currentModel = currentModel;
        
        console.log('✅ Model loaded successfully with mouse interaction:', currentModel);
        
        // Update model info display
        const modelName = currentModel.internalModel?.settings?.name || 'Unknown Model';
        updateModelInfoDisplay(`✅ ${modelName} loaded - drag to move, scroll to scale`);
        
        return currentModel;
        
    } catch (error) {
        console.error('❌ Error loading model:', error);
        updateModelInfoDisplay(`❌ Failed to load model: ${error.message}`);
        throw error;
    }
}
    // Single DOMContentLoaded event listener with backup pattern
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('🚀 Starting AI Companion with BACKUP initialization pattern...');
        
        // Add delay to ensure all scripts are loaded
        setTimeout(async function() {
            try {
                // Set up layout management
                if (typeof setupLayoutManagement === 'function') {
                    setupLayoutManagement();
                }
                
                // Load server configuration if available
                if (typeof loadServerConfig === 'function') {
                    await loadServerConfig();
                    console.log('✓ Server configuration loaded');
                }
                
                // CRITICAL: Initialize Live2D FIRST before other systems
                const live2dSuccess = await initializeLive2D();
                
                if (!live2dSuccess) {
                    console.error('❌ Live2D initialization failed - other systems may not work properly');
                } else {
                    console.log('✅ Live2D system ready for other components');
                }
                
                // Initialize other systems AFTER Live2D is ready
                if (typeof initializeAICompanion === 'function') {
                    const initialized = await initializeAICompanion();
                    
                    if (initialized) {
                        console.log('✅ AI Companion initialization complete!');
                        
                        // Report status
                        setTimeout(() => {
                            if (typeof reportInitializationStatus === 'function') {
                                reportInitializationStatus();
                            }
                        }, 2000);
                    }
                } else {
                    console.log('✅ Backup initialization pattern complete!');
                }
                
            } catch (error) {
                console.error('❌ Critical initialization error:', error);
                if (typeof reportInitializationStatus === 'function') {
                    reportInitializationStatus();
                }
            }
        }, 500); // Delay to ensure script loading
    });
    </script>

</body>
</html>
