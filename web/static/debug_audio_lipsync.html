<!DOCTYPE html>
<html>
<head>
    <title>Audio & Lipsync Debug</title>
</head>
<body>
    <h1>Debug Audio & Lipsync Issues</h1>
    
    <button onclick="testAudioPlayback()">Test Audio Playback</button>
    <button onclick="testLipsyncLookup()">Test Lipsync Avatar Lookup</button>
    <button onclick="testTTSCall()">Test Full TTS Call</button>
    
    <div id="results"></div>
    
    <script>
        function log(message) {
            document.getElementById('results').innerHTML += '<p>' + message + '</p>';
            console.log(message);
        }
        
        function testAudioPlayback() {
            log('üîä Testing audio playback...');
            
            const testAudioData = "data:audio/wav;base64,UklGRiS8AABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YQC8AAAAAAIAAQAAAAAAAAD//";
            
            try {
                const audio = new Audio();
                audio.src = testAudioData;
                
                audio.oncanplaythrough = () => {
                    log('‚úÖ Audio can play, attempting playback...');
                    audio.play().then(() => {
                        log('‚úÖ Audio playback started successfully');
                    }).catch(error => {
                        log('‚ùå Audio playback failed: ' + error.message);
                    });
                };
                
                audio.onerror = (error) => {
                    log('‚ùå Audio loading failed: ' + error);
                };
                
                audio.onended = () => {
                    log('‚úÖ Audio playback completed');
                };
                
                audio.load();
                
            } catch (error) {
                log('‚ùå Audio setup failed: ' + error.message);
            }
        }
        
        function testLipsyncLookup() {
            log('üëÑ Testing lipsync avatar lookup...');
            
            // Check if window objects exist
            log('window.live2dMultiModelManager: ' + (window.live2dMultiModelManager ? 'exists' : 'missing'));
            log('window.live2dManager: ' + (window.live2dManager ? 'exists' : 'missing'));
            log('window.loadedAvatars: ' + (window.loadedAvatars ? 'exists' : 'missing'));
            log('window.setAvatarMouthShape: ' + (window.setAvatarMouthShape ? 'exists' : 'missing'));
            log('window.findAvatarModel: ' + (window.findAvatarModel ? 'exists' : 'missing'));
            
            // Try to find models
            if (window.live2dMultiModelManager && window.live2dMultiModelManager.getAllModels) {
                const models = window.live2dMultiModelManager.getAllModels();
                log('Available models: ' + models.length);
                models.forEach((model, index) => {
                    log(`Model ${index}: name="${model.name}", id="${model.id}", fileName="${model.fileName}"`);
                    log(`  - pixiModel: ${model.pixiModel ? 'exists' : 'missing'}`);
                    if (model.pixiModel) {
                        log(`  - setMouthShape: ${typeof model.pixiModel.setMouthShape === 'function' ? 'available' : 'missing'}`);
                    }
                });
            }
            
            // Test finding 'iori' specifically
            if (window.findAvatarModel) {
                const ioriModel = window.findAvatarModel('iori');
                log('Found iori model: ' + (ioriModel ? 'yes' : 'no'));
                if (ioriModel) {
                    log('iori model has setMouthShape: ' + (typeof ioriModel.setMouthShape === 'function'));
                    log('iori model structure: ' + JSON.stringify(Object.keys(ioriModel)));
                }
            }
            
            // Check the models Map directly
            if (window.live2dMultiModelManager && window.live2dMultiModelManager.models) {
                log('=== Direct models Map inspection ===');
                for (const [id, modelData] of window.live2dMultiModelManager.models) {
                    log(`Map entry: id="${id}", name="${modelData.name}"`);
                    log(`  pixiModel available: ${modelData.pixiModel ? 'yes' : 'no'}`);
                    if (modelData.pixiModel && modelData.pixiModel.internalModel) {
                        log(`  internalModel available: yes`);
                        if (modelData.pixiModel.internalModel.coreModel) {
                            log(`  coreModel available: yes`);
                        }
                    }
                }
            }
        }
        
        async function testTTSCall() {
            log('üéµ Testing full TTS call...');
            
            try {
                const response = await fetch('https://chat.erebus-nyx.net/api/tts/avatar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: "Debug test",
                        emotion: "cheerful", 
                        avatar_id: "iori"
                    })
                });
                
                const data = await response.json();
                log('TTS response received');
                log('Audio data starts with: ' + data.audio_data.substring(0, 50));
                log('Lipsync frames: ' + (data.lipsync_data ? data.lipsync_data.length : 0));
                log('Duration: ' + data.duration);
                
            } catch (error) {
                log('‚ùå TTS call failed: ' + error.message);
            }
        }
    </script>
</body>
</html>
